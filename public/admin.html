<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tableau de bord – Réservations</title>
    <style>
      :root {
        --bg: #0b0d10;
        --panel: #ffffff;
        --text: #0f172a;
        --muted: #6b7280;
        --primary: #5d3fd3;
        --border: #e5e7eb;
        --row: #f8fafc;
        --badge-bg: #eef2ff;
        --badge-text: #4338ca;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, Noto Sans, Helvetica, Arial, 'Apple Color Emoji',
          'Segoe UI Emoji';
        color: var(--text);
      }
      .container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
        position: relative;
        z-index: 1;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 22px 22px 0 22px;
      }
      .title {
        margin: 0;
        font-size: 26px;
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .subtitle {
        margin: 8px 0 18px 0;
        color: var(--muted);
      }
      .filters {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .input,
      .select {
        height: 36px;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: #fff;
        color: var(--text);
      }
      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 22px 16px 22px;
        border-bottom: 1px solid var(--border);
      }
      .table-wrap {
        overflow: auto;
      }
      .card-footer {
        padding: 12px 22px 18px 22px;
        border-top: 1px solid var(--border);
        text-align: center;
        color: var(--muted);
        font-size: 13px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead th {
        text-align: left;
        font-weight: 700;
        color: var(--muted);
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        background: #fff;
      }
      tbody td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        background: #fff;
      }
      tbody tr:hover td {
        background: var(--row);
      }
      /* Ligne avec demande d'annulation en attente */
      tbody tr.cancel-pending td {
        background: rgba(239, 68, 68, 0.1) !important;
      }
      tbody tr.cancel-pending:hover td {
        background: rgba(239, 68, 68, 0.15) !important;
      }
      /* Ligne avec séjour terminé (plus d'un jour) */
      tbody tr.past-stay {
        opacity: 0.4;
      }
      tbody tr.past-stay:hover {
        opacity: 0.6;
      }
      .pay-dots {
        display: inline-flex;
        gap: 6px;
        margin-left: 8px;
        vertical-align: middle;
      }
      .pay-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #cbd5e1;
        box-shadow: inset 0 0 0 1px #94a3b8;
      }
      .pay-dot.on {
        background: #16a34a;
        box-shadow: inset 0 0 0 1px #15803d;
      }
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 12px;
      }
      .b-pending {
        background: #fff7ed;
        color: #9a3412;
      }
      .b-accepted {
        background: #ecfeff;
        color: #155e75;
      }
      .b-depositPay {
        background: #ecfdf5;
        color: #065f46;
      }
      .b-refused {
        background: #fef2f2;
        color: #991b1b;
      }
      .b-canceled {
        background: #f1f5f9;
        color: #0f172a;
      }
      .b-balancePay {
        background: #eef2ff;
        color: #3730a3;
      }
      .btn {
        height: 32px;
        padding: 0 12px;
        border: 1px solid var(--border);
        background: #fff;
        border-radius: 8px;
        cursor: pointer;
      }
      .btn-primary {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }
      .login-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      .login-card {
        background: #fff;
        padding: 18px;
        border-radius: 12px;
        width: 360px;
        border: 1px solid var(--border);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      .login-card h3 {
        margin: 0 0 10px 0;
      }
      .muted {
        color: var(--muted);
      }
      .detail-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10001;
      }
      /* Loader global */
      .loader-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 11000;
        background: rgba(15, 23, 42, 0.08);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 220ms ease;
      }
      .loader-overlay.on {
        opacity: 1;
        pointer-events: all;
      }
      .loader {
        width: 64px;
        height: 64px;
        border: 4px solid rgba(255, 255, 255, 0.6);
        border-top-color: #5d3fd3;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.05) inset;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .detail-card {
        width: 720px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        overflow: hidden;
      }
      .detail-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 18px;
        border-bottom: 1px solid var(--border);
      }
      .detail-body {
        padding: 12px 18px 18px 18px;
        max-height: 70vh;
        overflow: auto;
      }
      .detail-actions {
        padding: 0 18px 18px 18px;
        display: flex;
        gap: 10px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 16px;
      }
      .grid div {
        padding: 6px 8px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      .grid label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 4px;
      }
      .btn-danger {
        background: #ef4444;
        color: #fff;
        border-color: #ef4444;
      }
      .btn-danger:hover {
        background: #dc2626;
        border-color: #dc2626;
      }

      /* Background from Uiverse.io by chase2k25 (renamed classes to avoid conflicts) */
      .bg-container {
        position: fixed;
        inset: 0;
        z-index: 0;
        background: #181c21;
        display: flex;
        align-items: stretch;
        justify-content: stretch;
      }
      .pattern-bg {
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: repeating-linear-gradient(
          135deg,
          #232526 0px,
          #232526 60px,
          #23252699 70px,
          #414345 130px
        );
      }
      .cube-svg {
        position: absolute;
        width: 200%;
        height: 200%;
        left: -30%;
        top: -20%;
        background: transparent;
        opacity: 0.7;
        z-index: 1;
        animation: cubeMove 18s linear infinite alternate;
      }
      @keyframes cubeMove {
        from {
          transform: translateY(0) scale(1);
        }
        to {
          transform: translateY(-20%) scale(1.02) rotate(1deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="loader" class="loader-overlay"><div class="loader"></div></div>
    <div class="bg-container">
      <div class="pattern-bg">
        <svg
          preserveAspectRatio="xMidYMid slice"
          height="100%"
          width="100%"
          class="cube-svg"
          viewBox="0 0 120 104"
        >
          <defs>
            <linearGradient y2="100%" x2="100%" y1="0%" x1="0%" id="cube-dark">
              <stop stop-color="#232526" offset="0%"></stop>
              <stop stop-color="#414345" offset="100%"></stop>
            </linearGradient>
            <linearGradient y2="0%" x2="100%" y1="100%" x1="0%" id="cube-mid">
              <stop stop-color="#4b6cb7" offset="0%"></stop>
              <stop stop-color="#182848" offset="100%"></stop>
            </linearGradient>
            <linearGradient y2="100%" x2="0%" y1="0%" x1="100%" id="cube-light">
              <stop stop-color="#a8edea" offset="0%"></stop>
              <stop stop-color="#fed6e3" offset="100%"></stop>
            </linearGradient>
          </defs>
        </svg>
      </div>
    </div>
    <div class="container">
      <div class="card">
        <div class="header">
          <div>
            <h1 class="title">Tableau de bord – Réservations</h1>
            <div class="subtitle">
              Suivi complet des séjours, paiements et annulations
            </div>
          </div>
          <div class="filters">
            <input id="filterText" class="input" placeholder="Filtrer" />
            <select id="filterStatus" class="select">
              <option value="">Tous les statuts</option>
              <option value="pending">En attente</option>
              <option value="accepted">Acceptée</option>
              <option value="depositPay">Acompte OK</option>
              <option value="refused">Refusée</option>
              <option value="canceled">Annulée</option>
              <option value="balancePay">Solde OK</option>
            </select>
          </div>
        </div>
        <div class="toolbar">
          <div class="muted">Tri par arrivée croissante</div>
          <button id="refreshBtn" class="btn">Rafraîchir</button>
        </div>
        <div class="table-wrap">
          <table id="table">
            <thead>
              <tr>
                <th>Statut</th>
                <th>Client</th>
                <th>Arrivée</th>
                <th>Départ</th>
                <th>Nuits</th>
                <th>Adulte(s)</th>
                <th>Enfant(s)</th>
                <th>Prix</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="card-footer">Calypso Bay Reservations Dashboard</div>
        </div>
      </div>
    </div>

    <!-- Login modal -->
    <div id="login" class="login-modal">
      <div class="login-card">
        <h3>Connexion administrateur</h3>
        <div class="muted" style="margin-bottom: 10px">
          Entrez la clé d'accès pour consulter les réservations.
        </div>
        <div style="display: flex; gap: 8px">
          <input
            id="adminKey"
            class="input"
            type="password"
            placeholder="ADMIN_KEY"
            style="flex: 1"
          />
          <button id="loginBtn" class="btn btn-primary">Se connecter</button>
        </div>
      </div>
    </div>

    <!-- Page test emails -->
    <div
      class="card"
      style="max-width: 1200px; margin: 16px auto; padding: 16px"
    >
      <h3 style="margin: 0 0 12px 0">Tests emails</h3>
      <div style="display: flex; gap: 8px; flex-wrap: wrap">
        <button class="btn" data-mail="depositClient">
          Envoyer client – Acompte
        </button>
        <button class="btn" data-mail="depositManager">
          Envoyer gestionnaire – Acompte
        </button>
        <button class="btn" data-mail="balanceClient">
          Envoyer client – Solde
        </button>
        <button class="btn" data-mail="balanceManager">
          Envoyer gestionnaire – Solde
        </button>
        <input
          id="testToken"
          class="input"
          placeholder="Token de réservation"
          style="min-width: 260px"
        />
      </div>
    </div>

    <!-- Detail modal -->
    <div id="detailModal" class="detail-modal">
      <div class="detail-card">
        <div class="detail-head">
          <h3 style="margin: 0">Détails de la réservation</h3>
          <button id="detailClose" class="btn">Fermer</button>
        </div>
        <div class="detail-body">
          <div id="detailContent" class="grid"></div>
        </div>
        <div class="detail-actions">
          <button id="refundDepositBtn" class="btn btn-danger" disabled>
            Rembourser l'acompte
          </button>
          <button id="refundBalanceBtn" class="btn" disabled>
            Rembourser le solde
          </button>
        </div>
      </div>
    </div>

    <script>
      const API_LIST = '/api/admin?action=list'
      const API_DETAIL = '/api/admin?action=detail'
      let ADMIN_KEY = ''
      let currentRows = []

      function frStatus(s) {
        return s === 'pending'
          ? 'En attente'
          : s === 'accepted'
          ? 'Acceptée'
          : s === 'depositPay'
          ? 'Acompte OK'
          : s === 'refused'
          ? 'Refusée'
          : s === 'canceled'
          ? 'Annulée'
          : s === 'balancePay'
          ? 'Solde OK'
          : s || ''
      }
      function badgeClass(s) {
        return s === 'pending'
          ? 'b-pending'
          : s === 'accepted'
          ? 'b-accepted'
          : s === 'depositPay'
          ? 'b-depositPay'
          : s === 'refused'
          ? 'b-refused'
          : s === 'canceled'
          ? 'b-canceled'
          : s === 'balancePay'
          ? 'b-balancePay'
          : ''
      }
      function fmtDate(d) {
        const t = new Date(d)
        return isNaN(t) ? d || '' : t.toLocaleDateString('fr-FR')
      }
      function fmtMoney(n) {
        return (
          Number(n || 0).toLocaleString('fr-FR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }) + ' €'
        )
      }

      async function fetchRows(q = '') {
        showLoader(true)
        const r = await fetch(
          API_LIST + (q ? `&q=${encodeURIComponent(q)}` : ''),
          {
            headers: { 'x-admin-key': ADMIN_KEY }
          }
        )
        const j = await r.json()
        showLoader(false)
        if (j.status !== 'success') throw new Error(j.message || 'Erreur')
        return j.data || []
      }

      function renderRows(rows) {
        const tbody = document.querySelector('#table tbody')
        const status = document.getElementById('filterStatus').value
        const text = document
          .getElementById('filterText')
          .value.trim()
          .toLowerCase()
        let data = rows
        if (status) data = data.filter((r) => r.status === status)
        if (text) {
          data = data.filter((r) =>
            `${r.name || ''} ${r.email || ''} ${r.token || ''}`
              .toLowerCase()
              .includes(text)
          )
        }
        data = data.sort(
          (a, b) => new Date(a.startDate) - new Date(b.startDate)
        )
        tbody.innerHTML = data
          .map((r) => {
            const depositPaid =
              Number(r.depositAmount || 0) > 0 ||
              r.status === 'depositPay' ||
              r.status === 'balancePay'
            const balancePaid =
              r.status === 'balancePay' ||
              (r.balancePaidAt && String(r.balancePaidAt).length > 0)

            // Vérifier si demande d'annulation en attente
            const hasCancelPending = r.cancelStatus === 'pending'

            // Vérifier si séjour terminé (plus d'un jour)
            const now = new Date()
            const endDate = new Date(r.endDate)
            const oneDayMs = 24 * 60 * 60 * 1000
            const isPastStay = endDate && now - endDate > oneDayMs

            // Classes CSS conditionnelles
            const rowClasses = []
            if (hasCancelPending) rowClasses.push('cancel-pending')
            if (isPastStay) rowClasses.push('past-stay')
            const classAttr =
              rowClasses.length > 0 ? ` class="${rowClasses.join(' ')}"` : ''

            return `
          <tr${classAttr}>
            <td><span class="badge ${badgeClass(r.status)}">${frStatus(
              r.status
            )}</span></td>
            <td>${r.name || ''}</td>
            <td>${fmtDate(r.startDate)}</td>
            <td>${fmtDate(r.endDate)}</td>
            <td>${r.nbNights || 0}</td>
            <td>${r.nbAdults || 0}</td>
            <td>${r.nbChilds || 0}</td>
            <td>${fmtMoney(
              r.priceTotal
            )}<span class="pay-dots"><span class="pay-dot ${
              depositPaid ? 'on' : ''
            }" title="Acompte"></span><span class="pay-dot ${
              balancePaid ? 'on' : ''
            }" title="Solde"></span></span></td>
            <td><button class="btn btn-primary" data-token="${
              r.token
            }" data-action="detail">Détails</button></td>
          </tr>
        `
          })
          .join('')
      }

      async function openDetail(token) {
        showLoader(true)
        const r = await fetch(
          API_DETAIL + `&token=${encodeURIComponent(token)}`,
          { headers: { 'x-admin-key': ADMIN_KEY } }
        )
        const j = await r.json()
        showLoader(false)
        if (j.status !== 'success') {
          alert(j.message || 'Erreur')
          return
        }
        const d = j.data || {}
        const labelMap = {
          timestamp: 'Créé le',
          id: 'Token',
          status: 'Statut',
          name: 'Nom',
          email: 'Email',
          tel: 'Téléphone',
          userMessage: 'Message',
          nbAdults: 'Adultes',
          nbChilds: 'Enfants',
          nbNights: 'Nuits',
          priceNights: 'Total nuits (€)',
          priceClean: 'Ménage (€)',
          priceTax: 'Taxes (€)',
          priceTotal: 'Total (€)',
          startDate: 'Arrivée',
          endDate: 'Départ',
          depositAt: 'Acompte à',
          depositAmount: 'Montant acompte (€)',
          depositPaymentIntentId: 'PI Acompte',
          depositRefundedAmount: 'Acompte remboursé (€)',
          depositRefundIds: 'Refund IDs',
          address: 'Adresse',
          postal: 'Code postal',
          country: 'Pays',
          city: 'Ville',
          finalMessage: 'Message final',
          childAge1: 'Âge enfant 1',
          childAge2: 'Âge enfant 2',
          childAge3: 'Âge enfant 3',
          childAge4: 'Âge enfant 4',
          childAge5: 'Âge enfant 5',
          balanceDueAt: 'Échéance solde',
          balanceAmount: 'Montant solde (€)',
          balancePaymentIntentId: 'PI Solde',
          balancePaidAt: 'Solde payé à',
          balanceRefundedAmount: 'Solde remboursé (€)',
          balanceRefundIds: 'Refund IDs',
          cancelRequestedAt: 'Annulation demandée à',
          cancelReason: 'Motif annulation',
          cancelStatus: 'Statut annulation',
          cancelledAt: 'Annulation validée à',
          managerNotes: 'Notes gestionnaire'
        }
        const dateKeys = [
          'timestamp',
          'startDate',
          'endDate',
          'depositAt',
          'balanceDueAt',
          'balancePaidAt',
          'cancelRequestedAt',
          'cancelledAt'
        ]
        const ensureHours = (k, v) => {
          if (!v) return v
          const dt = new Date(v)
          if (isNaN(dt)) return v
          if (k === 'startDate') dt.setHours(15, 0, 0, 0)
          if (k === 'endDate') dt.setHours(10, 0, 0, 0)
          return dt
        }
        if (d.startDate) d.startDate = ensureHours('startDate', d.startDate)
        if (d.endDate) d.endDate = ensureHours('endDate', d.endDate)
        const fmtDateTime = (v) => {
          const dt = new Date(v)
          if (isNaN(dt)) return v
          const pad = (n) => String(n).padStart(2, '0')
          return `${pad(dt.getDate())}/${pad(
            dt.getMonth() + 1
          )}/${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`
        }
        const container = document.getElementById('detailContent')
        const entries = Object.entries(d).filter(
          ([k, v]) => v !== '' && v != null
        )
        container.innerHTML = entries
          .map(([k, v]) => {
            let val = Array.isArray(v) ? v.join(', ') : v
            if (dateKeys.includes(k)) val = fmtDateTime(v)
            const label = labelMap[k] || k
            return `<div><label>${label}</label><div>${val}</div></div>`
          })
          .join('')
        // Rendre visible et actions
        document.getElementById('detailModal').style.display = 'flex'
        // Date limite remboursement acompte (J - 3 mois)
        const btn = document.getElementById('refundDepositBtn')
        if (d.startDate) {
          const lim = new Date(d.startDate)
          lim.setMonth(lim.getMonth() - 3)
          const pad = (n) => String(n).padStart(2, '0')
          const limStr = `${pad(lim.getDate())}/${pad(
            lim.getMonth() + 1
          )}/${lim.getFullYear()}`
          btn.textContent = `Rembourser l'acompte (date limite: ${limStr})`
        }
      }

      // Events
      document.getElementById('detailClose').addEventListener('click', () => {
        document.getElementById('detailModal').style.display = 'none'
      })
      document.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button[data-action="detail"]')
        if (btn) openDetail(btn.getAttribute('data-token'))
      })
      document
        .getElementById('refreshBtn')
        .addEventListener('click', async () => {
          currentRows = await fetchRows()
          renderRows(currentRows)
        })
      document
        .getElementById('filterText')
        .addEventListener('input', () => renderRows(currentRows))
      document
        .getElementById('filterStatus')
        .addEventListener('change', () => renderRows(currentRows))

      // Login
      async function doLogin() {
        ADMIN_KEY = document.getElementById('adminKey').value.trim()
        if (!ADMIN_KEY) return
        localStorage.setItem('ADMIN_KEY', ADMIN_KEY)
        document.getElementById('login').style.display = 'none'
        currentRows = await fetchRows()
        renderRows(currentRows)
      }
      document.getElementById('loginBtn').addEventListener('click', doLogin)
      document.getElementById('adminKey').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') doLogin()
      })
      // Autologin via localStorage ou query ?key=
      ;(function () {
        showLoader(true)
        const p = new URLSearchParams(location.search)
        const key = p.get('key') || localStorage.getItem('ADMIN_KEY') || ''
        if (key) {
          document.getElementById('adminKey').value = key
          doLogin().finally(() => showLoader(false))
        } else {
          showLoader(false)
        }
      })()

      // Tests d'emails
      document.addEventListener('click', async (e) => {
        const b = e.target.closest('button[data-mail]')
        if (!b) return
        const kind = b.getAttribute('data-mail')
        const token = document.getElementById('testToken').value.trim()
        if (!token) {
          alert('Renseignez un token')
          return
        }
        const to = kind.includes('Manager')
          ? 'contact.calypso.bay@gmail.com'
          : 'kevinblart@live.fr'
        try {
          showLoader(true)
          const url = `${
            window.appConfig?.NEXT_PUBLIC_GAS_URL ||
            new URL(window.location.origin).origin
          }?action=testSendEmail&kind=${encodeURIComponent(
            kind
          )}&to=${encodeURIComponent(to)}&token=${encodeURIComponent(token)}`
          const r = await fetch(url)
          const j = await r.json()
          showLoader(false)
          if (j.status !== 'success')
            throw new Error(j.message || 'Erreur envoi')
          alert('Email test envoyé (' + kind + ')')
        } catch (err) {
          showLoader(false)
          alert(err.message)
        }
      })

      function showLoader(on) {
        const el = document.getElementById('loader')
        if (on) {
          el.classList.add('on')
          document.documentElement.style.overflow = 'hidden'
        } else {
          el.classList.remove('on')
          document.documentElement.style.overflow = ''
        }
      }
    </script>
  </body>
  <footer
    style="
      text-align: center;
      color: #9aa0a6;
      padding: 12px 0 24px;
      font: 13px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell,
        Noto Sans, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
    "
  >
    Calypso Bay Reservations Dashboard
  </footer>
</html>
