<!DOCTYPE html>
<html>
  <head>
    <title>Finaliser ma r√©servation - Calypso Bay</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <!-- Favicons -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="images/logos/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="images/logos/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="images/logos/favicons/favicon-16x16.png"
    />
    <link rel="manifest" href="manifest.json" />
    <link rel="shortcut icon" href="images/logos/favicons/favicon.ico" />

    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/custom.css" />
    <noscript
      ><link rel="stylesheet" href="assets/css/noscript.css"
    /></noscript>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      /* Styles sp√©cifiques pour la page de finalisation */
      .form-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
      }
      .form-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        pointer-events: none;
      }
      .form-section > * {
        position: relative;
        z-index: 1;
      }
      .form-group {
        margin-bottom: 25px;
      }
      .form-group label {
        display: none;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid rgba(229, 231, 235, 0.5);
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        color: #374151;
      }
      .form-group input::placeholder,
      .form-group textarea::placeholder {
        color: #6b7280 !important;
        letter-spacing: 0.5px;
        opacity: 1;
      }
      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #5d3fd3;
        box-shadow: 0 0 0 4px rgba(93, 63, 211, 0.15);
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-2px);
      }
      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 25px;
      }
      .form-row .form-group {
        flex: 1;
        min-width: 250px;
      }
      .reservation-details {
        padding: 1px;
      }
      .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        font-size: 0.9rem;
        color: white;
      }
      .detail-item:last-child {
        border-bottom: none;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid rgba(255, 255, 255, 0.4);
      }
      .payment-section {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        position: relative;
      }
      /* Overlay de verrouillage paiement */
      .payment-lock {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(3px);
        background: rgba(17, 24, 39, 0.35);
        z-index: 5;
      }
      .payment-lock .lock-box {
        background: rgba(255, 255, 255, 0.95);
        color: #111827;
        padding: 14px 18px;
        border-radius: 12px;
        font-weight: 700;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      }

      /* Message taxe de s√©jour */
      .tourist-tax-notice {
        margin: 20px 0;
        padding: 15px 20px;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        backdrop-filter: blur(10px);
      }
      .tax-notice-content {
        display: flex;
        align-items: center;
        gap: 12px;
        color: #3b82f6;
        font-size: 0.95rem;
        font-weight: 500;
      }
      .tax-notice-content i {
        font-size: 1.1rem;
        color: #3b82f6;
      }
      .payment-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        pointer-events: none;
      }
      .payment-amount {
        text-align: center;
        margin-bottom: 30px;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 25px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 16px;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(16, 185, 129, 0.2);
      }
      .payment-amount.highlight {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }
      #card-element {
        padding: 15px;
        border: 2px solid rgba(229, 231, 235, 0.5);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }
      #card-element:focus-within {
        border-color: #5d3fd3;
        box-shadow: 0 0 0 4px rgba(93, 63, 211, 0.15);
        background: rgba(255, 255, 255, 0.95);
      }
      #card-errors {
        color: #ef4444;
        margin-top: 12px;
        font-size: 14px;
        font-weight: 500;
      }
      .btn-submit {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        padding: 16px 30px;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 55px;
      }
      .btn-submit:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      }
      .btn-submit:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #10b981;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error-message {
        background: rgba(254, 242, 242, 0.95);
        color: #ef4444;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #fecaca;
        backdrop-filter: blur(10px);
      }
      .success-message {
        background: rgba(240, 253, 244, 0.95);
        color: #10b981;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #bbf7d0;
        backdrop-filter: blur(10px);
      }
      .validation-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15) !important;
      }
      .validation-message {
        color: #ef4444;
        font-size: 12px;
        margin-top: 5px;
        font-weight: 500;
      }

      /* Styles pour l'encart de paiement */
      .payment-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 15px 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        margin: 0 auto;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .payment-card h3 {
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 12px;
        text-align: center;
      }

      .payment-breakdown {
        margin-bottom: 12px;
      }

      .payment-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        color: white;
        font-size: 1rem;
        line-height: 1.3;
      }

      .payment-row.deposit-row {
        color: #3b82f6;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .payment-row.remaining-row {
        font-weight: 500;
        border-top: 1px solid rgba(255, 255, 255, 0.3);
        margin-top: 8px;
        padding-top: 12px;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        margin: 8px 0;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #3b82f6;
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .payment-form {
        border-top: 1px solid rgba(255, 255, 255, 0.3);
        padding-top: 12px;
      }

      .payment-form .form-group {
        margin-bottom: 15px;
      }

      .payment-form label {
        display: block;
        color: white;
        font-weight: 500;
        margin-bottom: 6px;
        font-size: 0.9rem;
      }

      .payment-disclaimer {
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.8rem;
        margin-top: 8px;
        line-height: 1.4;
      }

      /* Styles pour le s√©lecteur de langue */
      .language-selector {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
      }
      .language-selector select {
        border: none;
        background: transparent;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
      }
      .language-selector select:focus {
        outline: none;
        background: rgba(59, 130, 246, 0.1);
      }

      /* Responsive design pour mobile */
      @media (min-width: 981px) {
        #children-ages .inner {
          max-width: 100%;
        }
        #children-ages .form-section {
          width: 100%;
          max-width: 1000px;
          margin: 0 auto;
        }
      }
      @media (max-width: 768px) {
        /* Conteneurs principaux */
        .content,
        .inner {
          padding: 0 10px;
          max-width: 100vw;
          width: 100%;
        }

        .form-section {
          padding: 15px;
          margin: 10px 0;
          max-width: 100%;
          width: 100%;
        }

        .form-row {
          flex-direction: column;
          gap: 15px;
        }
        .form-row .form-group {
          flex: none;
          min-width: 100%;
          width: 100%;
        }
        .form-group input,
        .form-group textarea {
          font-size: 16px; /* √âvite le zoom sur iOS */
          padding: 12px;
          max-width: 100%;
          width: 100%;
        }
        .payment-amount {
          padding: 20px 15px;
          max-width: 100%;
          width: 100%;
        }
        .payment-amount > div {
          font-size: 1.8rem;
          max-width: 100%;
          word-break: break-word;
        }
        .btn-submit {
          padding: 15px 20px;
          font-size: 16px;
          min-height: 50px;
          max-width: 100%;
          width: 100%;
        }
        .detail-item {
          font-size: 0.85rem;
          padding: 10px 0;
          max-width: 100%;
          width: 100%;
        }
        .reservation-details {
          padding: 15px;
          max-width: 100%;
          width: 100%;
        }

        /* Forcer les largeurs maximales */
        .span-4-5,
        .span-9-5,
        .span-3-75,
        .span-1-75 {
          max-width: 100%;
          width: 100%;
        }

        /* Responsive pour l'encart de paiement */
        .payment-card {
          padding: 12px 15px;
          margin: 0 10px;
          max-width: 100%;
          width: calc(100% - 20px);
        }

        .payment-card h3 {
          font-size: 1.3rem;
          margin-bottom: 10px;
        }

        .payment-row {
          font-size: 0.9rem;
          padding: 4px 0;
        }

        .payment-row.deposit-row {
          font-size: 1rem;
        }

        .progress-bar {
          margin: 8px 0;
        }

        .payment-form {
          padding-top: 10px;
        }

        .payment-form .form-group {
          margin-bottom: 10px;
        }

        .payment-form label {
          font-size: 0.85rem;
          margin-bottom: 5px;
        }

        .payment-disclaimer {
          font-size: 0.75rem;
          margin-top: 8px;
        }
      }

      @media (max-width: 480px) {
        /* Conteneurs principaux */
        .content,
        .inner {
          padding: 0 5px;
          max-width: 100vw;
          width: 100%;
        }

        .form-section {
          padding: 10px;
          max-width: 100%;
          width: 100%;
        }

        .form-row {
          gap: 10px;
        }
        .payment-amount > div {
          font-size: 1.5rem;
          max-width: 100%;
          word-break: break-word;
        }
        .btn-submit {
          font-size: 14px;
          padding: 12px 15px;
          max-width: 100%;
          width: 100%;
        }
        .detail-item {
          font-size: 0.8rem;
          max-width: 100%;
          width: 100%;
        }

        /* Forcer tous les √©l√©ments √† respecter la largeur */
        * {
          max-width: 100vw;
        }

        .panel,
        .content,
        .inner,
        .form-section,
        .form-row,
        .form-group,
        .payment-amount,
        .btn-submit,
        .detail-item {
          max-width: 100%;
          width: 100%;
          overflow-x: hidden;
        }

        /* Responsive pour l'encart de paiement sur tr√®s petits √©crans */
        .payment-card {
          padding: 10px;
          margin: 0 5px;
          width: calc(100% - 10px);
        }

        .payment-card h3 {
          font-size: 1.2rem;
          margin-bottom: 10px;
        }

        .payment-row {
          font-size: 0.85rem;
          padding: 4px 0;
        }

        .payment-row.deposit-row {
          font-size: 0.95rem;
        }

        .progress-bar {
          margin: 6px 0;
          height: 6px;
        }

        .payment-form {
          padding-top: 8px;
        }

        .payment-form .form-group {
          margin-bottom: 8px;
        }

        .payment-form label {
          font-size: 0.8rem;
          margin-bottom: 4px;
        }

        .payment-disclaimer {
          font-size: 0.7rem;
          margin-top: 6px;
        }
      }
    </style>
  </head>
  <body class="is-preload">
    <!-- S√©lecteur de langue -->
    <div class="language-selector">
      <select id="language-selector">
        <option value="fr">üá´üá∑ Fran√ßais</option>
        <option value="en">üá¨üáß English</option>
        <option value="de">üá©üá™ Deutsch</option>
      </select>
    </div>

    <!-- Page Wrapper -->
    <div id="page-wrapper">
      <!-- Wrapper -->
      <div id="wrapper">
        <!-- H E A D E R //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel banner right">
          <div class="content color0 span-3-75">
            <h2 class="major">
              <span id="banner-title">Finaliser ma</span><br />
              <span class="themysion" id="banner-subtitle">Reservation</span>
            </h2>
            <p id="banner-description">
              Votre demande de r√©servation a √©t√© accept√©e ! Compl√©tez le
              formulaire suivant et effectuez le paiement de l'acompte de 10%
              pour confirmer votre r√©servation √† Calypso Bay.
            </p>
            <ul class="actions">
              <li>
                <a
                  href="#form"
                  class="button primary color1 circle icon solid fa-angle-right"
                  id="banner-button"
                  >Commencer</a
                >
              </li>
            </ul>
          </div>
          <div class="image filtered span-1-75" data-position="25% 25%">
            <img
              src="images/gallery/fulls/Jardin/13.webp"
              alt="Vue du jardin de Calypso Bay"
            />
          </div>
        </section>

        <!-- F O R M U L A I R E //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel spotlight medium right" id="form">
          <div class="content span-9-5">
            <h3 class="major" id="form-title">üìã Informations personnelles</h3>
            <p id="form-description">
              Ces donn√©es nous permettront de vous contacter et de pr√©parer
              votre accueil.
            </p>

            <div id="error-container"></div>
            <div id="success-container"></div>

            <form id="finalization-form">
              <div class="form-section">
                <div class="form-row">
                  <div class="form-group">
                    <label for="name" id="name-label">Nom complet</label>
                    <input
                      type="text"
                      id="name"
                      name="name"
                      placeholder="Nom complet"
                      required
                    />
                    <div class="validation-message" id="name-error"></div>
                  </div>
                  <div class="form-group">
                    <label for="email" id="email-label">Email</label>
                    <input
                      type="email"
                      id="email"
                      name="email"
                      placeholder="Email"
                      required
                    />
                    <div class="validation-message" id="email-error"></div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="tel" id="tel-label">T√©l√©phone</label>
                    <input
                      type="tel"
                      id="tel"
                      name="tel"
                      placeholder="T√©l√©phone"
                      required
                    />
                    <div class="validation-message" id="tel-error"></div>
                  </div>
                  <div class="form-group">
                    <label for="address" id="address-label">Adresse</label>
                    <input
                      type="text"
                      id="address"
                      name="address"
                      placeholder="Adresse"
                      required
                    />
                    <div class="validation-message" id="address-error"></div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="city" id="city-label">Ville</label>
                    <input
                      type="text"
                      id="city"
                      name="city"
                      placeholder="Ville"
                      required
                    />
                    <div class="validation-message" id="city-error"></div>
                  </div>
                  <div class="form-group">
                    <label for="postal" id="postal-label">Code postal</label>
                    <input
                      type="text"
                      id="postal"
                      name="postal"
                      placeholder="Code postal"
                      required
                    />
                    <div class="validation-message" id="postal-error"></div>
                  </div>
                </div>
                <div class="form-group">
                  <label for="country" id="country-label">Pays</label>
                  <input
                    type="text"
                    id="country"
                    name="country"
                    placeholder="Pays"
                    required
                  />
                  <div class="validation-message" id="country-error"></div>
                </div>
              </div>
            </form>
          </div>
          <div class="image" data-position="center">
            <img
              src="images/gallery/fulls/Exterieur/04.webp"
              alt="Vue ext√©rieure de Calypso Bay"
            />
          </div>
        </section>

        <!-- √Ç G E S   E T   M E S S A G E //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel large color2-alt" id="children-ages">
          <div class="intro color2 span-3-5">
            <h2 class="major" id="precisions-title">üìù Pr√©cisions</h2>
            <p id="precisions-description">
              Vous pouvez nous laisser un message ou nous poser des questions si
              vous le souhaitez.
            </p>
          </div>
          <div class="inner span-9-5">
            <div class="form-section">
              <div id="children-ages-container">
                <!-- Les champs d'√¢ges seront g√©n√©r√©s dynamiquement ici -->
              </div>
              <div class="form-group">
                <label for="message" id="message-label"
                  >Message (optionnel)</label
                >
                <textarea
                  id="message"
                  name="message"
                  placeholder="Votre message, demandes sp√©ciales, informations compl√©mentaires..."
                  rows="4"
                ></textarea>
                <div class="validation-message" id="message-error"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- D √â T A I L S //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel spotlight medium right color1">
          <div class="intro joined span-3-5">
            <h2 class="major" id="details-title">
              üìÖ D√©tails de la r√©servation
            </h2>
            <p id="details-description">
              Voici un r√©capitulatif de votre demande de r√©servation. V√©rifiez
              que toutes les informations sont correctes avant de proc√©der au
              paiement.
            </p>
          </div>
          <div class="inner">
            <div class="form-section">
              <div class="reservation-details" id="reservation-details">
                <div class="loading">
                  <div class="spinner"></div>
                  <p id="details-loading">Chargement des d√©tails...</p>
                </div>
              </div>
            </div>
          </div>
          <div class="image filtered tinted" data-position="center">
            <img
              src="images/gallery/fulls/Piscine/04.webp"
              alt="Piscine - Calypso Bay"
            />
          </div>
        </section>

        <!-- P A I E M E N T //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel color4-alt">
          <div class="intro color4">
            <h2 class="major" id="payment-title">üí≥ Paiement de l'acompte</h2>
            <p id="payment-description">
              Pour confirmer votre r√©servation, veuillez effectuer le paiement
              de l'acompte de <span id="deposit-percent">10%</span> du montant
              total (un montant minimum peut √™tre appliqu√© pour les tests). Le
              solde sera √† r√©gler au plus tard 7 jours avant votre arriv√©e.
            </p>
          </div>
          <div class="inner">
            <div class="payment-card">
              <div class="payment-lock" id="payment-lock">
                <div class="lock-box" id="payment-lock-text"></div>
              </div>
              <h3 id="payment-summary-title">R√©capitulatif du paiement</h3>
              <div class="payment-breakdown">
                <div class="payment-row">
                  <span id="payment-total-label">Total</span>
                  <span id="total-amount">Calcul en cours...</span>
                </div>
                <div class="payment-row deposit-row">
                  <span
                    ><span id="payment-deposit-label">Acompte</span> (<span
                      id="deposit-percent-inline"
                      >10%</span
                    >)</span
                  >
                  <span id="deposit-amount">Calcul en cours...</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="payment-row remaining-row">
                  <span id="payment-remaining-label"
                    >Solde restant apr√®s acompte</span
                  >
                  <span id="remaining-amount">Calcul en cours...</span>
                </div>
              </div>

              <!-- Message taxe de s√©jour -->
              <div
                id="tourist-tax-notice"
                class="tourist-tax-notice"
                style="display: none"
              >
                <div class="tax-notice-content">
                  <i class="fas fa-info-circle"></i>
                  <span id="tourist-tax-text"></span>
                </div>
              </div>

              <div class="payment-form">
                <div class="form-group">
                  <label for="card-element" id="card-label"
                    >Carte de paiement</label
                  >
                  <div id="card-element"></div>
                  <div id="card-errors" role="alert"></div>
                </div>
                <button
                  type="submit"
                  class="btn-submit"
                  id="submit-button"
                  form="finalization-form"
                >
                  <span id="submit-button-text"
                    >Payer l'acompte et confirmer ma r√©servation</span
                  >
                </button>
                <p class="payment-disclaimer" id="payment-disclaimer">
                  Paiement s√©curis√© via Stripe. Aucune donn√©e bancaire n'est
                  stock√©e par Calypso Bay.
                </p>
              </div>
            </div>
          </div>
        </section>

        <!-- C O P Y R I G H T //////////////////////////////////////////////////////////////////////////////// -->
        <div class="copyright">
          <span>&copy; Calypso Bay | By</span>
          <a
            href="https://moriarty-design.fr"
            target="_blank"
            rel="noopener"
            style="
              font-family: 'Engagement', 'Brush Script MT', cursive;
              font-size: 2.2em;
              line-height: 1;
              margin-left: 0.25em;
              text-decoration: none;
              color: inherit;
            "
            >Moriarty</a
          >.
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/translations.js"></script>

    <script>
      // SYST√àME DE TRADUCTION

      let currentLang = 'fr'

      // Initialiser les traductions
      window.addEventListener('translations:ready', function (event) {
        const detectedLang = event.detail.language
        translatePage(detectedLang)
      })

      // G√©rer le changement de langue
      document.addEventListener('DOMContentLoaded', function () {
        const languageSelector = document.querySelector('#language-selector')
        if (languageSelector) {
          languageSelector.addEventListener('change', function () {
            const newLang = this.value

            localStorage.setItem('calypso-bay-lang', newLang)

            const url = new URL(window.location)
            url.searchParams.set('lang', newLang)
            window.location.href = url.toString()
          })

          const savedLang = localStorage.getItem('calypso-bay-lang')
          if (savedLang && ['fr', 'en', 'de'].includes(savedLang)) {
            languageSelector.value = savedLang
          }
        }
      })

      // LOGIQUE PRINCIPALE DE LA PAGE

      // Fonction pour traduire la page
      function translatePage(lang) {
        currentLang = lang
        const t = window.translations[lang]['finaliser-reservation']
        const common = window.translations[lang].common

        document.title = t.title

        document.getElementById('banner-title').textContent = t.banner.title
        document.getElementById('banner-subtitle').textContent =
          t.banner.subtitle
        document.getElementById('banner-description').textContent =
          t.banner.description
        document.getElementById('banner-button').textContent = t.banner.button

        document.getElementById('form-title').textContent = t.form.title
        document.getElementById('form-description').textContent =
          t.form.description

        document.getElementById('name-label').textContent = t.form.name
        document.getElementById('email-label').textContent = t.form.email
        document.getElementById('tel-label').textContent = t.form.tel
        document.getElementById('address-label').textContent = t.form.address
        document.getElementById('city-label').textContent = t.form.city
        document.getElementById('postal-label').textContent = t.form.postal
        document.getElementById('country-label').textContent = t.form.country

        document.getElementById('name').placeholder = t.form.name_placeholder
        document.getElementById('email').placeholder = t.form.email_placeholder
        document.getElementById('tel').placeholder = t.form.tel_placeholder
        document.getElementById('address').placeholder =
          t.form.address_placeholder
        document.getElementById('city').placeholder = t.form.city_placeholder
        document.getElementById('postal').placeholder =
          t.form.postal_placeholder
        document.getElementById('country').placeholder =
          t.form.country_placeholder

        document.getElementById('precisions-title').textContent =
          t.children.title
        document.getElementById('precisions-description').textContent =
          t.children.description

        document.getElementById('message-label').textContent = t.message.label
        document.getElementById('message').placeholder = t.message.placeholder

        document.getElementById('details-title').textContent = t.details.title
        document.getElementById('details-description').textContent =
          t.details.description
        document.getElementById('details-loading').textContent =
          t.details.loading

        document.getElementById('payment-title').textContent = t.payment.title
        document.getElementById('payment-description').textContent =
          t.payment.description
        document.getElementById('payment-summary-title').textContent =
          t.payment.summary_title
        document.getElementById('payment-total-label').textContent =
          t.payment.total
        document.getElementById('payment-deposit-label').textContent =
          t.payment.deposit.replace('{percent}', '')
        document.getElementById('payment-remaining-label').textContent =
          t.payment.remaining

        // Traduire les textes "Calcul en cours..." s'ils sont affich√©s
        const totalAmount = document.getElementById('total-amount')
        const depositAmount = document.getElementById('deposit-amount')
        const remainingAmount = document.getElementById('remaining-amount')

        if (totalAmount && totalAmount.textContent === 'Calcul en cours...') {
          totalAmount.textContent = t.payment.calculating
        }
        if (
          depositAmount &&
          depositAmount.textContent === 'Calcul en cours...'
        ) {
          depositAmount.textContent = t.payment.calculating
        }
        if (
          remainingAmount &&
          remainingAmount.textContent === 'Calcul en cours...'
        ) {
          remainingAmount.textContent = t.payment.calculating
        }
        document.getElementById('card-label').textContent = t.payment.card_label
        document.getElementById('submit-button-text').textContent =
          t.payment.submit_button
        document.getElementById('payment-disclaimer').textContent =
          t.payment.disclaimer

        if (document.querySelector('#language-selector')) {
          document.querySelector('#language-selector').value = lang
        }

        const url = new URL(window.location)
        url.searchParams.set('lang', lang)
        window.history.replaceState({}, '', url)

        updateTranslationsAfterLoad()
      }

      // Fonction pour traduire les √©l√©ments dynamiques du r√©capitulatif
      function translateRecapContent(data, lang) {
        const common = window.translations[lang].common
        const fmtMoney = (v) =>
          Number(v || 0).toLocaleString(
            lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-GB' : 'fr-FR',
            {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            }
          )
        const s = new Date(data.startDate)
        const e = new Date(data.endDate)
        const fmtDate = (dt) =>
          dt.toLocaleDateString(
            lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-GB' : 'fr-FR',
            {
              day: '2-digit',
              month: 'long',
              year: 'numeric'
            }
          )

        const lines = []
        lines.push(
          `<div class="detail-item"><strong>${
            common.dates
          }</strong><span>${fmtDate(s)} ${
            lang === 'de' ? 'bis' : lang === 'en' ? 'to' : 'au'
          } ${fmtDate(e)} (${data.nbNights} ${common.nights})</span></div>`
        )

        const adultText =
          data.nbAdults > 1 ? common.adults_plural : common.adults
        const childText =
          data.nbChilds > 1 ? common.children_plural : common.children
        lines.push(
          `<div class="detail-item"><strong>${common.travelers}</strong><span>${
            data.nbAdults
          } ${adultText}${
            data.nbChilds > 0 ? `, ${data.nbChilds} ${childText}` : ''
          }</span></div>`
        )

        if (
          data.nbChilds > 0 &&
          data.childrenAges &&
          data.childrenAges.length > 0
        ) {
          const ages = data.childrenAges.join(', ')
          lines.push(
            `<div class="detail-item"><strong>${common.children_ages}</strong><span>${ages}</span></div>`
          )
        }

        lines.push(
          `<div class="detail-item" style="border-bottom:none; display:block; padding-bottom:0;">
            <div><strong>${common.price_details}</strong></div>
            <div style="padding-top:8px">‚Ä¢ ${common.nights_total.replace(
              '{count}',
              data.nbNights
            )} ${fmtMoney(data.priceNights)} ${common.currency}</div>
            <div>‚Ä¢ ${common.cleaning_fees} ${fmtMoney(data.priceClean)} ${
            common.currency
          }</div>
            <div>‚Ä¢ ${common.taxes
              .replace('{count}', data.nbAdults)
              .replace('{adult_text}', adultText)} ${fmtMoney(data.priceTax)} ${
            common.currency
          }</div>
            <div>‚Ä¢ <strong>${common.total} ${fmtMoney(data.priceTotal)} ${
            common.currency
          }</strong></div>
          </div>`
        )

        if (data.address || data.city || data.postal || data.country) {
          lines.push(
            `<div class="detail-item" style="border-bottom:none; display:block; padding-bottom:0;">
              <div><strong>${common.billing_address}</strong></div>
              <div style="padding-top:8px">${data.address || ''}</div>
              <div>${data.postal || ''} ${data.city || ''}</div>
              <div>${data.country || ''}</div>
            </div>`
          )
        }

        return lines.join('')
      }

      // Mettre √† jour les traductions apr√®s chargement des donn√©es
      function updateTranslationsAfterLoad() {
        if (window.reservationData) {
          const recapEl = document.getElementById('reservation-details')
          if (recapEl && !recapEl.textContent.includes('Chargement')) {
            recapEl.innerHTML = translateRecapContent(
              window.reservationData,
              currentLang
            )
          }

          const lock = document.getElementById('payment-lock')
          const lockText = document.getElementById('payment-lock-text')
          if (lock && lockText && lock.style.display === 'flex') {
            const t = window.translations[currentLang]['finaliser-reservation']
            const st = String(window.reservationData.status || '')

            if (st === 'depositPay') {
              lockText.textContent =
                t.locks?.deposit_paid || 'Acompte d√©j√† r√©gl√©'
            } else if (st === 'balancePay') {
              lockText.textContent =
                t.locks?.balance_paid || 'Acompte et solde d√©j√† r√©gl√©s'
            } else if (st === 'canceled') {
              lockText.textContent =
                t.locks?.reservation_canceled || 'R√©servation annul√©e'
            }
          }

          // Mettre √† jour le message de la taxe de s√©jour
          const touristTaxNotice = document.getElementById('tourist-tax-notice')
          const touristTaxText = document.getElementById('tourist-tax-text')
          if (
            touristTaxNotice &&
            touristTaxText &&
            window.reservationData.priceTax > 0
          ) {
            const t =
              window.translations[currentLang]?.['finaliser-reservation']
            const taxText =
              t?.payment?.tourist_tax_note ||
              'La taxe de s√©jour de {amount} ‚Ç¨ sera √† remettre en liquide √† la concierge √† votre arriv√©e.'
            const locale =
              currentLang === 'de'
                ? 'de-DE'
                : currentLang === 'en'
                ? 'en-GB'
                : 'fr-FR'
            const formattedTaxAmount =
              window.reservationData.priceTax.toLocaleString(locale, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })
            touristTaxText.textContent = taxText.replace(
              '{amount}',
              formattedTaxAmount
            )
            touristTaxNotice.style.display = 'block'
          } else if (touristTaxNotice) {
            touristTaxNotice.style.display = 'none'
          }

          const errorContainer = document.getElementById('error-container')
          if (errorContainer && errorContainer.textContent) {
            const t = window.translations[currentLang]['finaliser-reservation']
            const errorText = errorContainer.textContent
            if (errorText.includes('Token manquant')) {
              errorContainer.innerHTML = `<div class="error-message">‚ùå ${
                t.errors?.missing_token || 'Token manquant'
              }</div>`
            } else if (errorText.includes('Erreur lors du chargement')) {
              errorContainer.innerHTML = `<div class="error-message">‚ùå ${
                t.errors?.loading_error || 'Erreur lors du chargement'
              }</div>`
            }
          }

          // Mettre √† jour les textes de paiement avec la nouvelle langue
          if (window.reservationData) {
            calculatePaymentAmount(window.reservationData)
          }
        }
      }

      // Initialiser Stripe
      const stripe = Stripe(
        'pk_live_51RuYagJuxMM0V1wvWkNbfWITDKf6J6Q8BaoCPCwWrd6juAMlGekc3RADsm9VfcFcfkk7dYmY8dgDr0DqHOBw3qtb006Bbqn4e4'
      )
      const elements = stripe.elements()
      const card = elements.create('card', {
        style: {
          base: {
            fontSize: '16px',
            color: '#424770',
            '::placeholder': {
              color: '#aab7c4'
            }
          }
        }
      })
      card.mount('#card-element')

      // Gestion des erreurs de carte
      card.addEventListener('change', function (event) {
        const displayError = document.getElementById('card-errors')
        if (event.error) {
          displayError.textContent = event.error.message
        } else {
          displayError.textContent = ''
        }
      })

      // R√©cup√©rer le token depuis l'URL
      const urlParams = new URLSearchParams(window.location.search)
      const token = urlParams.get('token')

      if (!token) {
        showError('Token de r√©servation manquant')
      } else {
        // Charger les donn√©es de r√©servation
        loadReservationData()
      }

      // FONCTIONS DE VALIDATION ET MESSAGES TRADUITS

      // Validation des champs
      function validateField(fieldId, errorId, validationFn) {
        const field = document.getElementById(fieldId)
        const errorElement = document.getElementById(errorId)
        const value = field.value.trim()

        field.classList.remove('validation-error')
        errorElement.textContent = ''

        if (!validationFn(value)) {
          field.classList.add('validation-error')
          // Utiliser la traduction pour le message d'erreur
          const t = window.translations[currentLang]?.['finaliser-reservation']
          errorElement.textContent =
            t?.validation?.required || 'Ce champ est obligatoire'
          return false
        }
        return true
      }

      function validateEmail(email) {
        return email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)
      }

      function validatePhone(phone) {
        return phone && phone.length >= 10
      }

      function validateRequired(value) {
        return value && value.length > 0
      }

      // Validation en temps r√©el
      document.getElementById('name').addEventListener('blur', () => {
        validateField('name', 'name-error', validateRequired)
      })

      document.getElementById('email').addEventListener('blur', () => {
        validateField('email', 'email-error', validateEmail)
      })

      document.getElementById('tel').addEventListener('blur', () => {
        validateField('tel', 'tel-error', validatePhone)
      })

      document.getElementById('address').addEventListener('blur', () => {
        validateField('address', 'address-error', validateRequired)
      })

      document.getElementById('city').addEventListener('blur', () => {
        validateField('city', 'city-error', validateRequired)
      })

      document.getElementById('postal').addEventListener('blur', () => {
        validateField('postal', 'postal-error', validateRequired)
      })

      document.getElementById('message').addEventListener('blur', () => {
        // Le message est optionnel, donc pas de validation stricte
        const messageField = document.getElementById('message')
        const messageError = document.getElementById('message-error')
        messageField.classList.remove('validation-error')
        messageError.textContent = ''
      })

      async function loadReservationData() {
        try {
          // Charger la configuration serveur (pourcentage/minimum acompte)
          try {
            const cfgRes = await fetch('/api/config')
            if (cfgRes.ok) {
              window.appConfig = await cfgRes.json()
            }
          } catch (e) {
            // Message de console en fran√ßais (pas besoin de traduction)
            console.warn('Config non charg√©e, valeurs par d√©faut utilis√©es')
          }

          const response = await fetch(
            `/api/reservations?action=get&token=${encodeURIComponent(token)}`
          )
          const result = await response.json()

          if (result.status === 'success') {
            window.reservationData = result.data
            populateForm(result.data)
            calculatePaymentAmount(result.data)
            applyPaymentLocks(result.data)
          } else {
            // Au lieu de bloquer avec showError, on continue avec des donn√©es vides
            console.warn('Statut API non r√©ussi:', result.message)
            window.reservationData = null
            // On laisse les sections vides mais on continue
          }
        } catch (error) {
          // Au lieu de bloquer avec showError, on continue avec des donn√©es vides
          console.error('Erreur de connexion:', error)
          window.reservationData = null
          // On laisse les sections vides mais on continue
        }
      }

      // Nouvelle fonction pour appliquer les verrouillages de paiement
      function applyPaymentLocks(data) {
        if (!data) return

        const lock = document.getElementById('payment-lock')
        const lockText = document.getElementById('payment-lock-text')

        if (lock && lockText) {
          const t = window.translations[currentLang]?.['finaliser-reservation']

          // ‚úÖ LOGIQUE CORRIG√âE : Ordre chronologique des v√©rifications
          // On s'arr√™te √† la premi√®re condition vraie

          // 1. V√©rifier si la r√©servation a expir√© (priorit√© absolue)
          if (data.endDate) {
            const endDate = new Date(data.endDate)
            const today = new Date()
            today.setHours(0, 0, 0, 0) // Remettre √† minuit pour la comparaison

            if (endDate < today) {
              lockText.textContent =
                t?.locks?.reservation_expired || 'Votre r√©servation a expir√©'
              lock.style.display = 'flex'
              return // On s'arr√™te ici
            }
          }

          // 2. V√©rifier si la r√©servation est annul√©e
          const cancelStatus = String(data.cancelStatus || '')
          if (cancelStatus === 'validated') {
            lockText.textContent =
              t?.locks?.reservation_canceled || 'R√©servation annul√©e'
            lock.style.display = 'flex'
            return // On s'arr√™te ici
          }

          // 3. V√©rifier si l'annulation est en cours (PRIORIT√â ABSOLUE)
          if (cancelStatus === 'pending') {
            lockText.textContent =
              t?.locks?.cancellation_pending ||
              "Votre r√©servation fait l'objet d'une demande d'annulation"
            lock.style.display = 'flex'
            return // On s'arr√™te ici
          }

          // 4. V√©rifier si l'acompte et le solde sont d√©j√† r√©gl√©s
          const st = String(data.status || '')
          if (st === 'balancePay') {
            lockText.textContent =
              t?.locks?.balance_paid || 'Acompte et solde d√©j√† r√©gl√©s'
            lock.style.display = 'flex'
            return // On s'arr√™te ici
          }

          // 5. V√©rifier si l'acompte est d√©j√† r√©gl√©
          if (st === 'depositPay') {
            lockText.textContent =
              t?.locks?.deposit_paid || 'Acompte d√©j√† r√©gl√©'
            lock.style.display = 'flex'
            return // On s'arr√™te ici
          }

          // Si aucune condition n'est vraie, pas de verrouillage

          lock.style.display = 'none'
        }
      }

      function populateForm(data) {
        if (!data) {
          // Si pas de donn√©es, on laisse les champs vides et on continue
          console.warn('Aucune donn√©e de r√©servation disponible')
          return
        }

        // Remplir les champs du formulaire avec les donn√©es disponibles
        document.getElementById('name').value = data.name || ''
        document.getElementById('email').value = data.email || ''
        document.getElementById('tel').value = data.tel || ''

        generateChildrenAgeFields(data.nbChilds || 0)

        // Afficher les d√©tails de la r√©servation si disponibles
        const detailsContainer = document.getElementById('reservation-details')
        if (detailsContainer) {
          if (data.startDate && data.endDate) {
            // Si on a les dates, on peut afficher les d√©tails
            const reservationDetails = formatReservationDetails(data)
            const sections = reservationDetails.split('<hr')
            const detailsHtml = sections
              .map((section) => {
                if (section.trim()) {
                  const cleanSection = section.replace(/^[^>]*>/, '').trim()
                  if (cleanSection) {
                    return `<div class="detail-item"><span>${cleanSection}</span></div>`
                  }
                }
                return ''
              })
              .join('')
            detailsContainer.innerHTML = detailsHtml
          } else {
            // Si pas de dates, on laisse la section vide
            detailsContainer.innerHTML = ''
          }
        }
      }

      // Fonction pour g√©n√©rer dynamiquement les champs d'√¢ges des enfants
      function generateChildrenAgeFields(nbChildren) {
        const container = document.getElementById('children-ages-container')
        const sectionDescription = document.getElementById(
          'precisions-description'
        )

        if (!container || !sectionDescription) {
          console.warn(
            "√âl√©ments manquants pour la g√©n√©ration des champs d'√¢ges des enfants"
          )
          return
        }

        if (nbChildren === 0) {
          container.innerHTML = ''
          const t = window.translations[currentLang]?.['finaliser-reservation']
          sectionDescription.innerHTML =
            t?.children?.description ||
            'Vous pouvez nous laisser un message ou nous poser des questions si vous le souhaitez.'
          return
        }

        const t = window.translations[currentLang]?.['finaliser-reservation']
        sectionDescription.innerHTML =
          t?.children?.description_with_children ||
          'Vous pouvez nous laisser un message ou nous poser des questions si vous le souhaitez.<br><br><div style="background: rgba(255, 193, 7, 0.2); border: 1px solid rgba(255, 193, 7, 0.5); border-radius: 8px; padding: 12px; margin-top: 15px; display: flex; align-items: center; gap: 8px;"><span style="color: #856404; font-size: 16px;">‚ö†Ô∏è</span><span style="color: #856404; font-weight: 500;">Rappel : les enfants de moins de 8 ans ne sont pas admis.</span></div>'

        let html = ''

        for (let i = 1; i <= nbChildren; i++) {
          const t = window.translations[currentLang]?.['finaliser-reservation']
          const ageLabel = t?.children?.age_label || "√Çge de l'enfant"
          const agePlaceholder =
            t?.children?.age_placeholder || "√Çge de l'enfant"

          html += `
            <div class="form-group">
              <label for="child-age-${i}">${ageLabel} ${i}</label>
              <input
                type="number"
                id="child-age-${i}"
                name="child-age-${i}"
                placeholder="${agePlaceholder} ${i}"
                min="0"
                max="17"
                required
              />
              <div class="validation-message" id="child-age-${i}-error"></div>
            </div>
          `
        }

        container.innerHTML = html

        // Ajouter la validation pour les nouveaux champs
        for (let i = 1; i <= nbChildren; i++) {
          document
            .getElementById(`child-age-${i}`)
            .addEventListener('blur', () => {
              validateField(
                `child-age-${i}`,
                `child-age-${i}-error`,
                validateChildAge
              )
            })
        }
      }

      // Fonction de validation pour l'√¢ge des enfants
      function validateChildAge(age) {
        const ageNum = parseInt(age)
        return age && ageNum >= 0 && ageNum <= 17
      }

      function calculatePaymentAmount(data) {
        let totalAmount = data.priceTotal

        if (totalAmount && totalAmount > 0) {
          const percent = window.appConfig?.DEPOSIT_PERCENT ?? 10
          const minEur = window.appConfig?.DEPOSIT_MIN_EUR ?? 0.5
          let depositAmount = totalAmount * (percent / 100)
          if (!depositAmount || depositAmount <= 0) depositAmount = minEur
          if (depositAmount < minEur) depositAmount = minEur
          const remainingAmount = totalAmount - depositAmount

          const locale =
            currentLang === 'de'
              ? 'de-DE'
              : currentLang === 'en'
              ? 'en-GB'
              : 'fr-FR'
          document.getElementById(
            'total-amount'
          ).textContent = `${totalAmount.toLocaleString(locale, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })} ‚Ç¨`
          document.getElementById(
            'deposit-amount'
          ).textContent = `${depositAmount.toLocaleString(locale, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })} ‚Ç¨`
          document.getElementById(
            'remaining-amount'
          ).textContent = `${remainingAmount.toLocaleString(locale, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })} ‚Ç¨`

          const progressFill = document.getElementById('progress-fill')
          const progressPercentage = Math.min(
            100,
            (depositAmount / totalAmount) * 100
          )
          progressFill.style.width = `${progressPercentage}%`

          const buttonText = document.getElementById('submit-button-text')
          if (buttonText) {
            const t =
              window.translations[currentLang]?.['finaliser-reservation']
            const buttonTextTemplate =
              t?.payment?.submit_button_with_amount ||
              "Payer l'acompte ‚Äì {amount} ‚Ç¨"
            const newButtonText = buttonTextTemplate.replace(
              '{amount}',
              depositAmount.toLocaleString(
                currentLang === 'de'
                  ? 'de-DE'
                  : currentLang === 'en'
                  ? 'en-GB'
                  : 'fr-FR',
                { minimumFractionDigits: 2, maximumFractionDigits: 2 }
              )
            )
            buttonText.textContent = newButtonText
          } else {
            console.error('Button text element not found')
          }

          const dp = document.getElementById('deposit-percent')
          const dpi = document.getElementById('deposit-percent-inline')
          if (dp) dp.textContent = `${percent}%`
          if (dpi) dpi.textContent = `${percent}%`

          // Afficher le message de la taxe de s√©jour
          const touristTaxNotice = document.getElementById('tourist-tax-notice')
          const touristTaxText = document.getElementById('tourist-tax-text')
          if (touristTaxNotice && touristTaxText && data.priceTax > 0) {
            const t =
              window.translations[currentLang]?.['finaliser-reservation']
            const taxText =
              t?.payment?.tourist_tax_note ||
              'La taxe de s√©jour de {amount} ‚Ç¨ sera √† remettre en liquide √† la concierge √† votre arriv√©e.'
            const formattedTaxAmount = data.priceTax.toLocaleString(locale, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })
            touristTaxText.textContent = taxText.replace(
              '{amount}',
              formattedTaxAmount
            )
            touristTaxNotice.style.display = 'block'
          } else if (touristTaxNotice) {
            touristTaxNotice.style.display = 'none'
          }

          window.totalAmount = totalAmount
        } else {
          // Si pas de donn√©es ou pas de prix, on laisse les champs vides
          const totalEl = document.getElementById('total-amount')
          const depositEl = document.getElementById('deposit-amount')
          const remainingEl = document.getElementById('remaining-amount')

          if (totalEl) totalEl.textContent = '‚Äî'
          if (depositEl) depositEl.textContent = '‚Äî'
          if (remainingEl) remainingEl.textContent = '‚Äî'

          // D√©sactiver le bouton de paiement
          const submitButton = document.getElementById('submit-button')
          if (submitButton) submitButton.disabled = true
        }
      }

      // Gestion de la soumission du formulaire
      document
        .getElementById('finalization-form')
        .addEventListener('submit', async function (event) {
          event.preventDefault()

          const validations = [
            validateField('name', 'name-error', validateRequired),
            validateField('email', 'email-error', validateEmail),
            validateField('tel', 'tel-error', validatePhone),
            validateField('address', 'address-error', validateRequired),
            validateField('city', 'city-error', validateRequired),
            validateField('postal', 'postal-error', validateRequired)
          ]

          const nbChildren = window.reservationData?.nbChilds || 0
          for (let i = 1; i <= nbChildren; i++) {
            validations.push(
              validateField(
                `child-age-${i}`,
                `child-age-${i}-error`,
                validateChildAge
              )
            )
          }

          if (!validations.every((v) => v)) {
            showError('Veuillez corriger les erreurs dans le formulaire')
            return
          }

          const submitButton = document.getElementById('submit-button')
          const btnTextSpan = document.getElementById('submit-button-text')
          submitButton.disabled = true

          const t = window.translations[currentLang]?.['finaliser-reservation']
          const processingText =
            t?.payment?.processing || 'Traitement en cours...'

          if (btnTextSpan) {
            btnTextSpan.textContent = processingText
          } else {
            submitButton.textContent = processingText
          }

          try {
            const childrenAges = Array.from(
              document.querySelectorAll('[id^="child-age-"]')
            )
              .map((el) => (el && el.value ? Number(el.value) : null))
              .filter((v) => v !== null)

            const formData = {
              name: document.getElementById('name').value,
              email: document.getElementById('email').value,
              tel: document.getElementById('tel').value,
              address: document.getElementById('address').value,
              city: document.getElementById('city').value,
              postal: document.getElementById('postal').value,
              country: document.getElementById('country').value,
              message: document.getElementById('message')?.value || '',
              childrenAges
            }

            const paymentResponse = await fetch('/api/createPayment', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                token: token,
                type: 'deposit',
                totalAmount: window.totalAmount,
                formData
              })
            })

            const paymentResult = await paymentResponse.json()

            if (!paymentResult.clientSecret) {
              throw new Error(
                paymentResult.error || 'Erreur lors de la cr√©ation du paiement'
              )
            }

            const { error } = await stripe.confirmCardPayment(
              paymentResult.clientSecret,
              {
                payment_method: {
                  card: card,
                  billing_details: {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value
                  }
                }
              }
            )

            if (error) {
              throw new Error(error.message)
            }

            showSuccess(
              "Paiement confirm√© ‚úîÔ∏è. Un email de confirmation vient d'√™tre envoy√©."
            )
            setTimeout(() => {
              window.location.href = '/reservation-confirmee.html'
            }, 1500)
          } catch (error) {
            showError(error.message)
            submitButton.disabled = false
            if (window.totalAmount) {
              const depositAmount = window.totalAmount * 0.1
              const t =
                window.translations[currentLang]?.['finaliser-reservation']
              const buttonTextTemplate =
                t?.payment?.submit_button_with_amount ||
                "Payer l'acompte ‚Äì {amount} ‚Ç¨"
              const buttonTextFormatted = buttonTextTemplate.replace(
                '{amount}',
                depositAmount.toLocaleString(
                  currentLang === 'de'
                    ? 'de-DE'
                    : currentLang === 'en'
                    ? 'en-GB'
                    : 'fr-FR',
                  {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                  }
                )
              )

              const buttonText = document.getElementById('submit-button-text')
              if (buttonText) {
                buttonText.textContent = buttonTextFormatted
              } else {
                submitButton.textContent = buttonTextFormatted
              }
            }
          }
        })

      function showError(message) {
        const container = document.getElementById('error-container')
        const t = window.translations[currentLang]?.['finaliser-reservation']
        let translatedMessage = message

        if (t?.errors) {
          if (message.includes('Token de r√©servation manquant')) {
            translatedMessage = t.errors.missing_token || message
          } else if (message.includes('Erreur lors du chargement')) {
            translatedMessage = t.errors.loading_error || message
          } else if (message.includes('Erreur de connexion')) {
            translatedMessage = t.errors.connection_error || message
          } else if (message.includes('Veuillez corriger les erreurs')) {
            translatedMessage = t.validation.form_errors || message
          }
        }

        container.innerHTML = `<div class="error-message">‚ùå ${translatedMessage}</div>`
      }

      function showSuccess(message) {
        const container = document.getElementById('success-container')
        const t = window.translations[currentLang]?.['finaliser-reservation']
        let translatedMessage = message

        if (t?.success && message.includes('Paiement confirm√©')) {
          translatedMessage = t.success.message || message
        }

        container.innerHTML = `<div class="success-message">‚úÖ ${translatedMessage}</div>`
      }

      function formatReservationDetails(data) {
        if (!data) {
          const t = window.translations[currentLang]?.['finaliser-reservation']
          return t?.details?.no_details || 'Aucun d√©tail'
        }

        const startDate = new Date(data.startDate)
        const endDate = new Date(data.endDate)

        const formatDate = (date) => {
          return date.toLocaleDateString(
            currentLang === 'de'
              ? 'de-DE'
              : currentLang === 'en'
              ? 'en-GB'
              : 'fr-FR',
            {
              day: '2-digit',
              month: 'long',
              year: 'numeric'
            }
          )
        }

        const startDateStr = formatDate(startDate)
        const endDateStr = formatDate(endDate)
        const common = window.translations[currentLang]?.common
        const datesSection = `<strong>${
          common?.dates || 'Dates :'
        }</strong> ${startDateStr} ${
          currentLang === 'de' ? 'bis' : currentLang === 'en' ? 'to' : 'au'
        } ${endDateStr} (${data.nbNights} ${common?.nights || 'nuits'})`

        let travelersSection
        if (data.nbChilds > 0) {
          const adultText =
            data.nbAdults > 1
              ? common?.adults_plural || 'adultes'
              : common?.adults || 'adulte'
          const childText =
            data.nbChilds > 1
              ? common?.children_plural || 'enfants'
              : common?.children || 'enfant'
          travelersSection = `<strong>${
            common?.travelers || 'Voyageurs :'
          }</strong> ${data.nbAdults} ${adultText}, ${
            data.nbChilds
          } ${childText}`
        } else {
          const adultText =
            data.nbAdults > 1
              ? common?.adults_plural || 'adultes'
              : common?.adults || 'adulte'
          travelersSection = `<strong>${
            common?.travelers || 'Voyageurs :'
          }</strong> ${data.nbAdults} ${adultText}`
        }

        let priceDetails = [
          `<strong>${common?.price_details || 'D√©tail du prix :'}</strong>`
        ]

        if (data.priceNights > 0) {
          const nightsText =
            common?.nights_total?.replace('{count}', data.nbNights) ||
            `Total des nuits (${data.nbNights})`
          priceDetails.push(
            `&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ ${nightsText} ${data.priceNights.toLocaleString(
              currentLang === 'de'
                ? 'de-DE'
                : currentLang === 'en'
                ? 'en-GB'
                : 'fr-FR'
            )} ‚Ç¨`
          )
        }

        if (data.priceClean > 0) {
          const cleaningText = common?.cleaning_fees || 'Frais de m√©nage'
          priceDetails.push(
            `&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ ${cleaningText} ${data.priceClean.toLocaleString(
              currentLang === 'de'
                ? 'de-DE'
                : currentLang === 'en'
                ? 'en-GB'
                : 'fr-FR'
            )} ‚Ç¨`
          )
        }

        if (data.priceTax > 0) {
          const adultText =
            data.nbAdults > 1
              ? common?.adults_plural || 'adultes'
              : common?.adults || 'adulte'
          const taxesText =
            common?.taxes
              ?.replace('{count}', data.nbAdults)
              .replace('{adult_text}', adultText) ||
            `Taxes (${data.nbAdults} ${adultText})`
          priceDetails.push(
            `&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ ${taxesText} ${data.priceTax.toLocaleString(
              currentLang === 'de'
                ? 'de-DE'
                : currentLang === 'en'
                ? 'en-GB'
                : 'fr-FR'
            )} ‚Ç¨`
          )
        }

        if (data.priceTotal > 0) {
          const totalText = common?.total || 'Total'
          priceDetails.push(
            `&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ <strong>${totalText} ${data.priceTotal.toLocaleString(
              currentLang === 'de'
                ? 'de-DE'
                : currentLang === 'en'
                ? 'en-GB'
                : 'fr-FR'
            )} ‚Ç¨</strong>`
          )
        }

        const priceSection = priceDetails.join('<br>')

        const result = `${datesSection}<hr style="border: none; border-top: 1px solid rgba(255,255,255,0.3); margin: 0.5rem 0;" />${travelersSection}<br><br>${priceSection}`

        return result
      }
    </script>
  </body>
</html>
