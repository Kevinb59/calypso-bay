<!DOCTYPE html>
<html>
  <head>
    <title>Finaliser ma r√©servation - Calypso Bay</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/custom.css" />
    <noscript
      ><link rel="stylesheet" href="assets/css/noscript.css"
    /></noscript>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      .form-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 40px;
        margin-bottom: 30px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
      }
      .form-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        pointer-events: none;
      }
      .form-section > * {
        position: relative;
        z-index: 1;
      }
      .form-group {
        margin-bottom: 25px;
      }
      .form-group label {
        display: none;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid rgba(229, 231, 235, 0.5);
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        color: #374151;
      }
      .form-group input::placeholder,
      .form-group textarea::placeholder {
        color: #6b7280;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #5d3fd3;
        box-shadow: 0 0 0 4px rgba(93, 63, 211, 0.15);
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-2px);
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
      }
      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }
      .reservation-details {
        background: rgba(248, 250, 252, 0.1);
        padding: 30px;
        border-radius: 16px;
        margin-bottom: 20px;
        border: 1px solid rgba(229, 231, 235, 0.3);
        backdrop-filter: blur(15px);
      }
      .reservation-details h3 {
        color: #5d3fd3;
        margin-bottom: 20px;
        font-size: 1.3rem;
        font-weight: 700;
        text-align: center;
      }
      .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding: 12px 0;
        border-bottom: 1px solid rgba(229, 231, 235, 0.4);
        font-size: 0.85rem;
      }
      .detail-item:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 1.2rem;
        color: #5d3fd3;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid rgba(93, 63, 211, 0.2);
      }
      .payment-section {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        position: relative;
      }
      .payment-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        pointer-events: none;
      }
      .payment-amount {
        text-align: center;
        font-size: 2.5rem;
        font-weight: bold;
        color: #10b981;
        margin-bottom: 30px;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 16px;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(16, 185, 129, 0.2);
      }
      .payment-amount.highlight {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }
      #card-element {
        padding: 15px;
        border: 2px solid rgba(229, 231, 235, 0.5);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }
      #card-element:focus-within {
        border-color: #5d3fd3;
        box-shadow: 0 0 0 4px rgba(93, 63, 211, 0.15);
        background: rgba(255, 255, 255, 0.95);
      }
      #card-errors {
        color: #ef4444;
        margin-top: 12px;
        font-size: 14px;
        font-weight: 500;
      }
      .btn-submit {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 18px 30px;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .btn-submit:hover {
        background: linear-gradient(135deg, #059669, #047857);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
      }
      .btn-submit:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #10b981;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error-message {
        background: rgba(254, 242, 242, 0.95);
        color: #ef4444;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #fecaca;
        backdrop-filter: blur(10px);
      }
      .success-message {
        background: rgba(240, 253, 244, 0.95);
        color: #10b981;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #bbf7d0;
        backdrop-filter: blur(10px);
      }
      .progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #5d3fd3, #10b981);
        z-index: 1001;
      }
      .validation-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15) !important;
      }
      .validation-message {
        color: #ef4444;
        font-size: 12px;
        margin-top: 5px;
        font-weight: 500;
      }
    </style>
  </head>
  <body class="is-preload">
    <!-- Progress Bar -->
    <div class="progress-bar"></div>

    <!-- Page Wrapper -->
    <div id="page-wrapper">
      <!-- Wrapper -->
      <div id="wrapper">
        <!-- H E A D E R //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel banner right">
          <div class="content color0 span-3-75">
            <h2 class="major">
              Finaliser ma<br />
              <span class="themysion">Reservation</span>
            </h2>
            <p>
              Votre demande de r√©servation a √©t√© accept√©e ! Compl√©tez le
              formulaire ci-dessous et effectuez le paiement de l'acompte de 10%
              pour confirmer votre r√©servation √† Calypso Bay.
            </p>
            <ul class="actions">
              <li>
                <a
                  href="#form"
                  class="button primary color1 circle icon solid fa-angle-right"
                  >Commencer</a
                >
              </li>
            </ul>
          </div>
          <div class="image filtered span-1-75" data-position="25% 25%">
            <img src="images/pic01.jpg" alt="" />
          </div>
        </section>

        <!-- F O R M U L A I R E //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel spotlight medium right" id="form">
          <div class="content span-9-5">
            <h3 class="major">üìã Informations personnelles</h3>
            <p>
              Veuillez compl√©ter vos informations personnelles pour finaliser
              votre r√©servation. Ces donn√©es nous permettront de vous contacter
              et de pr√©parer votre accueil.
            </p>

            <div id="error-container"></div>
            <div id="success-container"></div>

            <form id="finalization-form">
              <div class="form-section">
                <div class="form-row">
                  <div class="form-group">
                    <label for="name">Nom complet</label>
                    <input
                      type="text"
                      id="name"
                      name="name"
                      placeholder="NOM COMPLET"
                      required
                    />
                    <div class="validation-message" id="name-error"></div>
                  </div>
                  <div class="form-group">
                    <label for="email">Email</label>
                    <input
                      type="email"
                      id="email"
                      name="email"
                      placeholder="EMAIL"
                      required
                    />
                    <div class="validation-message" id="email-error"></div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="tel">T√©l√©phone</label>
                    <input
                      type="tel"
                      id="tel"
                      name="tel"
                      placeholder="T√âL√âPHONE"
                      required
                    />
                    <div class="validation-message" id="tel-error"></div>
                  </div>
                  <div class="form-group">
                    <label for="address">Adresse</label>
                    <input
                      type="text"
                      id="address"
                      name="address"
                      placeholder="ADRESSE"
                      required
                    />
                    <div class="validation-message" id="address-error"></div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="city">Ville</label>
                    <input
                      type="text"
                      id="city"
                      name="city"
                      placeholder="VILLE"
                      required
                    />
                    <div class="validation-message" id="city-error"></div>
                  </div>
                  <div class="form-group">
                    <label for="postal">Code postal</label>
                    <input
                      type="text"
                      id="postal"
                      name="postal"
                      placeholder="CODE POSTAL"
                      required
                    />
                    <div class="validation-message" id="postal-error"></div>
                  </div>
                </div>
                <div class="form-group">
                  <label for="country">Pays</label>
                  <input
                    type="text"
                    id="country"
                    name="country"
                    value="France"
                    placeholder="PAYS"
                    required
                  />
                  <div class="validation-message" id="country-error"></div>
                </div>
              </div>
            </form>
          </div>
          <div class="image filtered tinted" data-position="center">
            <img src="images/pic02.jpg" alt="" />
          </div>
        </section>

        <!-- D √â T A I L S //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel large color1">
          <div class="intro joined span-3-5">
            <h2 class="major">üìÖ D√©tails de la r√©servation</h2>
            <p>
              Voici un r√©capitulatif de votre demande de r√©servation. V√©rifiez
              que toutes les informations sont correctes avant de proc√©der au
              paiement.
            </p>
          </div>
          <div class="inner">
            <div class="form-section">
              <div class="reservation-details" id="reservation-details">
                <div class="loading">
                  <div class="spinner"></div>
                  <p>Chargement des d√©tails...</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- P A I E M E N T //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel color4-alt">
          <div class="intro color4">
            <h2 class="major">üí≥ Paiement de l'acompte</h2>
            <p>
              Pour confirmer votre r√©servation, veuillez effectuer le paiement
              de l'acompte de 10% du montant total. Le solde sera √† r√©gler au
              plus tard 7 jours avant votre arriv√©e.
            </p>
          </div>
          <div class="inner columns divided">
            <div class="span-4-5">
              <div class="form-section payment-section">
                <div class="payment-amount" id="payment-amount">
                  Calcul en cours...
                </div>
                <div class="form-group">
                  <label for="card-element"
                    >Informations de carte bancaire</label
                  >
                  <div id="card-element"></div>
                  <div id="card-errors" role="alert"></div>
                </div>
                <button
                  type="submit"
                  class="btn-submit"
                  id="submit-button"
                  form="finalization-form"
                >
                  <span id="button-text"
                    >Payer l'acompte et confirmer ma r√©servation</span
                  >
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
      // Initialiser Stripe
      const stripe = Stripe(
        'pk_live_51RuYagJuxMM0V1wvWkNbfWITDKf6J6Q8BaoCPCwWrd6juAMlGekc3RADsm9VfcFcfkk7dYmY8dgDr0DqHOBw3qtb006Bbqn4e4'
      )
      const elements = stripe.elements()
      const card = elements.create('card', {
        style: {
          base: {
            fontSize: '16px',
            color: '#424770',
            '::placeholder': {
              color: '#aab7c4'
            }
          }
        }
      })
      card.mount('#card-element')

      // Gestion des erreurs de carte
      card.addEventListener('change', function (event) {
        const displayError = document.getElementById('card-errors')
        if (event.error) {
          displayError.textContent = event.error.message
        } else {
          displayError.textContent = ''
        }
      })

      // R√©cup√©rer le token depuis l'URL
      const urlParams = new URLSearchParams(window.location.search)
      const token = urlParams.get('token')

      if (!token) {
        showError('Token de r√©servation manquant')
      } else {
        // Charger les donn√©es de r√©servation
        loadReservationData()
      }

      // Validation des champs
      function validateField(fieldId, errorId, validationFn) {
        const field = document.getElementById(fieldId)
        const errorElement = document.getElementById(errorId)
        const value = field.value.trim()

        field.classList.remove('validation-error')
        errorElement.textContent = ''

        if (!validationFn(value)) {
          field.classList.add('validation-error')
          errorElement.textContent = 'Ce champ est obligatoire'
          return false
        }
        return true
      }

      function validateEmail(email) {
        return email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)
      }

      function validatePhone(phone) {
        return phone && phone.length >= 10
      }

      function validateRequired(value) {
        return value && value.length > 0
      }

      // Validation en temps r√©el
      document.getElementById('name').addEventListener('blur', () => {
        validateField('name', 'name-error', validateRequired)
      })

      document.getElementById('email').addEventListener('blur', () => {
        validateField('email', 'email-error', validateEmail)
      })

      document.getElementById('tel').addEventListener('blur', () => {
        validateField('tel', 'tel-error', validatePhone)
      })

      document.getElementById('address').addEventListener('blur', () => {
        validateField('address', 'address-error', validateRequired)
      })

      document.getElementById('city').addEventListener('blur', () => {
        validateField('city', 'city-error', validateRequired)
      })

      document.getElementById('postal').addEventListener('blur', () => {
        validateField('postal', 'postal-error', validateRequired)
      })

      async function loadReservationData() {
        try {
          const response = await fetch(
            `/api/getReservation?token=${encodeURIComponent(token)}`
          )
          const result = await response.json()

          if (result.status === 'success') {
            populateForm(result.data)
            calculatePaymentAmount(result.data)
          } else {
            showError(result.message || 'Erreur lors du chargement des donn√©es')
          }
        } catch (error) {
          showError('Erreur de connexion')
          console.error('Erreur:', error)
        }
      }

      function populateForm(data) {
        document.getElementById('name').value = data.name || ''
        document.getElementById('email').value = data.email || ''
        document.getElementById('tel').value = data.tel || ''

        // Afficher les d√©tails de r√©servation
        const detailsContainer = document.getElementById('reservation-details')
        detailsContainer.innerHTML = `
					<h3>R√©sum√© de votre demande</h3>
					<div class="detail-item">
						<span>Nom :</span>
						<span>${escapeHtml(data.name)}</span>
					</div>
					<div class="detail-item">
						<span>Email :</span>
						<span>${escapeHtml(data.email)}</span>
					</div>
					<div class="detail-item">
						<span>D√©tails :</span>
						<span>${formatReservationDetails(data.reservationDetails)}</span>
					</div>
					${
            data.userMessage
              ? `
					<div class="detail-item">
						<span>Message :</span>
						<span>${escapeHtml(data.userMessage)}</span>
					</div>
					`
              : ''
          }
				`
      }

      function calculatePaymentAmount(data) {
        // Extraire le montant total des d√©tails de r√©servation
        const totalMatch = data.reservationDetails.match(
          /total\s*:\s*([\d\s,]+)\s*‚Ç¨/i
        )
        if (totalMatch) {
          const totalAmount = parseFloat(totalMatch[1].replace(/[\s,]/g, ''))
          const depositAmount = totalAmount * 0.1

          const paymentAmountElement = document.getElementById('payment-amount')
          paymentAmountElement.textContent = `${depositAmount.toFixed(2)} ‚Ç¨`
          paymentAmountElement.classList.add('highlight')

          // Mettre √† jour le texte du bouton avec le montant
          const buttonText = document.getElementById('button-text')
          if (buttonText) {
            buttonText.textContent = `Payer ${depositAmount.toFixed(
              2
            )} ‚Ç¨ (acompte) et confirmer ma r√©servation`
          }

          // Stocker le montant total pour le paiement
          window.totalAmount = totalAmount
        } else {
          document.getElementById('payment-amount').textContent =
            'Montant √† calculer'
        }
      }

      // Gestion de la soumission du formulaire
      document
        .getElementById('finalization-form')
        .addEventListener('submit', async function (event) {
          event.preventDefault()

          // Validation compl√®te avant soumission
          const validations = [
            validateField('name', 'name-error', validateRequired),
            validateField('email', 'email-error', validateEmail),
            validateField('tel', 'tel-error', validatePhone),
            validateField('address', 'address-error', validateRequired),
            validateField('city', 'city-error', validateRequired),
            validateField('postal', 'postal-error', validateRequired)
          ]

          if (!validations.every((v) => v)) {
            showError('Veuillez corriger les erreurs dans le formulaire')
            return
          }

          const submitButton = document.getElementById('submit-button')
          submitButton.disabled = true
          submitButton.textContent = 'Traitement en cours...'

          try {
            // Cr√©er le PaymentIntent
            const paymentResponse = await fetch('/api/createPaymentIntent', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                token: token,
                totalAmount: window.totalAmount
              })
            })

            const paymentResult = await paymentResponse.json()

            if (!paymentResult.clientSecret) {
              throw new Error(
                paymentResult.error || 'Erreur lors de la cr√©ation du paiement'
              )
            }

            // Confirmer le paiement avec Stripe
            const { error, paymentIntent } = await stripe.confirmCardPayment(
              paymentResult.clientSecret,
              {
                payment_method: {
                  card: card,
                  billing_details: {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value
                  }
                }
              }
            )

            if (error) {
              throw new Error(error.message)
            }

            // Finaliser la r√©servation
            const finalizeResponse = await fetch('/api/finalizeReservation', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                token: token,
                paymentData: {
                  amount: paymentResult.amount,
                  paymentIntentId: paymentIntent.id,
                  status: paymentIntent.status
                }
              })
            })

            const finalizeResult = await finalizeResponse.json()

            if (finalizeResult.status === 'success') {
              showSuccess(
                'R√©servation finalis√©e avec succ√®s ! Vous allez recevoir un email de confirmation.'
              )
              // Rediriger vers la page de succ√®s apr√®s 3 secondes
              setTimeout(() => {
                window.location.href = '/reservation-confirmee.html'
              }, 3000)
            } else {
              throw new Error(
                finalizeResult.message || 'Erreur lors de la finalisation'
              )
            }
          } catch (error) {
            showError(error.message)
            submitButton.disabled = false
            const buttonText = document.getElementById('button-text')
            if (buttonText) {
              buttonText.textContent =
                "Payer l'acompte et confirmer ma r√©servation"
            }
          }
        })

      function showError(message) {
        const container = document.getElementById('error-container')
        container.innerHTML = `<div class="error-message">‚ùå ${message}</div>`
      }

      function showSuccess(message) {
        const container = document.getElementById('success-container')
        container.innerHTML = `<div class="success-message">‚úÖ ${message}</div>`
      }

      function escapeHtml(text) {
        const div = document.createElement('div')
        div.textContent = text
        return div.innerHTML
      }

      function formatReservationDetails(details) {
        if (!details) return 'Aucun d√©tail'
        return details.replace(/\n/g, '<br>')
      }
    </script>
  </body>
</html>
