<!DOCTYPE html>
<html>
  <head>
    <title>Finaliser ma réservation - Calypso Bay</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/custom.css" />
    <noscript
      ><link rel="stylesheet" href="assets/css/noscript.css"
    /></noscript>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      /* Styles spécifiques pour la page de finalisation */
      .form-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
      }
      .form-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        pointer-events: none;
      }
      .form-section > * {
        position: relative;
        z-index: 1;
      }
      .form-group {
        margin-bottom: 25px;
      }
      .form-group label {
        display: none;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid rgba(229, 231, 235, 0.5);
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        color: #374151;
      }
      .form-group input::placeholder,
      .form-group textarea::placeholder {
        color: #6b7280 !important;
        letter-spacing: 0.5px;
        opacity: 1;
      }
      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #5d3fd3;
        box-shadow: 0 0 0 4px rgba(93, 63, 211, 0.15);
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-2px);
      }
      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 25px;
      }
      .form-row .form-group {
        flex: 1;
        min-width: 250px;
      }
      .reservation-details {
        background: rgba(248, 250, 252, 0.1);
        padding: 10px;
        border-radius: 16px;
        border: 1px solid rgba(229, 231, 235, 0.3);
        backdrop-filter: blur(15px);
      }
      .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        font-size: 0.9rem;
        color: white;
      }
      .detail-item:last-child {
        border-bottom: none;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid rgba(255, 255, 255, 0.4);
      }
      .payment-section {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        position: relative;
      }
      .payment-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        pointer-events: none;
      }
      .payment-amount {
        text-align: center;
        margin-bottom: 30px;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 25px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 16px;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(16, 185, 129, 0.2);
      }
      .payment-amount.highlight {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }
      #card-element {
        padding: 15px;
        border: 2px solid rgba(229, 231, 235, 0.5);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }
      #card-element:focus-within {
        border-color: #5d3fd3;
        box-shadow: 0 0 0 4px rgba(93, 63, 211, 0.15);
        background: rgba(255, 255, 255, 0.95);
      }
      #card-errors {
        color: #ef4444;
        margin-top: 12px;
        font-size: 14px;
        font-weight: 500;
      }
             .btn-submit {
         background: linear-gradient(135deg, #3b82f6, #2563eb);
         color: white;
         padding: 16px 30px;
         border: none;
         border-radius: 12px;
         font-size: 18px;
         font-weight: 600;
         cursor: pointer;
         width: 100%;
         transition: all 0.3s ease;
         box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
         text-transform: uppercase;
         letter-spacing: 0.5px;
         display: flex;
         align-items: center;
         justify-content: center;
         min-height: 55px;
       }
       .btn-submit:hover {
         background: linear-gradient(135deg, #2563eb, #1d4ed8);
         transform: translateY(-3px);
         box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
       }
      .btn-submit:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #10b981;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error-message {
        background: rgba(254, 242, 242, 0.95);
        color: #ef4444;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #fecaca;
        backdrop-filter: blur(10px);
      }
      .success-message {
        background: rgba(240, 253, 244, 0.95);
        color: #10b981;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #bbf7d0;
        backdrop-filter: blur(10px);
      }
      .validation-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15) !important;
      }
      .validation-message {
        color: #ef4444;
        font-size: 12px;
        margin-top: 5px;
        font-weight: 500;
      }

             /* Styles pour l'encart de paiement */
       .payment-card {
         background: rgba(255, 255, 255, 0.1);
         border-radius: 16px;
         padding: 20px 30px;
         box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
         max-width: 600px;
         margin: 0 auto;
         backdrop-filter: blur(20px);
         border: 1px solid rgba(255, 255, 255, 0.3);
       }

             .payment-card h3 {
         color: white;
         font-size: 1.5rem;
         font-weight: bold;
         margin-bottom: 20px;
         text-align: center;
       }

             .payment-breakdown {
         margin-bottom: 20px;
       }

             .payment-row {
         display: flex;
         justify-content: space-between;
         align-items: center;
         padding: 8px 0;
         color: white;
         font-size: 1rem;
         line-height: 1.3;
       }

             .payment-row.deposit-row {
         color: #3b82f6;
         font-weight: 600;
         font-size: 1.1rem;
       }

             .payment-row.remaining-row {
         font-weight: 500;
         border-top: 1px solid rgba(255, 255, 255, 0.3);
         margin-top: 8px;
         padding-top: 12px;
       }

             .progress-bar {
         width: 100%;
         height: 8px;
         background: rgba(255, 255, 255, 0.2);
         border-radius: 4px;
         margin: 12px 0;
         overflow: hidden;
       }

       .progress-fill {
         height: 100%;
         background: #3b82f6;
         border-radius: 4px;
         transition: width 0.3s ease;
       }

             .payment-form {
         border-top: 1px solid rgba(255, 255, 255, 0.3);
         padding-top: 20px;
       }

             .payment-form .form-group {
         margin-bottom: 15px;
       }

       .payment-form label {
         display: block;
         color: white;
         font-weight: 500;
         margin-bottom: 6px;
         font-size: 0.9rem;
       }

             .payment-disclaimer {
         text-align: center;
         color: rgba(255, 255, 255, 0.8);
         font-size: 0.8rem;
         margin-top: 12px;
         line-height: 1.4;
       }

      /* Responsive design pour mobile */
      @media (max-width: 768px) {
        /* Conteneurs principaux */
        .content,
        .inner {
          padding: 0 10px;
          max-width: 100vw;
          width: 100%;
        }

        .form-section {
          padding: 15px;
          margin: 10px 0;
          max-width: 100%;
          width: 100%;
        }

        .form-row {
          flex-direction: column;
          gap: 15px;
        }
        .form-row .form-group {
          flex: none;
          min-width: 100%;
          width: 100%;
        }
        .form-group input,
        .form-group textarea {
          font-size: 16px; /* Évite le zoom sur iOS */
          padding: 12px;
          max-width: 100%;
          width: 100%;
        }
        .payment-amount {
          padding: 20px 15px;
          max-width: 100%;
          width: 100%;
        }
        .payment-amount > div {
          font-size: 1.8rem;
          max-width: 100%;
          word-break: break-word;
        }
        .btn-submit {
          padding: 15px 20px;
          font-size: 16px;
          min-height: 50px;
          max-width: 100%;
          width: 100%;
        }
        .detail-item {
          font-size: 0.85rem;
          padding: 10px 0;
          max-width: 100%;
          width: 100%;
        }
        .reservation-details {
          padding: 15px;
          max-width: 100%;
          width: 100%;
        }

        /* Forcer les largeurs maximales */
        .span-4-5,
        .span-9-5,
        .span-3-75,
        .span-1-75 {
          max-width: 100%;
          width: 100%;
        }

                 /* Responsive pour l'encart de paiement */
         .payment-card {
           padding: 15px 20px;
           margin: 0 10px;
           max-width: 100%;
           width: calc(100% - 20px);
         }

                 .payment-card h3 {
           font-size: 1.3rem;
           margin-bottom: 15px;
         }

                 .payment-row {
           font-size: 0.9rem;
           padding: 6px 0;
         }

        .payment-row.deposit-row {
          font-size: 1rem;
        }

                 .progress-bar {
           margin: 10px 0;
         }

                 .payment-form {
           padding-top: 15px;
         }

                 .payment-form .form-group {
           margin-bottom: 12px;
         }

         .payment-form label {
           font-size: 0.85rem;
           margin-bottom: 6px;
         }

        .payment-disclaimer {
          font-size: 0.75rem;
          margin-top: 12px;
        }
      }

      @media (max-width: 480px) {
        /* Conteneurs principaux */
        .content,
        .inner {
          padding: 0 5px;
          max-width: 100vw;
          width: 100%;
        }

        .form-section {
          padding: 10px;
          max-width: 100%;
          width: 100%;
        }

        .form-row {
          gap: 10px;
        }
        .payment-amount > div {
          font-size: 1.5rem;
          max-width: 100%;
          word-break: break-word;
        }
        .btn-submit {
          font-size: 14px;
          padding: 12px 15px;
          max-width: 100%;
          width: 100%;
        }
        .detail-item {
          font-size: 0.8rem;
          max-width: 100%;
          width: 100%;
        }

        /* Forcer tous les éléments à respecter la largeur */
        * {
          max-width: 100vw;
        }

        .panel,
        .content,
        .inner,
        .form-section,
        .form-row,
        .form-group,
        .payment-amount,
        .btn-submit,
        .detail-item {
          max-width: 100%;
          width: 100%;
          overflow-x: hidden;
        }

        /* Responsive pour l'encart de paiement sur très petits écrans */
        .payment-card {
          padding: 15px;
          margin: 0 5px;
          width: calc(100% - 10px);
        }

        .payment-card h3 {
          font-size: 1.2rem;
          margin-bottom: 15px;
        }

        .payment-row {
          font-size: 0.85rem;
          padding: 8px 0;
        }

        .payment-row.deposit-row {
          font-size: 0.95rem;
        }

        .progress-bar {
          margin: 10px 0;
          height: 6px;
        }

        .payment-form {
          padding-top: 15px;
        }

        .payment-form .form-group {
          margin-bottom: 12px;
        }

        .payment-form label {
          font-size: 0.8rem;
          margin-bottom: 5px;
        }

        .payment-disclaimer {
          font-size: 0.7rem;
          margin-top: 10px;
        }
      }
    </style>
  </head>
  <body class="is-preload">
    <!-- Page Wrapper -->
    <div id="page-wrapper">
      <!-- Wrapper -->
      <div id="wrapper">
        <!-- H E A D E R //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel banner right">
          <div class="content color0 span-3-75">
            <h2 class="major">
              Finaliser ma<br />
              <span class="themysion">Reservation</span>
            </h2>
            <p>
              Votre demande de réservation a été acceptée ! Complétez le
              formulaire suivant et effectuez le paiement de l'acompte de 10%
              pour confirmer votre réservation à Calypso Bay.
            </p>
            <ul class="actions">
              <li>
                <a
                  href="#form"
                  class="button primary color1 circle icon solid fa-angle-right"
                  >Commencer</a
                >
              </li>
            </ul>
          </div>
          <div class="image filtered span-1-75" data-position="25% 25%">
            <img src="images/pic01.jpg" alt="" />
          </div>
        </section>

        <!-- F O R M U L A I R E //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel spotlight medium right" id="form">
          <div class="content span-9-5">
            <h3 class="major">📋 Informations personnelles</h3>
            <p>
              Ces données nous permettront de vous contacter et de préparer
              votre accueil.
            </p>

            <div id="error-container"></div>
            <div id="success-container"></div>

            <form id="finalization-form">
              <div class="form-section">
                <div class="form-row">
                  <div class="form-group">
                    <label for="name">Nom complet</label>
                    <input
                      type="text"
                      id="name"
                      name="name"
                      placeholder="Nom complet"
                      required
                    />
                    <div class="validation-message" id="name-error"></div>
                  </div>
                  <div class="form-group">
                    <label for="email">Email</label>
                    <input
                      type="email"
                      id="email"
                      name="email"
                      placeholder="Email"
                      required
                    />
                    <div class="validation-message" id="email-error"></div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="tel">Téléphone</label>
                    <input
                      type="tel"
                      id="tel"
                      name="tel"
                      placeholder="Téléphone"
                      required
                    />
                    <div class="validation-message" id="tel-error"></div>
                  </div>
                  <div class="form-group">
                    <label for="address">Adresse</label>
                    <input
                      type="text"
                      id="address"
                      name="address"
                      placeholder="Adresse"
                      required
                    />
                    <div class="validation-message" id="address-error"></div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="city">Ville</label>
                    <input
                      type="text"
                      id="city"
                      name="city"
                      placeholder="Ville"
                      required
                    />
                    <div class="validation-message" id="city-error"></div>
                  </div>
                  <div class="form-group">
                    <label for="postal">Code postal</label>
                    <input
                      type="text"
                      id="postal"
                      name="postal"
                      placeholder="Code postal"
                      required
                    />
                    <div class="validation-message" id="postal-error"></div>
                  </div>
                </div>
                <div class="form-group">
                  <label for="country">Pays</label>
                  <input
                    type="text"
                    id="country"
                    name="country"
                    placeholder="Pays"
                    required
                  />
                  <div class="validation-message" id="country-error"></div>
                </div>
              </div>
            </form>
          </div>
          <div class="image filtered tinted" data-position="center">
            <img src="images/pic02.jpg" alt="" />
          </div>
        </section>

        <!-- Â G E S   E T   M E S S A G E //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel medium color2-alt" id="children-ages">
          <div class="intro color2">
            <h2 class="major">📝 Précisions</h2>
            <p id="section-description">
              Vous pouvez nous laisser un message ou nous poser des questions si
              vous le souhaitez.
            </p>
          </div>
          <div class="inner">
            <div class="form-section">
              <div id="children-ages-container">
                <!-- Les champs d'âges seront générés dynamiquement ici -->
              </div>
              <div class="form-group">
                <label for="message">Message (optionnel)</label>
                <textarea
                  id="message"
                  name="message"
                  placeholder="Votre message, demandes spéciales, informations complémentaires..."
                  rows="4"
                ></textarea>
                <div class="validation-message" id="message-error"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- D É T A I L S //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel medium color1">
          <div class="intro joined span-3-5">
            <h2 class="major">📅 Détails de la réservation</h2>
            <p>
              Voici un récapitulatif de votre demande de réservation. Vérifiez
              que toutes les informations sont correctes avant de procéder au
              paiement.
            </p>
          </div>
          <div class="inner">
            <div class="form-section">
              <div class="reservation-details" id="reservation-details">
                <div class="loading">
                  <div class="spinner"></div>
                  <p>Chargement des détails...</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- P A I E M E N T //////////////////////////////////////////////////////////////////////////////// -->
        <section class="panel color4-alt">
          <div class="intro color4">
            <h2 class="major">💳 Paiement de l'acompte</h2>
            <p>
              Pour confirmer votre réservation, veuillez effectuer le paiement
              de l'acompte de 10% du montant total. Le solde sera à régler au
              plus tard 7 jours avant votre arrivée.
            </p>
          </div>
          <div class="inner">
            <div class="payment-card">
              <h3>Récapitulatif du paiement</h3>
              <div class="payment-breakdown">
                <div class="payment-row">
                  <span>Total</span>
                  <span id="total-amount">Calcul en cours...</span>
                </div>
                <div class="payment-row deposit-row">
                  <span>Acompte (10%)</span>
                  <span id="deposit-amount">Calcul en cours...</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="payment-row remaining-row">
                  <span>Solde restant après acompte</span>
                  <span id="remaining-amount">Calcul en cours...</span>
                </div>
              </div>
              <div class="payment-form">
                <div class="form-group">
                  <label for="card-element">Carte de paiement</label>
                  <div id="card-element"></div>
                  <div id="card-errors" role="alert"></div>
                </div>
                <button
                  type="submit"
                  class="btn-submit"
                  id="submit-button"
                  form="finalization-form"
                >
                  <span id="button-text"
                    >Payer l'acompte et confirmer ma réservation</span
                  >
                </button>
                <p class="payment-disclaimer">
                  Paiement sécurisé via Stripe. Aucune donnée bancaire n'est
                  stockée par Calypso Bay.
                </p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
      // Initialiser Stripe
      const stripe = Stripe(
        'pk_live_51RuYagJuxMM0V1wvWkNbfWITDKf6J6Q8BaoCPCwWrd6juAMlGekc3RADsm9VfcFcfkk7dYmY8dgDr0DqHOBw3qtb006Bbqn4e4'
      )
      const elements = stripe.elements()
      const card = elements.create('card', {
        style: {
          base: {
            fontSize: '16px',
            color: '#424770',
            '::placeholder': {
              color: '#aab7c4'
            }
          }
        }
      })
      card.mount('#card-element')

      // Gestion des erreurs de carte
      card.addEventListener('change', function (event) {
        const displayError = document.getElementById('card-errors')
        if (event.error) {
          displayError.textContent = event.error.message
        } else {
          displayError.textContent = ''
        }
      })

      // Récupérer le token depuis l'URL
      const urlParams = new URLSearchParams(window.location.search)
      const token = urlParams.get('token')

      if (!token) {
        showError('Token de réservation manquant')
      } else {
        // Charger les données de réservation
        loadReservationData()
      }

      // Validation des champs
      function validateField(fieldId, errorId, validationFn) {
        const field = document.getElementById(fieldId)
        const errorElement = document.getElementById(errorId)
        const value = field.value.trim()

        field.classList.remove('validation-error')
        errorElement.textContent = ''

        if (!validationFn(value)) {
          field.classList.add('validation-error')
          errorElement.textContent = 'Ce champ est obligatoire'
          return false
        }
        return true
      }

      function validateEmail(email) {
        return email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)
      }

      function validatePhone(phone) {
        return phone && phone.length >= 10
      }

      function validateRequired(value) {
        return value && value.length > 0
      }

      // Validation en temps réel
      document.getElementById('name').addEventListener('blur', () => {
        validateField('name', 'name-error', validateRequired)
      })

      document.getElementById('email').addEventListener('blur', () => {
        validateField('email', 'email-error', validateEmail)
      })

      document.getElementById('tel').addEventListener('blur', () => {
        validateField('tel', 'tel-error', validatePhone)
      })

      document.getElementById('address').addEventListener('blur', () => {
        validateField('address', 'address-error', validateRequired)
      })

      document.getElementById('city').addEventListener('blur', () => {
        validateField('city', 'city-error', validateRequired)
      })

      document.getElementById('postal').addEventListener('blur', () => {
        validateField('postal', 'postal-error', validateRequired)
      })

      document.getElementById('message').addEventListener('blur', () => {
        // Le message est optionnel, donc pas de validation stricte
        const messageField = document.getElementById('message')
        const messageError = document.getElementById('message-error')
        messageField.classList.remove('validation-error')
        messageError.textContent = ''
      })

      async function loadReservationData() {
        try {
          console.log('Loading reservation data for token:', token)
          const response = await fetch(
            `/api/getReservation?token=${encodeURIComponent(token)}`
          )
          const result = await response.json()

          console.log('API Response:', JSON.stringify(result, null, 2))

          if (result.status === 'success') {
            console.log(
              'Reservation data received:',
              JSON.stringify(result.data, null, 2)
            )
            // Stocker les données globalement pour la validation
            window.reservationData = result.data
            populateForm(result.data)
            calculatePaymentAmount(result.data)
          } else {
            showError(result.message || 'Erreur lors du chargement des données')
          }
        } catch (error) {
          showError('Erreur de connexion')
          console.error('Erreur:', error)
        }
      }

      function populateForm(data) {
        console.log(
          'populateForm called with data:',
          JSON.stringify(data, null, 2)
        )

        document.getElementById('name').value = data.name || ''
        document.getElementById('email').value = data.email || ''
        document.getElementById('tel').value = data.tel || ''

        // Générer les champs d'âges des enfants
        generateChildrenAgeFields(data.nbChilds || 0)

        // Afficher les détails de réservation
        const detailsContainer = document.getElementById('reservation-details')

        // Créer les détails de réservation avec la structure appropriée
        const reservationDetails = formatReservationDetails(data)

        // Regrouper les sections dans des spans séparés
        const sections = reservationDetails.split('<hr')
        const detailsHtml = sections
          .map((section, index) => {
            if (section.trim()) {
              // Nettoyer les balises hr et créer un span pour chaque section
              const cleanSection = section.replace(/^[^>]*>/, '').trim()
              if (cleanSection) {
                return `<div class="detail-item"><span>${cleanSection}</span></div>`
              }
            }
            return ''
          })
          .join('')

        detailsContainer.innerHTML = detailsHtml
      }

      // Fonction pour générer dynamiquement les champs d'âges des enfants
      function generateChildrenAgeFields(nbChildren) {
        const container = document.getElementById('children-ages-container')
        const sectionDescription = document.getElementById(
          'section-description'
        )

        if (nbChildren === 0) {
          container.innerHTML = ''
          sectionDescription.innerHTML =
            'Vous pouvez nous laisser un message ou nous poser des questions si vous le souhaitez.'
          return
        }

        // Mettre à jour la description pour inclure le message sur les enfants
        sectionDescription.innerHTML =
          'Vous pouvez nous laisser un message ou nous poser des questions si vous le souhaitez.<br><br><div style="background: rgba(255, 193, 7, 0.2); border: 1px solid rgba(255, 193, 7, 0.5); border-radius: 8px; padding: 12px; margin-top: 15px; display: flex; align-items: center; gap: 8px;"><span style="color: #856404; font-size: 16px;">⚠️</span><span style="color: #856404; font-weight: 500;">Rappel : les enfants de moins de 8 ans ne sont pas admis.</span></div>'

        let html = ''

        for (let i = 1; i <= nbChildren; i++) {
          html += `
            <div class="form-group">
              <label for="child-age-${i}">Âge de l'enfant ${i}</label>
              <input
                type="number"
                id="child-age-${i}"
                name="child-age-${i}"
                placeholder="Âge de l'enfant ${i}"
                min="0"
                max="17"
                required
              />
              <div class="validation-message" id="child-age-${i}-error"></div>
            </div>
          `
        }

        container.innerHTML = html

        // Ajouter la validation pour les nouveaux champs
        for (let i = 1; i <= nbChildren; i++) {
          document
            .getElementById(`child-age-${i}`)
            .addEventListener('blur', () => {
              validateField(
                `child-age-${i}`,
                `child-age-${i}-error`,
                validateChildAge
              )
            })
        }
      }

      // Fonction de validation pour l'âge des enfants
      function validateChildAge(age) {
        const ageNum = parseInt(age)
        return age && ageNum >= 0 && ageNum <= 17
      }

      function calculatePaymentAmount(data) {
        console.log('Calculating payment for data:', data)

        // Utiliser directement le champ total structuré
        let totalAmount = data.priceTotal

        console.log('Using structured total:', totalAmount)

        if (totalAmount && totalAmount > 0) {
          const depositAmount = totalAmount * 0.1
          const remainingAmount = totalAmount - depositAmount

          console.log('Calculated deposit:', depositAmount)
          console.log('Remaining amount:', remainingAmount)

          // Mettre à jour les éléments du récapitulatif
          document.getElementById(
            'total-amount'
          ).textContent = `${totalAmount.toFixed(2)} €`
          document.getElementById(
            'deposit-amount'
          ).textContent = `${depositAmount.toFixed(2)} €`
          document.getElementById(
            'remaining-amount'
          ).textContent = `${remainingAmount.toFixed(2)} €`

          // Mettre à jour la barre de progression
          const progressFill = document.getElementById('progress-fill')
          const progressPercentage = (depositAmount / totalAmount) * 100
          progressFill.style.width = `${progressPercentage}%`

          // Mettre à jour le texte du bouton avec le montant
          const buttonText = document.getElementById('button-text')
          if (buttonText) {
            const newButtonText = `Payer l'acompte – ${depositAmount.toFixed(
              2
            )} €`
            buttonText.textContent = newButtonText
            console.log('Button text updated to:', newButtonText)
          } else {
            console.error('Button text element not found')
          }

          // Stocker le montant total pour le paiement
          window.totalAmount = totalAmount
        } else {
          document.getElementById('total-amount').textContent =
            'Calcul en cours...'
          document.getElementById('deposit-amount').textContent =
            'Calcul en cours...'
          document.getElementById('remaining-amount').textContent =
            'Calcul en cours...'
          console.log('No valid amount found in structured data')
        }
      }

      // Gestion de la soumission du formulaire
      document
        .getElementById('finalization-form')
        .addEventListener('submit', async function (event) {
          event.preventDefault()

          // Validation complète avant soumission
          const validations = [
            validateField('name', 'name-error', validateRequired),
            validateField('email', 'email-error', validateEmail),
            validateField('tel', 'tel-error', validatePhone),
            validateField('address', 'address-error', validateRequired),
            validateField('city', 'city-error', validateRequired),
            validateField('postal', 'postal-error', validateRequired)
          ]

          // Ajouter la validation des âges des enfants si nécessaire
          const nbChildren = window.reservationData?.nbChilds || 0
          for (let i = 1; i <= nbChildren; i++) {
            validations.push(
              validateField(
                `child-age-${i}`,
                `child-age-${i}-error`,
                validateChildAge
              )
            )
          }

          if (!validations.every((v) => v)) {
            showError('Veuillez corriger les erreurs dans le formulaire')
            return
          }

          const submitButton = document.getElementById('submit-button')
          submitButton.disabled = true
          submitButton.textContent = 'Traitement en cours...'

          try {
            // Créer le PaymentIntent
            const paymentResponse = await fetch('/api/createPaymentIntent', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                token: token,
                totalAmount: window.totalAmount
              })
            })

            const paymentResult = await paymentResponse.json()

            if (!paymentResult.clientSecret) {
              throw new Error(
                paymentResult.error || 'Erreur lors de la création du paiement'
              )
            }

            // Confirmer le paiement avec Stripe
            const { error, paymentIntent } = await stripe.confirmCardPayment(
              paymentResult.clientSecret,
              {
                payment_method: {
                  card: card,
                  billing_details: {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value
                  }
                }
              }
            )

            if (error) {
              throw new Error(error.message)
            }

            // Finaliser la réservation
            const finalizeResponse = await fetch('/api/finalizeReservation', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                token: token,
                paymentData: {
                  amount: paymentResult.amount,
                  paymentIntentId: paymentIntent.id,
                  status: paymentIntent.status
                }
              })
            })

            const finalizeResult = await finalizeResponse.json()

            if (finalizeResult.status === 'success') {
              showSuccess(
                'Réservation finalisée avec succès ! Vous allez recevoir un email de confirmation.'
              )
              // Rediriger vers la page de succès après 3 secondes
              setTimeout(() => {
                window.location.href = '/reservation-confirmee.html'
              }, 3000)
            } else {
              throw new Error(
                finalizeResult.message || 'Erreur lors de la finalisation'
              )
            }
          } catch (error) {
            showError(error.message)
            submitButton.disabled = false
            // Remettre le texte du bouton avec le montant de l'acompte
            if (window.totalAmount) {
              const depositAmount = window.totalAmount * 0.1
              const buttonText = document.getElementById('button-text')
              if (buttonText) {
                buttonText.textContent = `Payer l'acompte – ${depositAmount.toFixed(
                  2
                )} €`
              }
            }
          }
        })

      function showError(message) {
        const container = document.getElementById('error-container')
        container.innerHTML = `<div class="error-message">❌ ${message}</div>`
      }

      function showSuccess(message) {
        const container = document.getElementById('success-container')
        container.innerHTML = `<div class="success-message">✅ ${message}</div>`
      }

      function escapeHtml(text) {
        const div = document.createElement('div')
        div.textContent = text
        return div.innerHTML
      }

      function formatReservationDetails(data) {
        console.log(
          'formatReservationDetails called with data:',
          JSON.stringify(data, null, 2)
        )

        if (!data) return 'Aucun détail'

        const startDate = new Date(data.startDate)
        const endDate = new Date(data.endDate)

        console.log('Parsed dates:', {
          startDate: startDate.toString(),
          endDate: endDate.toString(),
          startDateValue: data.startDate,
          endDateValue: data.endDate
        })

        const formatDate = (date) => {
          return date.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
          })
        }

        // Section Dates
        const startDateStr = formatDate(startDate)
        const endDateStr = formatDate(endDate)
        const datesSection = `<strong>Dates :</strong> ${startDateStr} au ${endDateStr} (${data.nbNights} nuits)`

        // Section Voyageurs
        let travelersSection
        if (data.nbChilds > 0) {
          travelersSection = `<strong>Voyageurs :</strong> ${
            data.nbAdults
          } adulte${data.nbAdults > 1 ? 's' : ''}, ${data.nbChilds} enfant${
            data.nbChilds > 1 ? 's' : ''
          }`
        } else {
          travelersSection = `<strong>Voyageurs :</strong> ${
            data.nbAdults
          } adulte${data.nbAdults > 1 ? 's' : ''}`
        }

        // Section Détail du prix
        let priceDetails = ['<strong>Détail du prix :</strong>']

        if (data.priceNights > 0) {
          priceDetails.push(
            `&nbsp;&nbsp;&nbsp;&nbsp;• Total des nuits (${
              data.nbNights
            }) : ${data.priceNights.toLocaleString('fr-FR')} €`
          )
        }

        if (data.priceClean > 0) {
          priceDetails.push(
            `&nbsp;&nbsp;&nbsp;&nbsp;• Frais de ménage : ${data.priceClean.toLocaleString(
              'fr-FR'
            )} €`
          )
        }

        if (data.priceTax > 0) {
          priceDetails.push(
            `&nbsp;&nbsp;&nbsp;&nbsp;• Taxes (${data.nbAdults} adulte${
              data.nbAdults > 1 ? 's' : ''
            }) : ${data.priceTax.toLocaleString('fr-FR')} €`
          )
        }

        if (data.priceTotal > 0) {
          priceDetails.push(
            `&nbsp;&nbsp;&nbsp;&nbsp;• <strong>Total : ${data.priceTotal.toLocaleString(
              'fr-FR'
            )} €</strong>`
          )
        }

        const priceSection = priceDetails.join('<br>')

        // Assembler les sections avec un seul séparateur entre dates et voyageurs
        const result = `${datesSection}<hr style="border: none; border-top: 1px solid rgba(255,255,255,0.3); margin: 0.5rem 0;" />${travelersSection}<br><br>${priceSection}`

        console.log('formatReservationDetails result:', result)
        return result
      }
    </script>
  </body>
</html>
