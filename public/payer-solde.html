<!DOCTYPE html>
<html>
  <head>
    <title>Payer le solde â€“ Calypso Bay</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/custom.css" />
    <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      .form-section { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; box-shadow: 0 12px 40px rgba(0,0,0,0.15); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.3); }
      .summary { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.25); border-radius: 12px; padding: 16px; margin-top: 16px; color: white; }
      .btn-submit { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 14px 24px; border: none; border-radius: 12px; font-weight: 600; width: 100%; display: flex; align-items: center; justify-content: center; min-height: 50px; box-shadow: 0 6px 20px rgba(59,130,246,0.3); }
      .btn-submit:disabled { background: #9ca3af; }
      #card-errors { color: #ef4444; margin-top: 10px; font-size: 0.9rem; }
    </style>
  </head>
  <body class="is-preload">
    <div id="page-wrapper">
      <div id="wrapper">
        <section class="panel banner right">
          <div class="content color0 span-3-75">
            <h2 class="major">Payer le<br /><span class="themysion">Solde</span></h2>
            <p>Renseignez votre carte pour rÃ©gler le solde restant de votre rÃ©servation.</p>
            <ul class="actions"><li><a href="#form" class="button primary color1 circle icon solid fa-angle-right">Continuer</a></li></ul>
          </div>
          <div class="image filtered span-1-75" data-position="25% 25%"><img src="images/pic01.jpg" alt="" /></div>
        </section>

        <section class="panel spotlight medium right" id="form">
          <div class="content span-9-5">
            <h3 class="major">ðŸ’³ Paiement du solde</h3>
            <div id="messages"></div>
            <div class="form-section">
              <div class="summary" id="recap">Chargement en coursâ€¦</div>
              <div style="margin-top:16px">
                <label for="card-element" style="color:white; font-weight:600;">Carte de paiement</label>
                <div id="card-element" style="background: rgba(255,255,255,0.9); border-radius: 10px; padding: 12px;"></div>
                <div id="card-errors" role="alert"></div>
              </div>
              <button id="pay-btn" class="btn-submit" style="margin-top:16px"><span id="btn-text">Payer le solde</span></button>
            </div>
          </div>
          <div class="image filtered tinted" data-position="center"><img src="images/pic02.jpg" alt="" /></div>
        </section>

        <div class="copyright"><span>&copy; Calypso Bay | By</span> <a href="https://moriarty-design.fr" target="_blank" rel="noopener" style="font-family: 'Engagement', 'Brush Script MT', cursive; font-size: 2.2em; line-height: 1; margin-left: 0.25em; text-decoration: none; color: inherit;">Moriarty</a>.</div>
      </div>
    </div>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script>
      const stripe = Stripe('%STRIPE_PUBLIC_KEY%'.replace('%STRIPE_PUBLIC_KEY%', 'pk_live_51RuYagJuxMM0V1wvWkNbfWITDKf6J6Q8BaoCPCwWrd6juAMlGekc3RADsm9VfcFcfkk7dYmY8dgDr0DqHOBw3qtb006Bbqn4e4'))
      const elements = stripe.elements()
      const card = elements.create('card', { style: { base: { fontSize: '16px' } } })
      card.mount('#card-element')
      card.addEventListener('change', function (event) { const displayError = document.getElementById('card-errors'); displayError.textContent = event.error ? event.error.message : '' })

      const params = new URLSearchParams(window.location.search)
      const token = params.get('token')
      const recap = document.getElementById('recap')
      const btn = document.getElementById('pay-btn')
      const btnText = document.getElementById('btn-text')

      async function load() {
        if (!token) { recap.textContent = 'Token manquant'; btn.disabled = true; return }
        try {
          const res = await fetch(`/api/getReservation?token=${encodeURIComponent(token)}&stage=balance`)
          const json = await res.json()
          if (json.status !== 'success') { recap.textContent = json.message || 'RÃ©servation introuvable'; btn.disabled = true; return }
          const d = json.data
          const total = Number(d.priceTotal || 0)
          const deposit = Number(d.depositAmount || 0)
          const balance = Math.max(0, total - deposit)
          recap.innerHTML = `
            <div><strong>Nom:</strong> ${d.name || ''}</div>
            <div><strong>Dates:</strong> ${d.startDate} â†’ ${d.endDate} (${d.nbNights || 0} nuits)</div>
            <div><strong>Total:</strong> ${total.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})} â‚¬</div>
            <div><strong>Acompte:</strong> ${deposit.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})} â‚¬</div>
            <div><strong>Solde Ã  payer:</strong> <span style="font-weight:700;">${balance.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})} â‚¬</span></div>
          `
          btnText.textContent = `Payer le solde â€“ ${balance.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})} â‚¬`
        } catch (e) { recap.textContent = 'Erreur de chargement' }
      }

      load()

      btn.addEventListener('click', async () => {
        if (!token) return
        btn.disabled = true; btnText.textContent = 'CrÃ©ation du paiementâ€¦'
        try {
          const piRes = await fetch('/api/createBalancePaymentIntent', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token }) })
          const piJson = await piRes.json()
          if (!piRes.ok || !piJson.clientSecret) throw new Error(piJson.error || 'Erreur crÃ©ation paiement')
          btnText.textContent = 'Confirmationâ€¦'
          const { error, paymentIntent } = await stripe.confirmCardPayment(piJson.clientSecret, { payment_method: { card } })
          if (error) throw new Error(error.message)
          btnText.textContent = 'Paiement confirmÃ© âœ”'
        } catch (e) {
          document.getElementById('card-errors').textContent = e.message
          btn.disabled = false; btnText.textContent = 'Payer le solde'
        }
      })
    </script>
  </body>
</html>


