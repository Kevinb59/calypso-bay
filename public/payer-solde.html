<!DOCTYPE html>
<html>
  <head>
    <title>Payer le solde â€“ Calypso Bay</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <!-- Favicons -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="images/logos/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="images/logos/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="images/logos/favicons/favicon-16x16.png"
    />
    <link rel="manifest" href="manifest.json" />
    <link rel="shortcut icon" href="images/logos/favicons/favicon.ico" />

    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/custom.css" />
    <noscript
      ><link rel="stylesheet" href="assets/css/noscript.css"
    /></noscript>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      .form-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .reservation-details {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
        color: white;
      }
      .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.25);
        font-size: 0.95rem;
      }
      .detail-item:last-child {
        border-bottom: none;
        margin-top: 10px;
        padding-top: 10px;
      }
      .payment-card {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
        color: white;
        position: relative;
      }
      .payment-lock {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(3px);
        background: rgba(17, 24, 39, 0.35);
        z-index: 5;
      }
      .payment-lock .lock-box {
        background: rgba(255, 255, 255, 0.95);
        color: #111827;
        padding: 14px 18px;
        border-radius: 12px;
        font-weight: 700;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      }
      .payment-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
      }
      .payment-row.deposit {
        color: #3b82f6;
        font-weight: 600;
      }
      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 4px;
        overflow: hidden;
        margin: 8px 0 12px;
      }
      .progress-fill {
        height: 100%;
        width: 0%;
        background: #3b82f6;
        transition: width 0.3s ease;
      }
      .btn-submit {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        padding: 14px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 50px;
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
      }
      .btn-submit:disabled {
        background: #9ca3af;
      }
      #card-errors {
        color: #ef4444;
        margin-top: 10px;
        font-size: 0.9rem;
      }
      .payment-disclaimer {
        text-align: center;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.85rem;
        margin-top: 10px;
      }

      /* Styles pour le sÃ©lecteur de langue */
      .language-selector {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
      }
      .language-selector select {
        border: none;
        background: transparent;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
      }
      .language-selector select:focus {
        outline: none;
        background: rgba(59, 130, 246, 0.1);
      }
    </style>
  </head>
  <body class="is-preload">
    <!-- SÃ©lecteur de langue -->
    <div class="language-selector">
      <select id="language-selector">
        <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
        <option value="en">ðŸ‡¬ðŸ‡§ English</option>
        <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
      </select>
    </div>

    <div id="page-wrapper">
      <div id="wrapper">
        <section class="panel banner right">
          <div class="content color0 span-3-75">
            <h2 class="major">
              <span id="banner-title">Payer le</span><br /><span
                class="themysion"
                id="banner-subtitle"
                >Solde</span
              >
            </h2>
            <p id="banner-description">
              Pour finaliser votre rÃ©servation, veuillez rÃ©gler le solde
              restant.
            </p>
            <ul class="actions">
              <li>
                <a
                  href="#form"
                  class="button primary color1 circle icon solid fa-angle-right"
                  id="banner-button"
                  >Continuer</a
                >
              </li>
            </ul>
          </div>
          <div class="image filtered span-1-75" data-position="25% 25%">
            <img src="images/pic01.webp" alt="Vue de Calypso Bay" />
          </div>
        </section>

        <!-- DÃ©tails de la rÃ©servation (section sÃ©parÃ©e) -->
        <section class="panel spotlight medium right color1" id="details">
          <div class="intro joined span-3-5">
            <h2 class="major" id="details-title">
              ðŸ“… DÃ©tails de la rÃ©servation
            </h2>
            <p id="details-description">
              VÃ©rifiez les informations de votre sÃ©jour avant de procÃ©der au
              paiement du solde.
            </p>
          </div>
          <div class="inner">
            <div class="form-section">
              <div class="reservation-details" id="reservation-details">
                <span id="details-loading">Chargement en coursâ€¦</span>
              </div>
            </div>
          </div>
          <div class="image filtered tinted" data-position="center">
            <img src="images/pic02.webp" alt="Vue panoramique de Calypso Bay" />
          </div>
        </section>

        <!-- Paiement du solde (section dÃ©diÃ©e) -->
        <section class="panel color4-alt" id="form">
          <div class="intro color4">
            <h2 class="major" id="payment-title">ðŸ’³ Paiement du solde</h2>
            <p id="payment-description">
              Renseignez votre carte pour rÃ©gler le solde restant de votre
              rÃ©servation.
            </p>
          </div>
          <div class="inner">
            <div class="payment-card">
              <div class="payment-lock" id="balance-lock">
                <div class="lock-box" id="balance-lock-text"></div>
              </div>
              <h4 style="margin: 0 0 10px 0" id="payment-summary-title">
                RÃ©capitulatif du paiement
              </h4>
              <div class="payment-row">
                <span id="payment-total-label">Total</span
                ><span id="total-amount">â€”</span>
              </div>
              <div class="payment-row deposit">
                <span
                  ><span id="payment-deposit-label">Acompte dÃ©jÃ  versÃ©</span>
                  (<span id="deposit-percent">0%</span>)</span
                ><span id="deposit-amount">â€”</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <div
                class="payment-row"
                style="
                  border-top: 1px solid rgba(255, 255, 255, 0.25);
                  padding-top: 12px;
                  margin-top: 4px;
                "
              >
                <span id="payment-remaining-label">Solde restant</span
                ><span id="remaining-amount">â€”</span>
              </div>

              <div style="margin-top: 16px">
                <label
                  for="card-element"
                  style="color: white; font-weight: 600"
                  id="card-label"
                  >Carte de paiement</label
                >
                <div
                  id="card-element"
                  style="
                    background: rgba(255, 255, 255, 0.9);
                    border-radius: 10px;
                    padding: 12px;
                  "
                ></div>
                <div id="card-errors" role="alert"></div>
              </div>
              <button id="pay-btn" class="btn-submit" style="margin-top: 16px">
                <span id="submit-button-text">Payer le solde</span>
              </button>
              <p class="payment-disclaimer" id="payment-disclaimer">
                Paiement sÃ©curisÃ© via Stripe. Aucune donnÃ©e bancaire n'est
                stockÃ©e par Calypso Bay.
              </p>
            </div>
          </div>
        </section>

        <div class="copyright">
          <span>&copy; Calypso Bay | By</span>
          <a
            href="https://moriarty-design.fr"
            target="_blank"
            rel="noopener"
            style="
              font-family: 'Engagement', 'Brush Script MT', cursive;
              font-size: 2.2em;
              line-height: 1;
              margin-left: 0.25em;
              text-decoration: none;
              color: inherit;
            "
            >Moriarty</a
          >.
        </div>
      </div>
    </div>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/translations.js"></script>
    <script>
      // ============================================================================
      // SYSTÃˆME DE TRADUCTION
      // ============================================================================

      let currentLang = 'fr'

      // Initialiser les traductions au chargement
      window.addEventListener('translations:ready', function (event) {
        const detectedLang = event.detail.language
        currentLang = detectedLang
        translatePage(detectedLang)
      })

      // GÃ©rer le changement de langue via le sÃ©lecteur
      document.addEventListener('DOMContentLoaded', function () {
        const languageSelector = document.querySelector('#language-selector')
        if (languageSelector) {
          languageSelector.addEventListener('change', function () {
            const newLang = this.value

            // Sauvegarder la prÃ©fÃ©rence de langue
            localStorage.setItem('calypso-bay-lang', newLang)

            // Rediriger vers la nouvelle URL avec le bon paramÃ¨tre de langue
            const url = new URL(window.location)
            url.searchParams.set('lang', newLang)
            window.location.href = url.toString()
          })

          // Charger la prÃ©fÃ©rence de langue sauvegardÃ©e
          const savedLang = localStorage.getItem('calypso-bay-lang')
          if (savedLang && ['fr', 'en', 'de'].includes(savedLang)) {
            languageSelector.value = savedLang
          }
        }
      })

      // ============================================================================
      // LOGIQUE PRINCIPALE DE LA PAGE
      // ============================================================================

      // Configuration Stripe et crÃ©ation des Ã©lÃ©ments de paiement
      const stripe = Stripe(
        '%STRIPE_PUBLIC_KEY%'.replace(
          '%STRIPE_PUBLIC_KEY%',
          'pk_live_51RuYagJuxMM0V1wvWkNbfWITDKf6J6Q8BaoCPCwWrd6juAMlGekc3RADsm9VfcFcfkk7dYmY8dgDr0DqHOBw3qtb006Bbqn4e4'
        )
      )
      const elements = stripe.elements()
      const card = elements.create('card', {
        style: { base: { fontSize: '16px' } }
      })
      card.mount('#card-element')

      // Gestion des erreurs de la carte de paiement
      card.addEventListener('change', function (event) {
        const displayError = document.getElementById('card-errors')
        displayError.textContent = event.error ? event.error.message : ''
      })

      // Variables principales de la page
      const params = new URLSearchParams(window.location.search)
      const token = params.get('token')
      const detailsBox = document.getElementById('reservation-details')
      const btn = document.getElementById('pay-btn')
      const btnText = document.getElementById('submit-button-text')

      // ============================================================================
      // FONCTIONS DE TRADUCTION
      // ============================================================================

      /**
       * Traduit l'ensemble de la page dans la langue spÃ©cifiÃ©e
       * @param {string} lang - Code de langue (fr, en, de)
       */
      function translatePage(lang) {
        currentLang = lang
        const t = window.translations[lang]['payer-solde']
        const common = window.translations[lang].common

        // Mettre Ã  jour le titre de la page
        document.title = t.title

        // Traduire la banniÃ¨re principale
        document.getElementById('banner-title').textContent = t.banner.title
        document.getElementById('banner-subtitle').textContent =
          t.banner.subtitle
        document.getElementById('banner-description').textContent =
          t.banner.description
        document.getElementById('banner-button').textContent = t.banner.button

        // Traduire la section dÃ©tails de la rÃ©servation
        document.getElementById('details-title').textContent = t.details.title
        document.getElementById('details-description').textContent =
          t.details.description
        document.getElementById('details-loading').textContent =
          t.details.loading

        // Traduire la section paiement
        document.getElementById('payment-title').textContent = t.payment.title
        document.getElementById('payment-description').textContent =
          t.payment.description
        document.getElementById('payment-summary-title').textContent =
          t.payment.summary_title
        document.getElementById('payment-total-label').textContent =
          t.payment.total
        document.getElementById('payment-deposit-label').textContent =
          t.payment.deposit_paid.replace('{percent}', '')
        document.getElementById('payment-remaining-label').textContent =
          t.payment.remaining
        document.getElementById('card-label').textContent = t.payment.card_label
        document.getElementById('submit-button-text').textContent =
          t.payment.submit_button
        document.getElementById('payment-disclaimer').textContent =
          t.payment.disclaimer

        // Mettre Ã  jour le sÃ©lecteur de langue
        if (document.querySelector('#language-selector')) {
          document.querySelector('#language-selector').value = lang
        }

        // Mettre Ã  jour l'URL avec la nouvelle langue
        const url = new URL(window.location)
        url.searchParams.set('lang', lang)
        window.history.replaceState({}, '', url)

        // Mettre Ã  jour les traductions aprÃ¨s chargement des donnÃ©es
        updateTranslationsAfterLoad()
      }

      // Fonction pour traduire les Ã©lÃ©ments dynamiques du rÃ©capitulatif
      function translateRecapContent(data, lang) {
        const common = window.translations[lang].common
        const fmtMoney = (v) =>
          Number(v || 0).toLocaleString(
            lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-GB' : 'fr-FR',
            {
              minimumFractionDigits: 1,
              maximumFractionDigits: 1
            }
          )
        const fmtMoney2 = (v) =>
          Number(v || 0).toLocaleString(
            lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-GB' : 'fr-FR',
            {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            }
          )
        const s = new Date(data.startDate)
        const e = new Date(data.endDate)
        const fmtDate = (dt) =>
          dt.toLocaleDateString(
            lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-GB' : 'fr-FR',
            {
              day: '2-digit',
              month: 'long',
              year: 'numeric'
            }
          )

        const ages =
          Array.isArray(data.childrenAges) && data.childrenAges.length
            ? data.childrenAges.join(', ')
            : ''

        const lines = []
        lines.push(
          `<div class="detail-item"><strong>${
            common.dates
          }</strong> <span>${fmtDate(s)} ${
            lang === 'de' ? 'bis' : lang === 'en' ? 'to' : 'au'
          } ${fmtDate(e)} (${data.nbNights} ${common.nights})</span></div>`
        )

        const adultText =
          data.nbAdults > 1 ? common.adults_plural : common.adults
        const childText =
          data.nbChilds > 1 ? common.children_plural : common.children
        lines.push(
          `<div class="detail-item"><strong>${
            common.travelers
          }</strong> <span>${data.nbAdults} ${adultText}${
            data.nbChilds > 0 ? `, ${data.nbChilds} ${childText}` : ''
          }</span></div>`
        )

        if (data.nbChilds > 0 && ages) {
          lines.push(
            `<div class="detail-item"><strong>${common.children_ages}</strong> <span>${ages}</span></div>`
          )
        }

        lines.push(
          `<div class="detail-item" style="border-bottom:none; display:block; padding-bottom:0;">
            <div><strong>${common.price_details}</strong></div>
            <div style="padding-top:8px">â€¢ ${common.nights_total.replace(
              '{count}',
              data.nbNights
            )} ${fmtMoney(data.priceNights)} ${common.currency}</div>
            <div>â€¢ ${common.cleaning_fees} ${fmtMoney(data.priceClean)} ${
            common.currency
          }</div>
            <div>â€¢ ${common.taxes
              .replace('{count}', data.nbAdults)
              .replace('{adult_text}', adultText)} ${fmtMoney(data.priceTax)} ${
            common.currency
          }</div>
            <div>â€¢ <strong>${common.total} ${fmtMoney(data.priceTotal)} ${
            common.currency
          }</strong></div>
          </div>`
        )

        if (data.address || data.city || data.postal || data.country) {
          lines.push(
            `<div class="detail-item" style="border-bottom:none; display:block; padding-bottom:0;">
              <div><strong>${common.billing_address}</strong></div>
              <div style="padding-top:8px">${data.address || ''}</div>
              <div>${data.postal || ''} ${data.city || ''}</div>
              <div>${data.country || ''}</div>
            </div>`
          )
        }

        return lines.join('')
      }

      /**
       * Met Ã  jour les traductions des Ã©lÃ©ments dynamiques aprÃ¨s changement de langue
       * Cette fonction est appelÃ©e quand les donnÃ©es de rÃ©servation sont dÃ©jÃ  chargÃ©es
       */
      function updateTranslationsAfterLoad() {
        if (window.reservationData) {
          // Mettre Ã  jour le rÃ©capitulatif si les donnÃ©es sont dÃ©jÃ  chargÃ©es
          const recapEl = document.getElementById('reservation-details')
          if (recapEl && !recapEl.textContent.includes('Chargement')) {
            recapEl.innerHTML = translateRecapContent(
              window.reservationData,
              currentLang
            )
          }

          // Mettre Ã  jour les messages de verrouillage si ils sont affichÃ©s
          const lock = document.getElementById('balance-lock')
          const lockText = document.getElementById('balance-lock-text')
          if (lock && lockText && lock.style.display === 'flex') {
            const t = window.translations[currentLang]['payer-solde']
            const st = String(window.reservationData.status || '')

            if (st === 'balancePay') {
              lockText.textContent = t.locks.balance_paid
            } else if (st === 'canceled') {
              lockText.textContent = t.locks.reservation_canceled
            }
          }

          // Mettre Ã  jour les montants de paiement avec la nouvelle langue
          if (window.reservationData) {
            const total = Number(window.reservationData.priceTotal || 0)
            const deposit = Number(window.reservationData.depositAmount || 0)
            const balance = Math.max(0, total - deposit)

            const locale =
              currentLang === 'de'
                ? 'de-DE'
                : currentLang === 'en'
                ? 'en-GB'
                : 'fr-FR'

            document.getElementById(
              'total-amount'
            ).textContent = `${total.toLocaleString(locale, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })} â‚¬`

            document.getElementById(
              'deposit-amount'
            ).textContent = `${deposit.toLocaleString(locale, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })} â‚¬`

            document.getElementById(
              'remaining-amount'
            ).textContent = `${balance.toLocaleString(locale, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })} â‚¬`

            // Mettre Ã  jour le texte du bouton avec le montant
            const t = window.translations[currentLang]['payer-solde']
            const buttonTextTemplate = t.payment.submit_button_with_amount
            const btnText = document.getElementById('submit-button-text')
            if (btnText) {
              btnText.textContent = buttonTextTemplate.replace(
                '{amount}',
                balance.toLocaleString(locale, {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                })
              )
            }
          }
        }
      }

      /**
       * Charge et affiche les donnÃ©es de la rÃ©servation
       * GÃ¨re les erreurs et met Ã  jour l'interface utilisateur
       */
      async function load() {
        if (!token) {
          const t = window.translations[currentLang]['payer-solde']
          detailsBox.textContent = t.errors.missing_token
          btn.disabled = true
          return
        }
        try {
          const res = await fetch(
            `/api/reservations?action=get&token=${encodeURIComponent(token)}`
          )
          const json = await res.json()
          if (json.status !== 'success') {
            const t = window.translations[currentLang]['payer-solde']
            detailsBox.textContent =
              json.message || t.errors.reservation_not_found
            btn.disabled = true
            return
          }
          const d = json.data
          const total = Number(d.priceTotal || 0)
          const deposit = Number(d.depositAmount || 0)
          const balance = Math.max(0, total - deposit)

          // Sauvegarder les donnÃ©es pour les traductions dynamiques
          window.reservationData = d

          // Utiliser la fonction de traduction pour le rÃ©capitulatif
          detailsBox.innerHTML = translateRecapContent(d, currentLang)

          // S'assurer que la page est traduite dans la langue actuelle
          if (window.translations && window.translations[currentLang]) {
            translatePage(currentLang)
          }

          // ============================================================================
          // MISE Ã€ JOUR DE L'INTERFACE DE PAIEMENT
          // ============================================================================

          // RÃ©cap paiement avec formatage selon la langue
          const t = window.translations[currentLang]['payer-solde']
          const locale =
            currentLang === 'de'
              ? 'de-DE'
              : currentLang === 'en'
              ? 'en-GB'
              : 'fr-FR'

          document.getElementById(
            'total-amount'
          ).textContent = `${total.toLocaleString(locale, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })} â‚¬`
          document.getElementById(
            'deposit-amount'
          ).textContent = `${deposit.toLocaleString(locale, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })} â‚¬`
          document.getElementById(
            'remaining-amount'
          ).textContent = `${balance.toLocaleString(locale, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })} â‚¬`
          document.getElementById('deposit-percent').textContent =
            total > 0 ? `${Math.round((deposit / total) * 100)}%` : '0%'
          document.getElementById('progress-fill').style.width =
            total > 0 ? `${Math.min(100, (deposit / total) * 100)}%` : '0%'

          // Traduire le texte du bouton avec le montant
          const buttonTextTemplate = t.payment.submit_button_with_amount
          btnText.textContent = buttonTextTemplate.replace(
            '{amount}',
            balance.toLocaleString(locale, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })
          )

          // ============================================================================
          // GESTION DES VERROUILLAGES DE PAIEMENT
          // ============================================================================

          // VÃ©rifier le statut et appliquer les verrouillages appropriÃ©s
          const st = String(d.status || '')
          const lock = document.getElementById('balance-lock')
          const lockText = document.getElementById('balance-lock-text')
          if (lock && lockText) {
            if (st === 'balancePay') {
              // Solde dÃ©jÃ  payÃ© : verrouiller le paiement
              lockText.textContent = t.locks.balance_paid
              lock.style.display = 'flex'
              btn.disabled = true
            } else if (st === 'canceled') {
              // RÃ©servation annulÃ©e : verrouiller le paiement
              lockText.textContent = t.locks.reservation_canceled
              lock.style.display = 'flex'
              btn.disabled = true
            }
          }
        } catch (e) {
          // Gestion des erreurs de chargement avec traduction
          const t = window.translations[currentLang]['payer-solde']
          detailsBox.textContent = t.errors.loading_error
        }
      }

      // Charger les donnÃ©es au dÃ©marrage
      load()

      // ============================================================================
      // GESTIONNAIRE D'Ã‰VÃ‰NEMENTS DE PAIEMENT
      // ============================================================================

      /**
       * GÃ¨re le processus de paiement du solde
       * CrÃ©e l'intention de paiement et confirme le paiement via Stripe
       */
      btn.addEventListener('click', async () => {
        if (!token) return
        // DÃ©sactiver le bouton pendant le traitement
        btn.disabled = true
        const t = window.translations[currentLang]['payer-solde']

        // Ã‰tape 1 : CrÃ©ation de l'intention de paiement
        btnText.textContent = t.payment.creating_payment
        try {
          const piRes = await fetch('/api/createPayment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, type: 'balance' })
          })
          const piJson = await piRes.json()

          // VÃ©rifier la rÃ©ponse de l'API
          if (!piRes.ok || !piJson.clientSecret)
            throw new Error(piJson.error || t.errors.payment_creation_error)

          // Ã‰tape 2 : Confirmation du paiement via Stripe
          btnText.textContent = t.payment.confirming
          const { error, paymentIntent } = await stripe.confirmCardPayment(
            piJson.clientSecret,
            { payment_method: { card } }
          )

          // VÃ©rifier les erreurs Stripe
          if (error) throw new Error(error.message)

          // Ã‰tape 3 : Paiement confirmÃ© - redirection
          btnText.textContent = t.payment.confirmed
          setTimeout(() => {
            window.location.href = '/reservation-solde-confirme.html'
          }, 1200)
        } catch (e) {
          // Gestion des erreurs avec restauration de l'interface
          document.getElementById('card-errors').textContent = e.message
          btn.disabled = false
          btnText.textContent = t.payment.submit_button
        }
      })
    </script>
  </body>
</html>
