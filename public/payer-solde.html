<!DOCTYPE html>
<html>
  <head>
    <title>Payer le solde â€“ Calypso Bay</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <!-- Favicons -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="images/logos/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="images/logos/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="images/logos/favicons/favicon-16x16.png"
    />
    <link rel="manifest" href="manifest.json" />
    <link rel="shortcut icon" href="images/logos/favicons/favicon.ico" />

    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/custom.css" />
    <noscript
      ><link rel="stylesheet" href="assets/css/noscript.css"
    /></noscript>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      .form-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 12px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .reservation-details {
        padding: 8px 10px;
        margin-top: 1px;
        color: white;
      }
      .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding: 6px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        font-size: 0.9rem;
        color: white;
      }
      .detail-item:last-child {
        border-bottom: none;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.4);
      }
      .payment-card {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 12px;
        margin-top: 12px;
        color: white;
        position: relative;
      }

      .payment-card h3 {
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 12px;
        text-align: center;
      }
      .payment-lock {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(3px);
        background: rgba(17, 24, 39, 0.35);
        z-index: 5;
      }
      .payment-lock .lock-box {
        background: rgba(255, 255, 255, 0.95);
        color: #111827;
        padding: 14px 18px;
        border-radius: 12px;
        font-weight: 700;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      }
      .payment-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        color: white;
        font-size: 1rem;
        line-height: 1.3;
      }
      .payment-row.deposit {
        color: #3b82f6;
        font-weight: 600;
        font-size: 1.1rem;
      }
      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        margin: 12px 0;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        width: 0%;
        background: #3b82f6;
        transition: width 0.3s ease;
      }
      .btn-submit {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        padding: 16px 30px;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 55px;
      }
      .btn-submit:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      }
      .btn-submit:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      #card-errors {
        color: #ef4444;
        margin-top: 12px;
        font-size: 14px;
        font-weight: 500;
      }
      .payment-disclaimer {
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.8rem;
        margin-top: 12px;
        line-height: 1.4;
      }

      /* Styles pour le sÃ©lecteur de langue */
      .language-selector {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
      }
      .language-selector select {
        border: none;
        background: transparent;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
      }
      .language-selector select:focus {
        outline: none;
        background: rgba(59, 130, 246, 0.1);
      }

      /* Responsive design pour mobile */
      @media (max-width: 768px) {
        /* Conteneurs principaux */
        .content,
        .inner {
          padding: 0 10px;
          max-width: 100vw;
          width: 100%;
        }

        .form-section {
          padding: 15px;
          margin: 10px 0;
          max-width: 100%;
          width: 100%;
        }

        .detail-item {
          font-size: 0.85rem;
          padding: 10px 0;
          max-width: 100%;
          width: 100%;
        }

        .reservation-details {
          padding: 15px;
          max-width: 100%;
          width: 100%;
        }

        /* Forcer les largeurs maximales */
        .span-4-5,
        .span-9-5,
        .span-3-75,
        .span-1-75 {
          max-width: 100%;
          width: 100%;
        }

        /* Responsive pour l'encart de paiement */
        .payment-card {
          padding: 12px 15px;
          margin: 0 10px;
          max-width: 100%;
          width: calc(100% - 20px);
        }

        .payment-card h3 {
          font-size: 1.3rem;
          margin-bottom: 10px;
        }

        .payment-row {
          font-size: 0.9rem;
          padding: 4px 0;
        }

        .payment-row.deposit {
          font-size: 1rem;
        }

        .progress-bar {
          margin: 8px 0;
        }

        .btn-submit {
          padding: 15px 20px;
          font-size: 16px;
          min-height: 50px;
          max-width: 100%;
          width: 100%;
        }

        .payment-disclaimer {
          font-size: 0.75rem;
          margin-top: 8px;
        }
      }

      @media (max-width: 480px) {
        /* Conteneurs principaux */
        .content,
        .inner {
          padding: 0 5px;
          max-width: 100vw;
          width: 100%;
        }

        .form-section {
          padding: 10px;
          max-width: 100%;
          width: 100%;
        }

        .detail-item {
          font-size: 0.8rem;
          max-width: 100%;
          width: 100%;
        }

        /* Forcer tous les Ã©lÃ©ments Ã  respecter la largeur */
        * {
          max-width: 100vw;
        }

        .panel,
        .content,
        .inner,
        .form-section,
        .payment-card,
        .btn-submit,
        .detail-item {
          max-width: 100%;
          width: 100%;
          overflow-x: hidden;
        }

        /* Responsive pour l'encart de paiement sur trÃ¨s petits Ã©crans */
        .payment-card {
          padding: 10px;
          margin: 0 5px;
          width: calc(100% - 10px);
        }

        .payment-card h3 {
          font-size: 1.2rem;
          margin-bottom: 10px;
        }

        .payment-row {
          font-size: 0.85rem;
          padding: 4px 0;
        }

        .payment-row.deposit {
          font-size: 0.95rem;
        }

        .progress-bar {
          margin: 6px 0;
          height: 6px;
        }

        .btn-submit {
          font-size: 14px;
          padding: 12px 15px;
          max-width: 100%;
          width: 100%;
        }

        .payment-disclaimer {
          font-size: 0.7rem;
          margin-top: 6px;
        }
      }
    </style>
  </head>
  <body class="is-preload">
    <!-- SÃ©lecteur de langue -->
    <div class="language-selector">
      <select id="language-selector">
        <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
        <option value="en">ðŸ‡¬ðŸ‡§ English</option>
        <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
      </select>
    </div>

    <div id="page-wrapper">
      <div id="wrapper">
        <section class="panel banner right">
          <div class="content color0 span-3-75">
            <h2 class="major">
              <span id="banner-title">Payer le</span><br /><span
                class="themysion"
                id="banner-subtitle"
                >Solde</span
              >
            </h2>
            <p id="banner-description">
              Pour finaliser votre rÃ©servation, veuillez rÃ©gler le solde
              restant.
            </p>
            <ul class="actions">
              <li>
                <a
                  href="#form"
                  class="button primary color1 circle icon solid fa-angle-right"
                  id="banner-button"
                  >Continuer</a
                >
              </li>
            </ul>
          </div>
          <div class="image filtered span-1-75" data-position="25% 25%">
            <img src="images/pic01.webp" alt="Vue de Calypso Bay" />
          </div>
        </section>

        <!-- DÃ©tails de la rÃ©servation (section sÃ©parÃ©e) -->
        <section class="panel spotlight medium right color1" id="details">
          <div class="intro joined span-3-5">
            <h2 class="major" id="details-title">
              ðŸ“… DÃ©tails de la rÃ©servation
            </h2>
            <p id="details-description">
              VÃ©rifiez les informations de votre sÃ©jour avant de procÃ©der au
              paiement du solde.
            </p>
          </div>
          <div class="inner">
            <div class="form-section">
              <div class="reservation-details" id="reservation-details">
                <span id="details-loading">Chargement en coursâ€¦</span>
              </div>
            </div>
          </div>
          <div class="image filtered tinted" data-position="center">
            <img src="images/pic02.webp" alt="Vue panoramique de Calypso Bay" />
          </div>
        </section>

        <!-- Paiement du solde (section dÃ©diÃ©e) -->
        <section class="panel color4-alt" id="form">
          <div class="intro color4">
            <h2 class="major" id="payment-title">ðŸ’³ Paiement du solde</h2>
            <p id="payment-description">
              Renseignez votre carte pour rÃ©gler le solde restant de votre
              rÃ©servation.
            </p>
          </div>
          <div class="inner">
            <div class="payment-card">
              <div class="payment-lock" id="balance-lock">
                <div class="lock-box" id="balance-lock-text"></div>
              </div>
              <h3 id="payment-summary-title">RÃ©capitulatif du paiement</h3>
              <div class="payment-row">
                <span id="payment-total-label">Total</span
                ><span id="total-amount">â€”</span>
              </div>
              <div class="payment-row deposit">
                <span
                  ><span id="payment-deposit-label">Acompte dÃ©jÃ  versÃ©</span>
                  (<span id="deposit-percent">0%</span>)</span
                ><span id="deposit-amount">â€”</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <div
                class="payment-row"
                style="
                  border-top: 1px solid rgba(255, 255, 255, 0.25);
                  padding-top: 12px;
                  margin-top: 4px;
                "
              >
                <span id="payment-remaining-label">Solde restant</span
                ><span id="remaining-amount">â€”</span>
              </div>

              <div style="margin-top: 16px">
                <label
                  for="card-element"
                  style="color: white; font-weight: 600"
                  id="card-label"
                  >Carte de paiement</label
                >
                <div
                  id="card-element"
                  style="
                    background: rgba(255, 255, 255, 0.9);
                    border-radius: 10px;
                    padding: 12px;
                  "
                ></div>
                <div id="card-errors" role="alert"></div>
              </div>
              <button id="pay-btn" class="btn-submit" style="margin-top: 16px">
                <span id="submit-button-text">Payer le solde</span>
              </button>
              <p class="payment-disclaimer" id="payment-disclaimer">
                Paiement sÃ©curisÃ© via Stripe. Aucune donnÃ©e bancaire n'est
                stockÃ©e par Calypso Bay.
              </p>
            </div>
          </div>
        </section>

        <div class="copyright">
          <span>&copy; Calypso Bay | By</span>
          <a
            href="https://moriarty-design.fr"
            target="_blank"
            rel="noopener"
            style="
              font-family: 'Engagement', 'Brush Script MT', cursive;
              font-size: 2.2em;
              line-height: 1;
              margin-left: 0.25em;
              text-decoration: none;
              color: inherit;
            "
            >Moriarty</a
          >.
        </div>
      </div>
    </div>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/translations.js"></script>
    <script>
      // ============================================================================
      // SYSTÃˆME DE TRADUCTION
      // ============================================================================

      let currentLang = 'fr'

      // Initialiser les traductions au chargement
      console.log('ðŸ”§ Ã‰couteur translations:ready ajoutÃ©')
      window.addEventListener('translations:ready', function (event) {
        console.log('ðŸŽ‰ Ã‰vÃ©nement translations:ready reÃ§u:', event.detail)
        const detectedLang = event.detail.language
        currentLang = detectedLang
        console.log('ðŸŒ Langue dÃ©tectÃ©e:', detectedLang)
        translatePage(detectedLang)
      })

      // GÃ©rer le changement de langue via le sÃ©lecteur
      document.addEventListener('DOMContentLoaded', function () {
        const languageSelector = document.querySelector('#language-selector')
        if (languageSelector) {
          languageSelector.addEventListener('change', function () {
            const newLang = this.value

            // Sauvegarder la prÃ©fÃ©rence de langue
            localStorage.setItem('calypso-bay-lang', newLang)

            // Rediriger vers la nouvelle URL avec le bon paramÃ¨tre de langue
            const url = new URL(window.location)
            url.searchParams.set('lang', newLang)
            window.location.href = url.toString()
          })

          // Charger la prÃ©fÃ©rence de langue sauvegardÃ©e
          const savedLang = localStorage.getItem('calypso-bay-lang')
          if (savedLang && ['fr', 'en', 'de'].includes(savedLang)) {
            languageSelector.value = savedLang
          }
        }
      })

      // ============================================================================
      // LOGIQUE PRINCIPALE DE LA PAGE
      // ============================================================================

      // Configuration Stripe et crÃ©ation des Ã©lÃ©ments de paiement
      const stripe = Stripe(
        '%STRIPE_PUBLIC_KEY%'.replace(
          '%STRIPE_PUBLIC_KEY%',
          'pk_live_51RuYagJuxMM0V1wvWkNbfWITDKf6J6Q8BaoCPCwWrd6juAMlGekc3RADsm9VfcFcfkk7dYmY8dgDr0DqHOBw3qtb006Bbqn4e4'
        )
      )
      const elements = stripe.elements()
      const card = elements.create('card', {
        style: { base: { fontSize: '16px' } }
      })
      card.mount('#card-element')

      // Gestion des erreurs de la carte de paiement
      card.addEventListener('change', function (event) {
        const displayError = document.getElementById('card-errors')
        displayError.textContent = event.error ? event.error.message : ''
      })

      // Variables principales de la page
      const params = new URLSearchParams(window.location.search)
      const token = params.get('token')
      const detailsBox = document.getElementById('reservation-details')
      const btn = document.getElementById('pay-btn')
      const btnText = document.getElementById('submit-button-text')

      // ============================================================================
      // FONCTIONS DE TRADUCTION
      // ============================================================================

      /**
       * Traduit l'ensemble de la page dans la langue spÃ©cifiÃ©e
       * @param {string} lang - Code de langue (fr, en, de)
       */
      function translatePage(lang) {
        console.log('ðŸ”„ DÃ©but de translatePage pour la langue:', lang)
        currentLang = lang

        if (!window.translations || !window.translations[lang]) {
          console.error('âŒ Traductions non disponibles pour la langue:', lang)
          console.log(
            'ðŸ“‹ window.translations disponible:',
            !!window.translations
          )
          if (window.translations) {
            console.log(
              'ðŸŒ Langues disponibles:',
              Object.keys(window.translations)
            )
          }
          return
        }

        const t = window.translations[lang]['payer-solde']
        const common = window.translations[lang].common
        console.log('âœ… Traductions chargÃ©es pour payer-solde:', !!t)

        // Mettre Ã  jour le titre de la page
        document.title = t.title

        // Traduire la banniÃ¨re principale
        const bannerTitle = document.getElementById('banner-title')
        const bannerSubtitle = document.getElementById('banner-subtitle')
        const bannerDescription = document.getElementById('banner-description')
        const bannerButton = document.getElementById('banner-button')

        console.log('ðŸ” Ã‰lÃ©ments banniÃ¨re trouvÃ©s:', {
          bannerTitle: !!bannerTitle,
          bannerSubtitle: !!bannerSubtitle,
          bannerDescription: !!bannerDescription,
          bannerButton: !!bannerButton
        })

        if (bannerTitle) bannerTitle.textContent = t.banner.title
        if (bannerSubtitle) bannerSubtitle.textContent = t.banner.subtitle
        if (bannerDescription)
          bannerDescription.textContent = t.banner.description
        if (bannerButton) bannerButton.textContent = t.banner.button

        // Traduire la section dÃ©tails de la rÃ©servation
        const detailsTitle = document.getElementById('details-title')
        const detailsDescription = document.getElementById(
          'details-description'
        )
        const detailsLoading = document.getElementById('details-loading')

        if (detailsTitle) detailsTitle.textContent = t.details.title
        if (detailsDescription)
          detailsDescription.textContent = t.details.description
        if (detailsLoading) detailsLoading.textContent = t.details.loading

        // Traduire la section paiement
        const paymentTitle = document.getElementById('payment-title')
        const paymentDescription = document.getElementById(
          'payment-description'
        )
        const paymentSummaryTitle = document.getElementById(
          'payment-summary-title'
        )
        const paymentTotalLabel = document.getElementById('payment-total-label')
        const paymentDepositLabel = document.getElementById(
          'payment-deposit-label'
        )
        const paymentRemainingLabel = document.getElementById(
          'payment-remaining-label'
        )
        const cardLabel = document.getElementById('card-label')
        const submitButtonText = document.getElementById('submit-button-text')
        const paymentDisclaimer = document.getElementById('payment-disclaimer')

        console.log('ðŸ” Ã‰lÃ©ments paiement trouvÃ©s:', {
          paymentTitle: !!paymentTitle,
          paymentDescription: !!paymentDescription,
          paymentSummaryTitle: !!paymentSummaryTitle,
          paymentTotalLabel: !!paymentTotalLabel,
          paymentDepositLabel: !!paymentDepositLabel,
          paymentRemainingLabel: !!paymentRemainingLabel,
          cardLabel: !!cardLabel,
          submitButtonText: !!submitButtonText,
          paymentDisclaimer: !!paymentDisclaimer
        })

        if (paymentTitle) paymentTitle.textContent = t.payment.title
        if (paymentDescription)
          paymentDescription.textContent = t.payment.description
        if (paymentSummaryTitle)
          paymentSummaryTitle.textContent = t.payment.summary_title
        if (paymentTotalLabel) paymentTotalLabel.textContent = t.payment.total
        if (paymentDepositLabel)
          paymentDepositLabel.textContent = t.payment.deposit_paid.replace(
            '{percent}',
            ''
          )
        if (paymentRemainingLabel)
          paymentRemainingLabel.textContent = t.payment.remaining
        if (cardLabel) cardLabel.textContent = t.payment.card_label
        if (submitButtonText)
          submitButtonText.textContent = t.payment.submit_button
        if (paymentDisclaimer)
          paymentDisclaimer.textContent = t.payment.disclaimer

        // Mettre Ã  jour le sÃ©lecteur de langue
        if (document.querySelector('#language-selector')) {
          document.querySelector('#language-selector').value = lang
        }

        // Mettre Ã  jour l'URL avec la nouvelle langue
        const url = new URL(window.location)
        url.searchParams.set('lang', lang)
        window.history.replaceState({}, '', url)

        // Mettre Ã  jour les traductions aprÃ¨s chargement des donnÃ©es
        updateTranslationsAfterLoad()
      }

      // Fonction pour traduire les Ã©lÃ©ments dynamiques du rÃ©capitulatif
      function translateRecapContent(data, lang) {
        console.log('ðŸ”„ DÃ©but de translateRecapContent')
        console.log('ðŸ“Š DonnÃ©es reÃ§ues:', data)
        console.log('ðŸŒ Langue demandÃ©e:', lang)

        if (!data) {
          console.warn('âŒ Aucune donnÃ©e de rÃ©servation disponible')
          return ''
        }

        if (!window.translations || !window.translations[lang]) {
          console.error('âŒ Traductions non disponibles pour la langue:', lang)
          return ''
        }

        const common = window.translations[lang].common
        const fmtMoney = (v) =>
          Number(v || 0).toLocaleString(
            lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-GB' : 'fr-FR',
            {
              minimumFractionDigits: 1,
              maximumFractionDigits: 1
            }
          )
        const fmtMoney2 = (v) =>
          Number(v || 0).toLocaleString(
            lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-GB' : 'fr-FR',
            {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            }
          )

        const lines = []

        // VÃ©rifier si on a les dates avant de les afficher
        if (data.startDate && data.endDate) {
          const s = new Date(data.startDate)
          const e = new Date(data.endDate)
          const fmtDate = (dt) =>
            dt.toLocaleDateString(
              lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-GB' : 'fr-FR',
              {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
              }
            )

          lines.push(
            `<div class="detail-item"><strong>${
              common.dates
            }</strong> <span>${fmtDate(s)} ${
              lang === 'de' ? 'bis' : lang === 'en' ? 'to' : 'au'
            } ${fmtDate(e)} (${data.nbNights || 0} ${
              common.nights
            })</span></div>`
          )
        }

        // VÃ©rifier si on a les informations de voyageurs
        if (data.nbAdults) {
          const adultText =
            data.nbAdults > 1 ? common.adults_plural : common.adults
          const childText =
            data.nbChilds > 1 ? common.children_plural : common.children
          lines.push(
            `<div class="detail-item"><strong>${
              common.travelers
            }</strong> <span>${data.nbAdults} ${adultText}${
              data.nbChilds > 0 ? `, ${data.nbChilds} ${childText}` : ''
            }</span></div>`
          )

          // VÃ©rifier si on a les Ã¢ges des enfants
          if (
            data.nbChilds > 0 &&
            Array.isArray(data.childrenAges) &&
            data.childrenAges.length
          ) {
            const ages = data.childrenAges.join(', ')
            lines.push(
              `<div class="detail-item"><strong>${common.children_ages}</strong> <span>${ages}</span></div>`
            )
          }
        }

        // VÃ©rifier si on a les informations de prix
        if (data.priceTotal && data.priceTotal > 0) {
          lines.push(
            `<div class="detail-item" style="border-bottom:none; display:block; padding-bottom:0;">
              <div><strong>${common.price_details}</strong></div>
              <div style="padding-top:8px">â€¢ ${common.nights_total.replace(
                '{count}',
                data.nbNights || 0
              )} ${fmtMoney(data.priceNights || 0)} ${common.currency}</div>
              <div>â€¢ ${common.cleaning_fees} ${fmtMoney(
              data.priceClean || 0
            )} ${common.currency}</div>
              <div>â€¢ ${common.taxes
                .replace('{count}', data.nbAdults || 0)
                .replace(
                  '{adult_text}',
                  data.nbAdults > 1 ? common.adults_plural : common.adults
                )} ${fmtMoney(data.priceTax || 0)} ${common.currency}</div>
              <div>â€¢ <strong>${common.total} ${fmtMoney(data.priceTotal)} ${
              common.currency
            }</strong></div>
            </div>`
          )
        }

        // VÃ©rifier si on a l'adresse de facturation
        if (data.address || data.city || data.postal || data.country) {
          lines.push(
            `<div class="detail-item" style="border-bottom:none; display:block; padding-bottom:0;">
              <div><strong>${common.billing_address}</strong></div>
              <div style="padding-top:8px">${data.address || ''}</div>
              <div>${data.postal || ''} ${data.city || ''}</div>
              <div>${data.country || ''}</div>
            </div>`
          )
        }

        const result = lines.join('')
        console.log('âœ… RÃ©capitulatif gÃ©nÃ©rÃ©:', result)
        return result
      }

      /**
       * Met Ã  jour les traductions des Ã©lÃ©ments dynamiques aprÃ¨s changement de langue
       * Cette fonction est appelÃ©e quand les donnÃ©es de rÃ©servation sont dÃ©jÃ  chargÃ©es
       */
      function updateTranslationsAfterLoad() {
        if (window.reservationData) {
          // Mettre Ã  jour le rÃ©capitulatif si les donnÃ©es sont dÃ©jÃ  chargÃ©es
          const recapEl = document.getElementById('reservation-details')
          if (recapEl && !recapEl.textContent.includes('Chargement')) {
            recapEl.innerHTML = translateRecapContent(
              window.reservationData,
              currentLang
            )
          }

          // Mettre Ã  jour l'interface de paiement avec la nouvelle langue
          updatePaymentInterface(window.reservationData)

          // Mettre Ã  jour les verrouillages avec la nouvelle langue
          applyPaymentLocks(window.reservationData)
        }
      }

      /**
       * Charge et affiche les donnÃ©es de la rÃ©servation
       * GÃ¨re les erreurs et met Ã  jour l'interface utilisateur
       */
      async function load() {
        console.log('ðŸš€ DÃ©but de la fonction load()')
        console.log('ðŸ”‘ Token disponible:', !!token)
        console.log('ðŸŒ Langue actuelle:', currentLang)
        console.log('ðŸ“‹ Traductions disponibles:', !!window.translations)

        if (!token) {
          console.log('âŒ Pas de token, on continue avec des donnÃ©es vides')
          // Au lieu de bloquer, on continue avec des donnÃ©es vides
          window.reservationData = null
          return
        }

        try {
          console.log(
            'ðŸ” Tentative de rÃ©cupÃ©ration des donnÃ©es de rÃ©servation...'
          )
          console.log('ðŸ”‘ Token utilisÃ©:', token)
          console.log(
            "ðŸŒ URL de l'API:",
            `/api/reservations?action=get&token=${encodeURIComponent(token)}`
          )

          const res = await fetch(
            `/api/reservations?action=get&token=${encodeURIComponent(token)}`
          )
          console.log("ðŸ“¡ RÃ©ponse de l'API reÃ§ue:", res.status, res.statusText)

          if (!res.ok) {
            console.error('âŒ Erreur HTTP:', res.status, res.statusText)
            // Au lieu de bloquer, on continue avec des donnÃ©es vides
            window.reservationData = null
            return
          }

          const json = await res.json()
          console.log('ðŸ“‹ DonnÃ©es reÃ§ues:', json)

          if (json.status !== 'success') {
            console.error(
              "âŒ Statut de l'API non rÃ©ussi:",
              json.status,
              json.message
            )
            // Au lieu de bloquer, on continue avec des donnÃ©es vides
            window.reservationData = null
            return
          }

          console.log('âœ… DonnÃ©es de rÃ©servation rÃ©cupÃ©rÃ©es avec succÃ¨s')
          const d = json.data
          console.log('ðŸ“Š DonnÃ©es brutes de la rÃ©servation:', d)

          // Sauvegarder les donnÃ©es pour les traductions dynamiques
          window.reservationData = d
          console.log('ðŸ’¾ DonnÃ©es sauvegardÃ©es dans window.reservationData')

          // Utiliser la fonction de traduction pour le rÃ©capitulatif
          console.log('ðŸ”„ Mise Ã  jour du rÃ©capitulatif...')
          detailsBox.innerHTML = translateRecapContent(d, currentLang)
          console.log('âœ… RÃ©capitulatif mis Ã  jour')

          // S'assurer que la page est traduite dans la langue actuelle
          if (window.translations && window.translations[currentLang]) {
            translatePage(currentLang)
          }

          // Mettre Ã  jour l'interface de paiement
          updatePaymentInterface(d)

          // Appliquer les verrouillages de paiement
          applyPaymentLocks(d)
        } catch (e) {
          console.error('ðŸ’¥ Erreur lors du chargement des donnÃ©es:', e)
          console.error('ðŸ“‹ Stack trace:', e.stack)
          // Au lieu de bloquer, on continue avec des donnÃ©es vides
          window.reservationData = null
        }
      }

      // Nouvelle fonction pour mettre Ã  jour l'interface de paiement
      function updatePaymentInterface(data) {
        if (!data) return

        const total = Number(data.priceTotal || 0)
        const deposit = Number(data.depositAmount || 0)
        const balance = Math.max(0, total - deposit)

        console.log('ðŸ’° Calculs financiers:')
        console.log('  - Total:', total)
        console.log('  - Acompte:', deposit)
        console.log('  - Solde:', balance)

        const t = window.translations[currentLang]['payer-solde']
        const locale =
          currentLang === 'de'
            ? 'de-DE'
            : currentLang === 'en'
            ? 'en-GB'
            : 'fr-FR'

        document.getElementById('total-amount').textContent =
          total > 0
            ? `${total.toLocaleString(locale, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })} â‚¬`
            : 'â€”'
        document.getElementById('deposit-amount').textContent =
          deposit > 0
            ? `${deposit.toLocaleString(locale, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })} â‚¬`
            : 'â€”'
        document.getElementById('remaining-amount').textContent =
          balance > 0
            ? `${balance.toLocaleString(locale, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })} â‚¬`
            : 'â€”'
        document.getElementById('deposit-percent').textContent =
          total > 0 ? `${Math.round((deposit / total) * 100)}%` : '0%'
        document.getElementById('progress-fill').style.width =
          total > 0 ? `${Math.min(100, (deposit / total) * 100)}%` : '0%'

        // Traduire le texte du bouton avec le montant
        if (balance > 0) {
          const buttonTextTemplate = t.payment.submit_button_with_amount
          btnText.textContent = buttonTextTemplate.replace(
            '{amount}',
            balance.toLocaleString(locale, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })
          )
        } else {
          btnText.textContent = t.payment.submit_button
        }
      }

      // Nouvelle fonction pour appliquer les verrouillages de paiement
      function applyPaymentLocks(data) {
        if (!data) return

        const lock = document.getElementById('balance-lock')
        const lockText = document.getElementById('balance-lock-text')

        if (lock && lockText) {
          const t = window.translations[currentLang]['payer-solde']

          // âœ… NOUVELLE LOGIQUE : Ordre chronologique des vÃ©rifications
          // On s'arrÃªte Ã  la premiÃ¨re condition vraie

          // 1. VÃ©rifier si la rÃ©servation a expirÃ© (prioritÃ© absolue)
          if (data.endDate) {
            const endDate = new Date(data.endDate)
            const today = new Date()
            today.setHours(0, 0, 0, 0) // Remettre Ã  minuit pour la comparaison

            if (endDate < today) {
              lockText.textContent = 'Votre rÃ©servation a expirÃ©'
              lock.style.display = 'flex'
              btn.disabled = true
              return // On s'arrÃªte ici
            }
          }

          // 2. VÃ©rifier si la rÃ©servation est annulÃ©e
          const cancelStatus = String(data.cancelStatus || '')
          if (cancelStatus === 'validated') {
            lockText.textContent = 'RÃ©servation annulÃ©e'
            lock.style.display = 'flex'
            btn.disabled = true
            return // On s'arrÃªte ici
          }

          // 3. VÃ©rifier si l'annulation est en cours
          if (cancelStatus === 'pending') {
            lockText.textContent =
              "Votre rÃ©servation fait l'objet d'une demande d'annulation"
            lock.style.display = 'flex'
            btn.disabled = true
            return // On s'arrÃªte ici
          }

          // 4. VÃ©rifier si le solde est dÃ©jÃ  rÃ©glÃ©
          const st = String(data.status || '')
          if (st === 'balancePay') {
            lockText.textContent = t.locks.balance_paid
            lock.style.display = 'flex'
            btn.disabled = true
            return // On s'arrÃªte ici
          }

          // Si aucune condition n'est vraie, pas de verrouillage
          lock.style.display = 'none'
          btn.disabled = false
        }
      }

      // Fallback pour s'assurer que les traductions sont chargÃ©es
      setTimeout(() => {
        console.log('â° Fallback: vÃ©rification des traductions aprÃ¨s 1 seconde')
        if (window.translations) {
          console.log('âœ… Traductions disponibles dans le fallback')
          const detectedLang = window.detectLanguage
            ? window.detectLanguage()
            : 'fr'
          console.log('ðŸŒ Langue dÃ©tectÃ©e dans le fallback:', detectedLang)
          if (currentLang !== detectedLang) {
            currentLang = detectedLang
            translatePage(detectedLang)
          }
        } else {
          console.error(
            'âŒ Traductions toujours non disponibles aprÃ¨s 1 seconde'
          )
        }
      }, 1000)

      // Charger les donnÃ©es au dÃ©marrage
      load()

      // ============================================================================
      // GESTIONNAIRE D'Ã‰VÃ‰NEMENTS DE PAIEMENT
      // ============================================================================

      /**
       * GÃ¨re le processus de paiement du solde
       * CrÃ©e l'intention de paiement et confirme le paiement via Stripe
       */
      btn.addEventListener('click', async () => {
        if (!token) return
        // DÃ©sactiver le bouton pendant le traitement
        btn.disabled = true
        const t = window.translations[currentLang]['payer-solde']

        // Ã‰tape 1 : CrÃ©ation de l'intention de paiement
        btnText.textContent = t.payment.creating_payment
        try {
          const piRes = await fetch('/api/createPayment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, type: 'balance' })
          })
          const piJson = await piRes.json()

          // VÃ©rifier la rÃ©ponse de l'API
          if (!piRes.ok || !piJson.clientSecret)
            throw new Error(piJson.error || t.errors.payment_creation_error)

          // Ã‰tape 2 : Confirmation du paiement via Stripe
          btnText.textContent = t.payment.confirming
          const { error, paymentIntent } = await stripe.confirmCardPayment(
            piJson.clientSecret,
            { payment_method: { card } }
          )

          // VÃ©rifier les erreurs Stripe
          if (error) throw new Error(error.message)

          // Ã‰tape 3 : Paiement confirmÃ© - redirection
          btnText.textContent = t.payment.confirmed
          setTimeout(() => {
            window.location.href = '/reservation-solde-confirme.html'
          }, 1200)
        } catch (e) {
          // Gestion des erreurs avec restauration de l'interface
          document.getElementById('card-errors').textContent = e.message
          btn.disabled = false
          btnText.textContent = t.payment.submit_button
        }
      })
    </script>
  </body>
</html>
