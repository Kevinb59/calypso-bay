<!DOCTYPE html>
<html>
  <head>
    <title>Payer le solde – Calypso Bay</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <!-- Favicons -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="images/logos/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="images/logos/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="images/logos/favicons/favicon-16x16.png"
    />
    <link rel="manifest" href="manifest.json" />
    <link rel="shortcut icon" href="images/logos/favicons/favicon.ico" />

    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/custom.css" />
    <noscript
      ><link rel="stylesheet" href="assets/css/noscript.css"
    /></noscript>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      .form-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .reservation-details {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
        color: white;
      }
      .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.25);
        font-size: 0.95rem;
      }
      .detail-item:last-child {
        border-bottom: none;
        margin-top: 10px;
        padding-top: 10px;
      }
      .payment-card {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
        color: white;
        position: relative;
      }
      .payment-lock {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(3px);
        background: rgba(17, 24, 39, 0.35);
        z-index: 5;
      }
      .payment-lock .lock-box {
        background: rgba(255, 255, 255, 0.95);
        color: #111827;
        padding: 14px 18px;
        border-radius: 12px;
        font-weight: 700;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      }
      .payment-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
      }
      .payment-row.deposit {
        color: #3b82f6;
        font-weight: 600;
      }
      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 4px;
        overflow: hidden;
        margin: 8px 0 12px;
      }
      .progress-fill {
        height: 100%;
        width: 0%;
        background: #3b82f6;
        transition: width 0.3s ease;
      }
      .btn-submit {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        padding: 14px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 50px;
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
      }
      .btn-submit:disabled {
        background: #9ca3af;
      }
      #card-errors {
        color: #ef4444;
        margin-top: 10px;
        font-size: 0.9rem;
      }
      .payment-disclaimer {
        text-align: center;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.85rem;
        margin-top: 10px;
      }

      /* Styles pour le sélecteur de langue */
      .language-selector {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
      }
      .language-selector select {
        border: none;
        background: transparent;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
      }
      .language-selector select:focus {
        outline: none;
        background: rgba(59, 130, 246, 0.1);
      }
    </style>
  </head>
  <body class="is-preload">
    <!-- Sélecteur de langue -->
    <div class="language-selector">
      <select id="language-selector">
        <option value="fr">🇫🇷 Français</option>
        <option value="en">🇬🇧 English</option>
        <option value="de">🇩🇪 Deutsch</option>
      </select>
    </div>

    <div id="page-wrapper">
      <div id="wrapper">
        <section class="panel banner right">
          <div class="content color0 span-3-75">
            <h2 class="major">
              <span id="banner-title">Payer le</span><br /><span
                class="themysion"
                id="banner-subtitle"
                >Solde</span
              >
            </h2>
            <p id="banner-description">
              Pour finaliser votre réservation, veuillez régler le solde
              restant.
            </p>
            <ul class="actions">
              <li>
                <a
                  href="#form"
                  class="button primary color1 circle icon solid fa-angle-right"
                  id="banner-button"
                  >Continuer</a
                >
              </li>
            </ul>
          </div>
          <div class="image filtered span-1-75" data-position="25% 25%">
            <img src="images/pic01.webp" alt="Vue de Calypso Bay" />
          </div>
        </section>

        <!-- Détails de la réservation (section séparée) -->
        <section class="panel spotlight medium right color1" id="details">
          <div class="intro joined span-3-5">
            <h2 class="major" id="details-title">
              📅 Détails de la réservation
            </h2>
            <p id="details-description">
              Vérifiez les informations de votre séjour avant de procéder au
              paiement du solde.
            </p>
          </div>
          <div class="inner">
            <div class="form-section">
              <div class="reservation-details" id="reservation-details">
                <span id="details-loading">Chargement en cours…</span>
              </div>
            </div>
          </div>
          <div class="image filtered tinted" data-position="center">
            <img src="images/pic02.webp" alt="Vue panoramique de Calypso Bay" />
          </div>
        </section>

        <!-- Paiement du solde (section dédiée) -->
        <section class="panel color4-alt" id="form">
          <div class="intro color4">
            <h2 class="major" id="payment-title">💳 Paiement du solde</h2>
            <p id="payment-description">
              Renseignez votre carte pour régler le solde restant de votre
              réservation.
            </p>
          </div>
          <div class="inner">
            <div class="payment-card">
              <div class="payment-lock" id="balance-lock">
                <div class="lock-box" id="balance-lock-text"></div>
              </div>
              <h4 style="margin: 0 0 10px 0" id="payment-summary-title">
                Récapitulatif du paiement
              </h4>
              <div class="payment-row">
                <span id="payment-total-label">Total</span
                ><span id="total-amount">—</span>
              </div>
              <div class="payment-row deposit">
                <span
                  ><span id="payment-deposit-label">Acompte déjà versé</span>
                  (<span id="deposit-percent">0%</span>)</span
                ><span id="deposit-amount">—</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <div
                class="payment-row"
                style="
                  border-top: 1px solid rgba(255, 255, 255, 0.25);
                  padding-top: 12px;
                  margin-top: 4px;
                "
              >
                <span id="payment-remaining-label">Solde restant</span
                ><span id="remaining-amount">—</span>
              </div>

              <div style="margin-top: 16px">
                <label
                  for="card-element"
                  style="color: white; font-weight: 600"
                  id="card-label"
                  >Carte de paiement</label
                >
                <div
                  id="card-element"
                  style="
                    background: rgba(255, 255, 255, 0.9);
                    border-radius: 10px;
                    padding: 12px;
                  "
                ></div>
                <div id="card-errors" role="alert"></div>
              </div>
              <button id="pay-btn" class="btn-submit" style="margin-top: 16px">
                <span id="submit-button-text">Payer le solde</span>
              </button>
              <p class="payment-disclaimer" id="payment-disclaimer">
                Paiement sécurisé via Stripe. Aucune donnée bancaire n'est
                stockée par Calypso Bay.
              </p>
            </div>
          </div>
        </section>

        <div class="copyright">
          <span>&copy; Calypso Bay | By</span>
          <a
            href="https://moriarty-design.fr"
            target="_blank"
            rel="noopener"
            style="
              font-family: 'Engagement', 'Brush Script MT', cursive;
              font-size: 2.2em;
              line-height: 1;
              margin-left: 0.25em;
              text-decoration: none;
              color: inherit;
            "
            >Moriarty</a
          >.
        </div>
      </div>
    </div>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/translations.js"></script>
    <script>
      // ============================================================================
      // SYSTÈME DE TRADUCTION
      // ============================================================================

      let currentLang = 'fr'

      // Initialiser les traductions au chargement
      console.log('🔧 Écouteur translations:ready ajouté')
      window.addEventListener('translations:ready', function (event) {
        console.log('🎉 Événement translations:ready reçu:', event.detail)
        const detectedLang = event.detail.language
        currentLang = detectedLang
        console.log('🌍 Langue détectée:', detectedLang)
        translatePage(detectedLang)
      })

      // Gérer le changement de langue via le sélecteur
      document.addEventListener('DOMContentLoaded', function () {
        const languageSelector = document.querySelector('#language-selector')
        if (languageSelector) {
          languageSelector.addEventListener('change', function () {
            const newLang = this.value

            // Sauvegarder la préférence de langue
            localStorage.setItem('calypso-bay-lang', newLang)

            // Rediriger vers la nouvelle URL avec le bon paramètre de langue
            const url = new URL(window.location)
            url.searchParams.set('lang', newLang)
            window.location.href = url.toString()
          })

          // Charger la préférence de langue sauvegardée
          const savedLang = localStorage.getItem('calypso-bay-lang')
          if (savedLang && ['fr', 'en', 'de'].includes(savedLang)) {
            languageSelector.value = savedLang
          }
        }
      })

      // ============================================================================
      // LOGIQUE PRINCIPALE DE LA PAGE
      // ============================================================================

      // Configuration Stripe et création des éléments de paiement
      const stripe = Stripe(
        '%STRIPE_PUBLIC_KEY%'.replace(
          '%STRIPE_PUBLIC_KEY%',
          'pk_live_51RuYagJuxMM0V1wvWkNbfWITDKf6J6Q8BaoCPCwWrd6juAMlGekc3RADsm9VfcFcfkk7dYmY8dgDr0DqHOBw3qtb006Bbqn4e4'
        )
      )
      const elements = stripe.elements()
      const card = elements.create('card', {
        style: { base: { fontSize: '16px' } }
      })
      card.mount('#card-element')

      // Gestion des erreurs de la carte de paiement
      card.addEventListener('change', function (event) {
        const displayError = document.getElementById('card-errors')
        displayError.textContent = event.error ? event.error.message : ''
      })

      // Variables principales de la page
      const params = new URLSearchParams(window.location.search)
      const token = params.get('token')
      const detailsBox = document.getElementById('reservation-details')
      const btn = document.getElementById('pay-btn')
      const btnText = document.getElementById('submit-button-text')

      // ============================================================================
      // FONCTIONS DE TRADUCTION
      // ============================================================================

      /**
       * Traduit l'ensemble de la page dans la langue spécifiée
       * @param {string} lang - Code de langue (fr, en, de)
       */
      function translatePage(lang) {
        console.log('🔄 Début de translatePage pour la langue:', lang)
        currentLang = lang

        if (!window.translations || !window.translations[lang]) {
          console.error('❌ Traductions non disponibles pour la langue:', lang)
          console.log(
            '📋 window.translations disponible:',
            !!window.translations
          )
          if (window.translations) {
            console.log(
              '🌐 Langues disponibles:',
              Object.keys(window.translations)
            )
          }
          return
        }

        const t = window.translations[lang]['payer-solde']
        const common = window.translations[lang].common
        console.log('✅ Traductions chargées pour payer-solde:', !!t)

        // Mettre à jour le titre de la page
        document.title = t.title

        // Traduire la bannière principale
        const bannerTitle = document.getElementById('banner-title')
        const bannerSubtitle = document.getElementById('banner-subtitle')
        const bannerDescription = document.getElementById('banner-description')
        const bannerButton = document.getElementById('banner-button')

        console.log('🔍 Éléments bannière trouvés:', {
          bannerTitle: !!bannerTitle,
          bannerSubtitle: !!bannerSubtitle,
          bannerDescription: !!bannerDescription,
          bannerButton: !!bannerButton
        })

        if (bannerTitle) bannerTitle.textContent = t.banner.title
        if (bannerSubtitle) bannerSubtitle.textContent = t.banner.subtitle
        if (bannerDescription)
          bannerDescription.textContent = t.banner.description
        if (bannerButton) bannerButton.textContent = t.banner.button

        // Traduire la section détails de la réservation
        const detailsTitle = document.getElementById('details-title')
        const detailsDescription = document.getElementById(
          'details-description'
        )
        const detailsLoading = document.getElementById('details-loading')

        if (detailsTitle) detailsTitle.textContent = t.details.title
        if (detailsDescription)
          detailsDescription.textContent = t.details.description
        if (detailsLoading) detailsLoading.textContent = t.details.loading

        // Traduire la section paiement
        const paymentTitle = document.getElementById('payment-title')
        const paymentDescription = document.getElementById(
          'payment-description'
        )
        const paymentSummaryTitle = document.getElementById(
          'payment-summary-title'
        )
        const paymentTotalLabel = document.getElementById('payment-total-label')
        const paymentDepositLabel = document.getElementById(
          'payment-deposit-label'
        )
        const paymentRemainingLabel = document.getElementById(
          'payment-remaining-label'
        )
        const cardLabel = document.getElementById('card-label')
        const submitButtonText = document.getElementById('submit-button-text')
        const paymentDisclaimer = document.getElementById('payment-disclaimer')

        console.log('🔍 Éléments paiement trouvés:', {
          paymentTitle: !!paymentTitle,
          paymentDescription: !!paymentDescription,
          paymentSummaryTitle: !!paymentSummaryTitle,
          paymentTotalLabel: !!paymentTotalLabel,
          paymentDepositLabel: !!paymentDepositLabel,
          paymentRemainingLabel: !!paymentRemainingLabel,
          cardLabel: !!cardLabel,
          submitButtonText: !!submitButtonText,
          paymentDisclaimer: !!paymentDisclaimer
        })

        if (paymentTitle) paymentTitle.textContent = t.payment.title
        if (paymentDescription)
          paymentDescription.textContent = t.payment.description
        if (paymentSummaryTitle)
          paymentSummaryTitle.textContent = t.payment.summary_title
        if (paymentTotalLabel) paymentTotalLabel.textContent = t.payment.total
        if (paymentDepositLabel)
          paymentDepositLabel.textContent = t.payment.deposit_paid.replace(
            '{percent}',
            ''
          )
        if (paymentRemainingLabel)
          paymentRemainingLabel.textContent = t.payment.remaining
        if (cardLabel) cardLabel.textContent = t.payment.card_label
        if (submitButtonText)
          submitButtonText.textContent = t.payment.submit_button
        if (paymentDisclaimer)
          paymentDisclaimer.textContent = t.payment.disclaimer

        // Mettre à jour le sélecteur de langue
        if (document.querySelector('#language-selector')) {
          document.querySelector('#language-selector').value = lang
        }

        // Mettre à jour l'URL avec la nouvelle langue
        const url = new URL(window.location)
        url.searchParams.set('lang', lang)
        window.history.replaceState({}, '', url)

        // Mettre à jour les traductions après chargement des données
        updateTranslationsAfterLoad()
      }

      // Fonction pour traduire les éléments dynamiques du récapitulatif
      function translateRecapContent(data, lang) {
        console.log('🔄 Début de translateRecapContent')
        console.log('📊 Données reçues:', data)
        console.log('🌍 Langue demandée:', lang)

        if (!window.translations || !window.translations[lang]) {
          console.error('❌ Traductions non disponibles pour la langue:', lang)
          return '<div class="detail-item">Erreur: traductions non disponibles</div>'
        }

        const common = window.translations[lang].common
        const fmtMoney = (v) =>
          Number(v || 0).toLocaleString(
            lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-GB' : 'fr-FR',
            {
              minimumFractionDigits: 1,
              maximumFractionDigits: 1
            }
          )
        const fmtMoney2 = (v) =>
          Number(v || 0).toLocaleString(
            lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-GB' : 'fr-FR',
            {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            }
          )
        const s = new Date(data.startDate)
        const e = new Date(data.endDate)
        const fmtDate = (dt) =>
          dt.toLocaleDateString(
            lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-GB' : 'fr-FR',
            {
              day: '2-digit',
              month: 'long',
              year: 'numeric'
            }
          )

        const ages =
          Array.isArray(data.childrenAges) && data.childrenAges.length
            ? data.childrenAges.join(', ')
            : ''

        const lines = []
        lines.push(
          `<div class="detail-item"><strong>${
            common.dates
          }</strong> <span>${fmtDate(s)} ${
            lang === 'de' ? 'bis' : lang === 'en' ? 'to' : 'au'
          } ${fmtDate(e)} (${data.nbNights} ${common.nights})</span></div>`
        )

        const adultText =
          data.nbAdults > 1 ? common.adults_plural : common.adults
        const childText =
          data.nbChilds > 1 ? common.children_plural : common.children
        lines.push(
          `<div class="detail-item"><strong>${
            common.travelers
          }</strong> <span>${data.nbAdults} ${adultText}${
            data.nbChilds > 0 ? `, ${data.nbChilds} ${childText}` : ''
          }</span></div>`
        )

        if (data.nbChilds > 0 && ages) {
          lines.push(
            `<div class="detail-item"><strong>${common.children_ages}</strong> <span>${ages}</span></div>`
          )
        }

        lines.push(
          `<div class="detail-item" style="border-bottom:none; display:block; padding-bottom:0;">
            <div><strong>${common.price_details}</strong></div>
            <div style="padding-top:8px">• ${common.nights_total.replace(
              '{count}',
              data.nbNights
            )} ${fmtMoney(data.priceNights)} ${common.currency}</div>
            <div>• ${common.cleaning_fees} ${fmtMoney(data.priceClean)} ${
            common.currency
          }</div>
            <div>• ${common.taxes
              .replace('{count}', data.nbAdults)
              .replace('{adult_text}', adultText)} ${fmtMoney(data.priceTax)} ${
            common.currency
          }</div>
            <div>• <strong>${common.total} ${fmtMoney(data.priceTotal)} ${
            common.currency
          }</strong></div>
          </div>`
        )

        if (data.address || data.city || data.postal || data.country) {
          lines.push(
            `<div class="detail-item" style="border-bottom:none; display:block; padding-bottom:0;">
              <div><strong>${common.billing_address}</strong></div>
              <div style="padding-top:8px">${data.address || ''}</div>
              <div>${data.postal || ''} ${data.city || ''}</div>
              <div>${data.country || ''}</div>
            </div>`
          )
        }

        const result = lines.join('')
        console.log('✅ Récapitulatif généré:', result)
        return result
      }

      /**
       * Met à jour les traductions des éléments dynamiques après changement de langue
       * Cette fonction est appelée quand les données de réservation sont déjà chargées
       */
      function updateTranslationsAfterLoad() {
        if (window.reservationData) {
          // Mettre à jour le récapitulatif si les données sont déjà chargées
          const recapEl = document.getElementById('reservation-details')
          if (recapEl && !recapEl.textContent.includes('Chargement')) {
            recapEl.innerHTML = translateRecapContent(
              window.reservationData,
              currentLang
            )
          }

          // Mettre à jour les messages de verrouillage si ils sont affichés
          const lock = document.getElementById('balance-lock')
          const lockText = document.getElementById('balance-lock-text')
          if (lock && lockText && lock.style.display === 'flex') {
            const t = window.translations[currentLang]['payer-solde']
            const st = String(window.reservationData.status || '')

            if (st === 'balancePay') {
              lockText.textContent = t.locks.balance_paid
            } else if (st === 'canceled') {
              lockText.textContent = t.locks.reservation_canceled
            }
          }

          // Mettre à jour les montants de paiement avec la nouvelle langue
          if (window.reservationData) {
            const total = Number(window.reservationData.priceTotal || 0)
            const deposit = Number(window.reservationData.depositAmount || 0)
            const balance = Math.max(0, total - deposit)

            const locale =
              currentLang === 'de'
                ? 'de-DE'
                : currentLang === 'en'
                ? 'en-GB'
                : 'fr-FR'

            document.getElementById(
              'total-amount'
            ).textContent = `${total.toLocaleString(locale, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })} €`

            document.getElementById(
              'deposit-amount'
            ).textContent = `${deposit.toLocaleString(locale, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })} €`

            document.getElementById(
              'remaining-amount'
            ).textContent = `${balance.toLocaleString(locale, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })} €`

            // Mettre à jour le texte du bouton avec le montant
            const t = window.translations[currentLang]['payer-solde']
            const buttonTextTemplate = t.payment.submit_button_with_amount
            const btnText = document.getElementById('submit-button-text')
            if (btnText) {
              btnText.textContent = buttonTextTemplate.replace(
                '{amount}',
                balance.toLocaleString(locale, {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                })
              )
            }
          }
        }
      }

      /**
       * Charge et affiche les données de la réservation
       * Gère les erreurs et met à jour l'interface utilisateur
       */
      async function load() {
        console.log('🚀 Début de la fonction load()')
        console.log('🔑 Token disponible:', !!token)
        console.log('🌍 Langue actuelle:', currentLang)
        console.log('📋 Traductions disponibles:', !!window.translations)

        if (!token) {
          console.log('❌ Pas de token, tentative de traduction')
          if (window.translations && window.translations[currentLang]) {
            const t = window.translations[currentLang]['payer-solde']
            detailsBox.textContent = t.errors.missing_token
            console.log("✅ Message d'erreur traduit appliqué")
          } else {
            detailsBox.textContent = 'Token manquant'
            console.log('❌ Traductions non disponibles, message par défaut')
          }
          btn.disabled = true
          return
        }
        try {
          console.log(
            '🔍 Tentative de récupération des données de réservation...'
          )
          console.log('🔑 Token utilisé:', token)
          console.log(
            "🌐 URL de l'API:",
            `/api/reservations?action=get&token=${encodeURIComponent(token)}`
          )

          const res = await fetch(
            `/api/reservations?action=get&token=${encodeURIComponent(token)}`
          )
          console.log("📡 Réponse de l'API reçue:", res.status, res.statusText)

          if (!res.ok) {
            console.error('❌ Erreur HTTP:', res.status, res.statusText)
            throw new Error(`Erreur HTTP: ${res.status}`)
          }

          const json = await res.json()
          console.log('📋 Données reçues:', json)

          if (json.status !== 'success') {
            console.error(
              "❌ Statut de l'API non réussi:",
              json.status,
              json.message
            )
            const t = window.translations[currentLang]['payer-solde']
            detailsBox.textContent =
              json.message || t.errors.reservation_not_found
            btn.disabled = true
            return
          }

          console.log('✅ Données de réservation récupérées avec succès')
          const d = json.data
          console.log('📊 Données brutes de la réservation:', d)

          const total = Number(d.priceTotal || 0)
          const deposit = Number(d.depositAmount || 0)
          const balance = Math.max(0, total - deposit)

          console.log('💰 Calculs financiers:')
          console.log('  - Total:', total)
          console.log('  - Acompte:', deposit)
          console.log('  - Solde:', balance)

          // Sauvegarder les données pour les traductions dynamiques
          window.reservationData = d
          console.log('💾 Données sauvegardées dans window.reservationData')

          // Utiliser la fonction de traduction pour le récapitulatif
          console.log('🔄 Mise à jour du récapitulatif...')
          detailsBox.innerHTML = translateRecapContent(d, currentLang)
          console.log('✅ Récapitulatif mis à jour')

          // S'assurer que la page est traduite dans la langue actuelle
          if (window.translations && window.translations[currentLang]) {
            translatePage(currentLang)
          }

          // ============================================================================
          // MISE À JOUR DE L'INTERFACE DE PAIEMENT
          // ============================================================================

          // Récap paiement avec formatage selon la langue
          const t = window.translations[currentLang]['payer-solde']
          const locale =
            currentLang === 'de'
              ? 'de-DE'
              : currentLang === 'en'
              ? 'en-GB'
              : 'fr-FR'

          document.getElementById(
            'total-amount'
          ).textContent = `${total.toLocaleString(locale, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })} €`
          document.getElementById(
            'deposit-amount'
          ).textContent = `${deposit.toLocaleString(locale, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })} €`
          document.getElementById(
            'remaining-amount'
          ).textContent = `${balance.toLocaleString(locale, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })} €`
          document.getElementById('deposit-percent').textContent =
            total > 0 ? `${Math.round((deposit / total) * 100)}%` : '0%'
          document.getElementById('progress-fill').style.width =
            total > 0 ? `${Math.min(100, (deposit / total) * 100)}%` : '0%'

          // Traduire le texte du bouton avec le montant
          const buttonTextTemplate = t.payment.submit_button_with_amount
          btnText.textContent = buttonTextTemplate.replace(
            '{amount}',
            balance.toLocaleString(locale, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })
          )

          // ============================================================================
          // GESTION DES VERROUILLAGES DE PAIEMENT
          // ============================================================================

          // Vérifier le statut et appliquer les verrouillages appropriés
          const st = String(d.status || '')
          const lock = document.getElementById('balance-lock')
          const lockText = document.getElementById('balance-lock-text')
          if (lock && lockText) {
            if (st === 'balancePay') {
              // Solde déjà payé : verrouiller le paiement
              lockText.textContent = t.locks.balance_paid
              lock.style.display = 'flex'
              btn.disabled = true
            } else if (st === 'canceled') {
              // Réservation annulée : verrouiller le paiement
              lockText.textContent = t.locks.reservation_canceled
              lock.style.display = 'flex'
              btn.disabled = true
            }
          }
        } catch (e) {
          console.error('💥 Erreur lors du chargement des données:', e)
          console.error('📋 Stack trace:', e.stack)

          // Gestion des erreurs de chargement avec traduction
          const t = window.translations[currentLang]['payer-solde']
          detailsBox.textContent = t.errors.loading_error
          console.log("⚠️ Message d'erreur affiché à l'utilisateur")
        }
      }

      // Fallback pour s'assurer que les traductions sont chargées
      setTimeout(() => {
        console.log('⏰ Fallback: vérification des traductions après 1 seconde')
        if (window.translations) {
          console.log('✅ Traductions disponibles dans le fallback')
          const detectedLang = window.detectLanguage
            ? window.detectLanguage()
            : 'fr'
          console.log('🌍 Langue détectée dans le fallback:', detectedLang)
          if (currentLang !== detectedLang) {
            currentLang = detectedLang
            translatePage(detectedLang)
          }
        } else {
          console.error(
            '❌ Traductions toujours non disponibles après 1 seconde'
          )
        }
      }, 1000)

      // Charger les données au démarrage
      load()

      // ============================================================================
      // GESTIONNAIRE D'ÉVÉNEMENTS DE PAIEMENT
      // ============================================================================

      /**
       * Gère le processus de paiement du solde
       * Crée l'intention de paiement et confirme le paiement via Stripe
       */
      btn.addEventListener('click', async () => {
        if (!token) return
        // Désactiver le bouton pendant le traitement
        btn.disabled = true
        const t = window.translations[currentLang]['payer-solde']

        // Étape 1 : Création de l'intention de paiement
        btnText.textContent = t.payment.creating_payment
        try {
          const piRes = await fetch('/api/createPayment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, type: 'balance' })
          })
          const piJson = await piRes.json()

          // Vérifier la réponse de l'API
          if (!piRes.ok || !piJson.clientSecret)
            throw new Error(piJson.error || t.errors.payment_creation_error)

          // Étape 2 : Confirmation du paiement via Stripe
          btnText.textContent = t.payment.confirming
          const { error, paymentIntent } = await stripe.confirmCardPayment(
            piJson.clientSecret,
            { payment_method: { card } }
          )

          // Vérifier les erreurs Stripe
          if (error) throw new Error(error.message)

          // Étape 3 : Paiement confirmé - redirection
          btnText.textContent = t.payment.confirmed
          setTimeout(() => {
            window.location.href = '/reservation-solde-confirme.html'
          }, 1200)
        } catch (e) {
          // Gestion des erreurs avec restauration de l'interface
          document.getElementById('card-errors').textContent = e.message
          btn.disabled = false
          btnText.textContent = t.payment.submit_button
        }
      })
    </script>
  </body>
</html>
