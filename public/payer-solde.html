<!DOCTYPE html>
<html>
  <head>
    <title>Payer le solde ‚Äì Calypso Bay</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <!-- Favicons -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="images/logos/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="images/logos/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="images/logos/favicons/favicon-16x16.png"
    />
    <link rel="manifest" href="manifest.json" />
    <link rel="shortcut icon" href="images/logos/favicons/favicon.ico" />

    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/custom.css" />
    <noscript
      ><link rel="stylesheet" href="assets/css/noscript.css"
    /></noscript>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      .form-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .reservation-details {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
        color: white;
      }
      .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.25);
        font-size: 0.95rem;
      }
      .detail-item:last-child {
        border-bottom: none;
        margin-top: 10px;
        padding-top: 10px;
      }
      .payment-card {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
        color: white;
        position: relative;
      }
      .payment-lock {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(3px);
        background: rgba(17, 24, 39, 0.35);
        z-index: 5;
      }
      .payment-lock .lock-box {
        background: rgba(255, 255, 255, 0.95);
        color: #111827;
        padding: 14px 18px;
        border-radius: 12px;
        font-weight: 700;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      }
      .payment-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
      }
      .payment-row.deposit {
        color: #3b82f6;
        font-weight: 600;
      }
      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 4px;
        overflow: hidden;
        margin: 8px 0 12px;
      }
      .progress-fill {
        height: 100%;
        width: 0%;
        background: #3b82f6;
        transition: width 0.3s ease;
      }
      .btn-submit {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        padding: 14px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 50px;
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
      }
      .btn-submit:disabled {
        background: #9ca3af;
      }
      #card-errors {
        color: #ef4444;
        margin-top: 10px;
        font-size: 0.9rem;
      }
      .payment-disclaimer {
        text-align: center;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.85rem;
        margin-top: 10px;
      }
    </style>
  </head>
  <body class="is-preload">
    <div id="page-wrapper">
      <div id="wrapper">
        <section class="panel banner right">
          <div class="content color0 span-3-75">
            <h2 class="major">
              Payer le<br /><span class="themysion">Solde</span>
            </h2>
            <p>
              Pour finaliser votre r√©servation, veuillez r√©gler le solde
              restant.
            </p>
            <ul class="actions">
              <li>
                <a
                  href="#form"
                  class="button primary color1 circle icon solid fa-angle-right"
                  >Continuer</a
                >
              </li>
            </ul>
          </div>
          <div class="image filtered span-1-75" data-position="25% 25%">
            <img src="images/pic01.jpg" alt="" />
          </div>
        </section>

        <!-- D√©tails de la r√©servation (section s√©par√©e) -->
        <section class="panel spotlight medium right color1" id="details">
          <div class="intro joined span-3-5">
            <h2 class="major">üìÖ D√©tails de la r√©servation</h2>
            <p>
              V√©rifiez les informations de votre s√©jour avant de proc√©der au
              paiement du solde.
            </p>
          </div>
          <div class="inner">
            <div class="form-section">
              <div class="reservation-details" id="reservation-details">
                Chargement en cours‚Ä¶
              </div>
            </div>
          </div>
          <div class="image filtered tinted" data-position="center">
            <img src="images/pic02.jpg" alt="" />
          </div>
        </section>

        <!-- Paiement du solde (section d√©di√©e) -->
        <section class="panel color4-alt" id="form">
          <div class="intro color4">
            <h2 class="major">üí≥ Paiement du solde</h2>
            <p>
              Renseignez votre carte pour r√©gler le solde restant de votre
              r√©servation.
            </p>
          </div>
          <div class="inner">
            <div class="payment-card">
              <div class="payment-lock" id="balance-lock">
                <div class="lock-box" id="balance-lock-text"></div>
              </div>
              <h4 style="margin: 0 0 10px 0">R√©capitulatif du paiement</h4>
              <div class="payment-row">
                <span>Total</span><span id="total-amount">‚Äî</span>
              </div>
              <div class="payment-row deposit">
                <span
                  >Acompte d√©j√† vers√© (<span id="deposit-percent">0%</span
                  >)</span
                ><span id="deposit-amount">‚Äî</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <div
                class="payment-row"
                style="
                  border-top: 1px solid rgba(255, 255, 255, 0.25);
                  padding-top: 12px;
                  margin-top: 4px;
                "
              >
                <span>Solde restant</span><span id="remaining-amount">‚Äî</span>
              </div>

              <div style="margin-top: 16px">
                <label for="card-element" style="color: white; font-weight: 600"
                  >Carte de paiement</label
                >
                <div
                  id="card-element"
                  style="
                    background: rgba(255, 255, 255, 0.9);
                    border-radius: 10px;
                    padding: 12px;
                  "
                ></div>
                <div id="card-errors" role="alert"></div>
              </div>
              <button id="pay-btn" class="btn-submit" style="margin-top: 16px">
                <span id="btn-text">Payer le solde</span>
              </button>
              <p class="payment-disclaimer">
                Paiement s√©curis√© via Stripe. Aucune donn√©e bancaire n'est
                stock√©e par Calypso Bay.
              </p>
            </div>
          </div>
        </section>

        <div class="copyright">
          <span>&copy; Calypso Bay | By</span>
          <a
            href="https://moriarty-design.fr"
            target="_blank"
            rel="noopener"
            style="
              font-family: 'Engagement', 'Brush Script MT', cursive;
              font-size: 2.2em;
              line-height: 1;
              margin-left: 0.25em;
              text-decoration: none;
              color: inherit;
            "
            >Moriarty</a
          >.
        </div>
      </div>
    </div>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script>
      const stripe = Stripe(
        '%STRIPE_PUBLIC_KEY%'.replace(
          '%STRIPE_PUBLIC_KEY%',
          'pk_live_51RuYagJuxMM0V1wvWkNbfWITDKf6J6Q8BaoCPCwWrd6juAMlGekc3RADsm9VfcFcfkk7dYmY8dgDr0DqHOBw3qtb006Bbqn4e4'
        )
      )
      const elements = stripe.elements()
      const card = elements.create('card', {
        style: { base: { fontSize: '16px' } }
      })
      card.mount('#card-element')
      card.addEventListener('change', function (event) {
        const displayError = document.getElementById('card-errors')
        displayError.textContent = event.error ? event.error.message : ''
      })

      const params = new URLSearchParams(window.location.search)
      const token = params.get('token')
      const detailsBox = document.getElementById('reservation-details')
      const btn = document.getElementById('pay-btn')
      const btnText = document.getElementById('btn-text')

      async function load() {
        if (!token) {
          detailsBox.textContent = 'Token manquant'
          btn.disabled = true
          return
        }
        try {
          const res = await fetch(
            `/api/reservations?action=get&token=${encodeURIComponent(token)}`
          )
          const json = await res.json()
          if (json.status !== 'success') {
            detailsBox.textContent = json.message || 'R√©servation introuvable'
            btn.disabled = true
            return
          }
          const d = json.data
          const total = Number(d.priceTotal || 0)
          const deposit = Number(d.depositAmount || 0)
          const balance = Math.max(0, total - deposit)
          // D√©tails format√©s comme demand√©
          const formatMoney = (v) =>
            Number(v || 0).toLocaleString('fr-FR', {
              minimumFractionDigits: 1,
              maximumFractionDigits: 1
            })
          const formatMoney2 = (v) =>
            Number(v || 0).toLocaleString('fr-FR', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })
          const ages =
            Array.isArray(d.childrenAges) && d.childrenAges.length
              ? d.childrenAges.join(', ')
              : ''
          const dates = new Date(d.startDate)
          const datee = new Date(d.endDate)
          const fmt = (dt) =>
            dt.toLocaleDateString('fr-FR', {
              day: '2-digit',
              month: 'long',
              year: 'numeric'
            })
          const lines = []
          lines.push(
            `<div class="detail-item"><strong>Dates :</strong> <span>${fmt(
              dates
            )} au ${fmt(datee)} (${d.nbNights} nuits)</span></div>`
          )
          lines.push(
            `<div class="detail-item"><strong>Voyageurs :</strong> <span>${
              d.nbAdults
            } adulte${d.nbAdults > 1 ? 's' : ''}${
              d.nbChilds > 0
                ? ', ' + d.nbChilds + ' enfant' + (d.nbChilds > 1 ? 's' : '')
                : ''
            }</span></div>`
          )
          if (d.nbChilds > 0 && ages) {
            lines.push(
              `<div class="detail-item"><strong>√Çges des enfants :</strong> <span>${ages}</span></div>`
            )
          }
          lines.push(
            '<div class="detail-item" style="border-bottom:none; display:block; padding-bottom:0;">\
            <div><strong>D√©tail du prix :</strong></div>\
            <div style="padding-top:8px">‚Ä¢ Total des nuits (' +
              d.nbNights +
              `) : ${formatMoney(d.priceNights)} ‚Ç¨</div>\
            <div>‚Ä¢ Frais de m√©nage : ${formatMoney(d.priceClean)} ‚Ç¨</div>\
            <div>‚Ä¢ Taxes (${d.nbAdults} adulte${
                d.nbAdults > 1 ? 's' : ''
              }) : ${formatMoney(d.priceTax)} ‚Ç¨</div>\
            <div>‚Ä¢ <strong>Total : ${formatMoney(
              d.priceTotal
            )} ‚Ç¨</strong></div>\
          </div>`
          )
          lines.push(
            '<div class="detail-item" style="border-bottom:none; display:block; padding-bottom:0;">\
            <div><strong>Adresse de facturation :</strong></div>\
            <div style="padding-top:8px">' +
              (d.address || '') +
              '</div>\
            <div>' +
              (d.postal || '') +
              ' ' +
              (d.city || '') +
              '</div>\
            <div>' +
              (d.country || '') +
              '</div>\
          </div>'
          )
          detailsBox.innerHTML = lines.join('')

          // R√©cap paiement
          document.getElementById('total-amount').textContent = `${formatMoney2(
            total
          )} ‚Ç¨`
          document.getElementById(
            'deposit-amount'
          ).textContent = `${formatMoney2(deposit)} ‚Ç¨`
          document.getElementById(
            'remaining-amount'
          ).textContent = `${formatMoney2(balance)} ‚Ç¨`
          document.getElementById('deposit-percent').textContent =
            total > 0 ? `${Math.round((deposit / total) * 100)}%` : '0%'
          document.getElementById('progress-fill').style.width =
            total > 0 ? `${Math.min(100, (deposit / total) * 100)}%` : '0%'
          btnText.textContent = `Payer le solde ‚Äì ${balance.toLocaleString(
            'fr-FR',
            { minimumFractionDigits: 2, maximumFractionDigits: 2 }
          )} ‚Ç¨`

          // Verrouillage selon statut
          const st = String(d.status || '')
          const lock = document.getElementById('balance-lock')
          const lockText = document.getElementById('balance-lock-text')
          if (lock && lockText) {
            if (st === 'balancePay') {
              lockText.textContent = 'Solde d√©j√† r√©gl√©'
              lock.style.display = 'flex'
              btn.disabled = true
            } else if (st === 'canceled') {
              lockText.textContent = 'R√©servation annul√©e'
              lock.style.display = 'flex'
              btn.disabled = true
            }
          }
        } catch (e) {
          detailsBox.textContent = 'Erreur de chargement'
        }
      }

      load()

      btn.addEventListener('click', async () => {
        if (!token) return
        btn.disabled = true
        btnText.textContent = 'Cr√©ation du paiement‚Ä¶'
        try {
          const piRes = await fetch('/api/createPayment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, type: 'balance' })
          })
          const piJson = await piRes.json()
          if (!piRes.ok || !piJson.clientSecret)
            throw new Error(piJson.error || 'Erreur cr√©ation paiement')
          btnText.textContent = 'Confirmation‚Ä¶'
          const { error, paymentIntent } = await stripe.confirmCardPayment(
            piJson.clientSecret,
            { payment_method: { card } }
          )
          if (error) throw new Error(error.message)
          btnText.textContent = 'Paiement confirm√© ‚úî'
          setTimeout(() => {
            window.location.href = '/reservation-solde-confirme.html'
          }, 1200)
        } catch (e) {
          document.getElementById('card-errors').textContent = e.message
          btn.disabled = false
          btnText.textContent = 'Payer le solde'
        }
      })
    </script>
  </body>
</html>
