<!DOCTYPE html>
<html>
  <head>
    <title>Test Finaliser Reservation - Traductions</title>
    <meta charset="utf-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      .success {
        background: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background: #f8d7da;
        border-color: #f5c6cb;
      }
      .warning {
        background: #fff3cd;
        border-color: #ffeaa7;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .btn-fr {
        background: #007bff;
        color: white;
      }
      .btn-en {
        background: #28a745;
        color: white;
      }
      .btn-de {
        background: #6f42c1;
        color: white;
      }
      .current-lang {
        font-weight: bold;
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <h1>🧪 Test des Traductions - Finaliser Reservation</h1>

    <div class="test-section">
      <h2>🌍 Test du Sélecteur de Langue</h2>
      <p>
        Langue actuelle :
        <span id="current-lang" class="current-lang">Chargement...</span>
      </p>
      <button class="btn-fr" onclick="testLanguage('fr')">🇫🇷 Français</button>
      <button class="btn-en" onclick="testLanguage('en')">🇬🇧 English</button>
      <button class="btn-de" onclick="testLanguage('de')">🇩🇪 Deutsch</button>
    </div>

    <div class="test-section">
      <h2>📋 Test des Traductions Statiques</h2>
      <div id="static-tests"></div>
    </div>

    <div class="test-section">
      <h2>🔗 Test de l'URL</h2>
      <p>URL actuelle : <code id="current-url"></code></p>
      <p>Paramètre lang : <code id="lang-param"></code></p>
    </div>

    <div class="test-section">
      <h2>📝 Test des Traductions Dynamiques</h2>
      <div id="dynamic-tests"></div>
    </div>

    <div class="test-section">
      <h2>✅ Résumé des Tests</h2>
      <div id="test-summary"></div>
    </div>

    <script src="assets/js/translations.js"></script>
    <script>
      let testResults = {
        languageSelector: false,
        urlUpdate: false,
        staticTranslations: false,
        dynamicTranslations: false,
        localStorage: false
      }

      // Initialiser les traductions
      window.addEventListener('translations:ready', function (event) {
        const detectedLang = event.detail.language
        console.log('🌍 Traductions prêtes, langue détectée:', detectedLang)
        updateCurrentLang(detectedLang)
        runStaticTests(detectedLang)
        runDynamicTests(detectedLang)
        updateURLInfo()
        updateTestSummary()
      })

      function testLanguage(lang) {
        console.log(`🔄 Test du changement vers ${lang}`)

        // Sauvegarder la préférence
        localStorage.setItem('calypso-bay-lang', lang)
        testResults.localStorage = true

        // Simuler le changement d'URL
        const url = new URL(window.location)
        url.searchParams.set('lang', lang)
        window.history.replaceState({}, '', url)

        // Mettre à jour l'affichage
        updateCurrentLang(lang)
        updateURLInfo()
        runStaticTests(lang)
        runDynamicTests(lang)
        updateTestSummary()

        console.log(`✅ Langue changée vers ${lang}`)
      }

      function updateCurrentLang(lang) {
        document.getElementById('current-lang').textContent = lang.toUpperCase()
      }

      function updateURLInfo() {
        const url = window.location.href
        const urlParams = new URLSearchParams(window.location.search)
        const langParam = urlParams.get('lang') || 'aucun'

        document.getElementById('current-url').textContent = url
        document.getElementById('lang-param').textContent = langParam

        testResults.urlUpdate = true
      }

      function runStaticTests(lang) {
        const t = window.translations[lang]['finaliser-reservation']
        const common = window.translations[lang].common

        let html = '<h3>Traductions statiques :</h3>'

        // Test des traductions de base
        const tests = [
          { key: 'banner.title', value: t.banner.title, expected: 'non vide' },
          { key: 'form.title', value: t.form.title, expected: 'non vide' },
          {
            key: 'payment.title',
            value: t.payment.title,
            expected: 'non vide'
          },
          { key: 'common.dates', value: common.dates, expected: 'non vide' }
        ]

        tests.forEach((test) => {
          const status = test.value && test.value.length > 0 ? '✅' : '❌'
          html += `<p>${status} ${test.key}: <strong>${
            test.value || 'MANQUANT'
          }</strong></p>`
        })

        document.getElementById('static-tests').innerHTML = html
        testResults.staticTranslations = true
      }

      function runDynamicTests(lang) {
        const t = window.translations[lang]['finaliser-reservation']
        const common = window.translations[lang].common

        let html = '<h3>Traductions dynamiques :</h3>'

        // Test des traductions avec placeholders
        const tests = [
          {
            key: 'payment.description',
            value: t.payment.description,
            expected: 'contient {percent}'
          },
          {
            key: 'payment.submit_button_with_amount',
            value: t.payment.submit_button_with_amount,
            expected: 'contient {amount}'
          },
          {
            key: 'common.nights_total',
            value: common.nights_total,
            expected: 'contient {count}'
          }
        ]

        tests.forEach((test) => {
          const hasPlaceholder = test.value && test.value.includes('{')
          const status = hasPlaceholder ? '✅' : '❌'
          html += `<p>${status} ${test.key}: <strong>${
            test.value || 'MANQUANT'
          }</strong></p>`
        })

        // Test des messages d'erreur et de succès
        const messageTests = [
          { key: 'errors.missing_token', value: t.errors.missing_token },
          { key: 'success.message', value: t.success.message },
          { key: 'locks.deposit_paid', value: t.locks.deposit_paid }
        ]

        html += '<h4>Messages système :</h4>'
        messageTests.forEach((test) => {
          const status = test.value && test.value.length > 0 ? '✅' : '❌'
          html += `<p>${status} ${test.key}: <strong>${
            test.value || 'MANQUANT'
          }</strong></p>`
        })

        document.getElementById('dynamic-tests').innerHTML = html
        testResults.dynamicTranslations = true
      }

      function updateTestSummary() {
        const totalTests = Object.keys(testResults).length
        const passedTests = Object.values(testResults).filter(Boolean).length
        const percentage = Math.round((passedTests / totalTests) * 100)

        let html = `<h3>Résultats des Tests (${passedTests}/${totalTests} - ${percentage}%)</h3>`

        Object.entries(testResults).forEach(([test, result]) => {
          const status = result ? '✅' : '❌'
          const testName = test
            .replace(/([A-Z])/g, ' $1')
            .replace(/^./, (str) => str.toUpperCase())
          html += `<p>${status} ${testName}</p>`
        })

        if (percentage === 100) {
          html +=
            '<p style="color: #28a745; font-weight: bold;">🎉 Tous les tests sont passés avec succès !</p>'
        } else {
          html +=
            '<p style="color: #dc3545; font-weight: bold;">⚠️ Certains tests ont échoué.</p>'
        }

        document.getElementById('test-summary').innerHTML = html
      }

      // Initialiser au chargement
      document.addEventListener('DOMContentLoaded', function () {
        updateURLInfo()
        console.log('🚀 Page de test chargée')
      })
    </script>
  </body>
</html>
